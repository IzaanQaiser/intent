import{j as t,r as n,c as ne,R as ae}from"./client-DMp2t5-j.js";import{s as d}from"./supabaseClient-DihBYOwf.js";const Y=40,re=5,J=10,Q=10;function se({isVisible:o,isLoading:l,metrics:u,quote:R,isAuthenticated:f,authError:P,authInProgress:C,onLogin:M,onReadFirst:S,onWatchNow:q}){if(!o)return null;if(f&&!u)return t.jsx("div",{className:"intent-overlay",children:t.jsxs("div",{className:"intent-overlay__panel",children:[t.jsx("div",{className:"intent-overlay__title",children:"Read First"}),t.jsx("div",{className:"intent-overlay__subtitle",children:R}),t.jsx("div",{className:"intent-overlay__loading",children:"Syncing your watch balance…"})]})});const h=u??{readScore:0,watchBalanceMinutes:0},[B,y]=n.useState(0),[c,O]=n.useState(0),[W,D]=n.useState({left:0,width:0}),N=n.useRef(null),p=n.useRef(null),b=n.useRef(!1),m=n.useRef(null),_=n.useRef(0),A=n.useRef(null),v=n.useRef(null),V=5e3,F=120,H=140,e=n.useCallback(()=>{p.current!==null&&(cancelAnimationFrame(p.current),p.current=null),m.current!==null&&(cancelAnimationFrame(m.current),m.current=null),N.current=null,b.current=!1;const g=_.current;if(g<=0){y(0);return}const k=performance.now(),L=E=>{const x=E-k,I=Math.min(x/H,1),z=g*(1-I);if(y(z),I>=1){m.current=null;return}m.current=requestAnimationFrame(L)};m.current=requestAnimationFrame(L)},[]),r=n.useCallback(()=>{const g=performance.now();N.current=g,b.current=!1,m.current!==null&&(cancelAnimationFrame(m.current),m.current=null),y(0);const k=L=>{if(N.current===null)return;const E=L-N.current;let x=0;if(E<=F)x=E/F*.1;else{const I=E-F,z=V-F;x=.1+Math.min(I/z,1)*.9}if(y(x),x>=1&&!b.current){b.current=!0,q(),e();return}p.current=requestAnimationFrame(k)};p.current=requestAnimationFrame(k)},[q,e]);n.useEffect(()=>{_.current=B},[B]),n.useEffect(()=>{o||e()},[o,e]),n.useLayoutEffect(()=>{if(!f)return;const g=()=>{const L=A.current,E=v.current;if(!L||!E)return;const x=L.getBoundingClientRect(),I=E.getBoundingClientRect();O(x.width),D({left:Math.max(0,I.left-x.left),width:I.width})};g();const k=new ResizeObserver(g);return A.current&&k.observe(A.current),v.current&&k.observe(v.current),window.addEventListener("resize",g),()=>{k.disconnect(),window.removeEventListener("resize",g)}},[f]);const a=Math.floor(h.readScore/400)+1,i=Math.floor((h.readScore+Y)/400)+1,s=h.watchBalanceMinutes-J,w=s<0?h.readScore-Q:h.readScore,T=Math.floor(w/400)+1,$=i>a?"↑":"=",G=s>=0?`${s} min`:`-${Math.abs(s)} min`,U=c*B,j=Math.max(0,Math.min(W.width,U-W.left)),te=Math.max(0,j);return t.jsx("div",{className:"intent-overlay",children:t.jsxs("div",{className:"intent-overlay__panel",children:[t.jsx("div",{className:"intent-overlay__title",children:"Read First"}),t.jsx("div",{className:"intent-overlay__subtitle",children:R}),f?t.jsxs("div",{className:"intent-overlay__metrics",children:[t.jsxs("div",{className:"intent-overlay__metric",children:[t.jsx("span",{className:"intent-overlay__metric-label",children:"Level"}),t.jsx("span",{className:"intent-overlay__metric-value",children:a})]}),t.jsxs("div",{className:"intent-overlay__metric",children:[t.jsx("span",{className:"intent-overlay__metric-label",children:"Read Score"}),t.jsx("span",{className:"intent-overlay__metric-value",children:u.readScore})]}),t.jsxs("div",{className:"intent-overlay__metric",children:[t.jsx("span",{className:"intent-overlay__metric-label",children:"Watch Balance"}),t.jsxs("span",{className:"intent-overlay__metric-value",children:[h.watchBalanceMinutes," min"]})]})]}):t.jsxs("div",{className:"intent-overlay__auth",children:[t.jsx("div",{className:"intent-overlay__auth-title",children:"Sign in to continue"}),t.jsx("div",{className:"intent-overlay__auth-copy",children:"Your score and balance sync to your account. Sign in to proceed."}),t.jsx("button",{className:"intent-overlay__auth-button",type:"button",onClick:M,disabled:C,children:C?"Authenticating…":"Sign in with Google"})]}),f?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"intent-overlay__choice",children:[t.jsx("div",{className:"intent-overlay__choice-title",children:"Your Choice"}),t.jsxs("div",{className:"intent-overlay__choice-grid",children:[t.jsxs("div",{className:"intent-overlay__choice-card",children:[t.jsx("div",{className:"intent-overlay__choice-header",children:"Read Instead"}),t.jsxs("div",{className:"intent-overlay__choice-chips",children:[t.jsxs("span",{className:"intent-overlay__chip",children:["Score +",Y]}),t.jsxs("span",{className:"intent-overlay__chip",children:["Watch Balance +",re,"m"]}),t.jsxs("span",{className:"intent-overlay__chip",children:["Level ",i," ",$]})]}),t.jsx("div",{className:"intent-overlay__choice-note",children:"Reading restores progress."})]}),t.jsxs("div",{className:"intent-overlay__choice-card intent-overlay__choice-card--watch",children:[t.jsx("div",{className:"intent-overlay__choice-header",children:"Watch Now"}),t.jsxs("div",{className:"intent-overlay__choice-chips",children:[t.jsxs("span",{className:"intent-overlay__chip intent-overlay__chip--warn",children:["Watch Balance -",J,"m"]}),t.jsxs("span",{className:"intent-overlay__chip intent-overlay__chip--highlight",children:["New Watch Balance ",G]})]}),s<0?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"intent-overlay__choice-subline",children:["Score penalty -",Q," (attention debt)"]}),t.jsx("div",{className:"intent-overlay__choice-subline",children:"Level progress paused while negative"}),T<a?t.jsxs("div",{className:"intent-overlay__choice-warning",children:["⚠️ Risk: Level down to ",T]}):null]}):t.jsx("div",{className:"intent-overlay__choice-subline",children:"No score penalty (balance stays non-negative)"})]})]})]}),t.jsxs("div",{className:"intent-overlay__actions",children:[t.jsx("button",{className:"intent-overlay__primary",type:"button",onClick:S,disabled:l,children:l?"Generating summary…":"Read Instead"}),t.jsxs("button",{className:"intent-overlay__secondary",type:"button",onPointerDown:r,onPointerUp:e,onPointerLeave:e,onPointerCancel:e,ref:A,children:[t.jsx("span",{className:"intent-overlay__hold-fill",style:{transform:`scaleX(${B})`}}),t.jsxs("span",{className:"intent-overlay__button-label intent-overlay__button-label--progress",children:[t.jsx("span",{ref:v,className:"intent-overlay__button-label-base",children:"Watch Now"}),t.jsx("span",{className:"intent-overlay__button-label-fill",style:{"--label-fill-px":`${te}px`},children:"Watch Now"})]})]})]}),l?t.jsx("div",{className:"intent-overlay__loading",children:"Preparing a focused summary and key points…"}):null]}):null]})})}const X="intent-read-first-root",K="http://127.0.0.1:8787",oe=40,ie=5,ce=10,le=10,Z=o=>Math.floor(o/400)+1;function ee(o){try{const l=new URL(o);return l.pathname!=="/watch"?null:l.searchParams.get("v")}catch{return null}}function ue(){var u;const o=document.querySelector("video");if(o&&!o.paused&&o.pause(),o){o.autoplay=!1;return}const l=document.querySelector(".ytp-play-button");l&&((u=l.getAttribute("aria-label"))!=null&&u.toLowerCase().includes("pause"))&&l.click()}function de(){const[o,l]=n.useState(()=>ee(window.location.href));return n.useEffect(()=>{const u=()=>l(ee(window.location.href)),R=history.pushState,f=history.replaceState;history.pushState=function(...M){R.apply(this,M),u()},history.replaceState=function(...M){f.apply(this,M),u()},window.addEventListener("popstate",u);const P=new MutationObserver(u);P.observe(document.body,{childList:!0,subtree:!0});const C=window.setInterval(u,1e3);return()=>{history.pushState=R,history.replaceState=f,window.removeEventListener("popstate",u),P.disconnect(),window.clearInterval(C)}},[]),o}function he(){const o=de(),[l,u]=n.useState(!0),[R,f]=n.useState(!1),[P,C]=n.useState(0),[M,S]=n.useState(null),[q,h]=n.useState(!1),[B,y]=n.useState(null),[c,O]=n.useState(null),W=n.useRef(o),D=n.useRef(async()=>!1),N=n.useMemo(()=>["It is not enough to be busy; so are the ants. The question is: What are we busy about? — Henry David Thoreau","The successful warrior is the average man, with laser-like focus. — Bruce Lee","Concentrate all your thoughts upon the work in hand. — Alexander Graham Bell","Simplicity is the ultimate sophistication. — Leonardo da Vinci","A well-spent day brings happy sleep. — Leonardo da Vinci","Your focus determines your reality. — George Lucas"],[]),p=n.useCallback(async(e,r)=>new Promise(a=>{var i;if(!((i=chrome==null?void 0:chrome.runtime)!=null&&i.sendMessage)){a({ok:!1,error:"Extension runtime unavailable."});return}try{chrome.runtime.sendMessage({type:"api_request",url:e,init:r},s=>{if(chrome.runtime.lastError){a({ok:!1,error:chrome.runtime.lastError.message});return}a(s)})}catch(s){a({ok:!1,error:s instanceof Error?s.message:String(s)})}}),[]),b=n.useCallback(async()=>{var w;if(!d)return{ok:!1,error:"Supabase client not configured."};const e=(w=c==null?void 0:c.user)==null?void 0:w.id;if(!e)return{ok:!1,error:"Supabase session unavailable."};const{data:r,error:a}=await d.from("user_state").select("user_id, read_score, watch_balance_minutes").eq("user_id",e).maybeSingle();if(a)return{ok:!1,error:a.message};if(r)return{ok:!0,data:r};const{data:i,error:s}=await d.from("user_state").insert({user_id:e,read_score:0,watch_balance_minutes:0}).select("user_id, read_score, watch_balance_minutes").single();return s||!i?{ok:!1,error:(s==null?void 0:s.message)||"Failed to create watch balance state."}:{ok:!0,data:i}},[c,d]),m=n.useCallback(async()=>{const e=await b();if(!e.ok)return{ok:!1,error:e.error};const r=e.data;return{ok:!0,data:{level:Z(r.read_score),readScore:r.read_score,watchBalanceMinutes:r.watch_balance_minutes}}},[b]);n.useEffect(()=>{o&&o!==W.current&&(W.current=o,u(!0),f(!1))},[o]);const _=n.useCallback(async()=>{if(!c)return!1;const e=await m();if(e.ok&&e.data)return y(e.data),!0;const r=await p(`${K}/state`,{headers:{Authorization:`Bearer ${c.access_token}`}});if(!r.ok||!r.body)return!1;const a=r.body;return y({level:a.level,readScore:a.readScore,watchBalanceMinutes:a.watchBalanceMinutes}),!0},[c,m,p]);n.useEffect(()=>{D.current=_},[_]);const A=n.useCallback(async(e,r)=>{var U;if(!d)return{ok:!1,error:"Supabase client not configured."};const a=(U=c==null?void 0:c.user)==null?void 0:U.id;if(!a)return{ok:!1,error:"Supabase session unavailable."};let i=0,s=0;switch(e){case"read_completed":i+=oe,s+=ie;break;case"watch_initiated":{const j=typeof(r==null?void 0:r.minutes)=="number"?r.minutes:ce;s-=j;break}case"session_end":{const j=await b();if(!j.ok||!j.data)return{ok:!1,error:j.error||"Unable to load state."};j.data.watch_balance_minutes<0&&(i-=le);break}default:return{ok:!0,data:null}}const w=await b();if(!w.ok||!w.data)return{ok:!1,error:w.error||"Unable to load state."};const T=w.data.read_score+i,$=w.data.watch_balance_minutes+s,{error:G}=await d.from("user_state").update({read_score:T,watch_balance_minutes:$,updated_at:new Date().toISOString()}).eq("user_id",a);return G?{ok:!1,error:G.message}:{ok:!0,data:{level:Z(T),readScore:T,watchBalanceMinutes:$}}},[c,b,d]),v=n.useCallback(async(e,r)=>{if(!c)return null;const a=await A(e,r);if(a.ok)return a.data??null;const i=await p(`${K}/event`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c.access_token}`},body:JSON.stringify({type:e,data:r})});return i.ok?i.body??null:null},[c,A,p]);n.useEffect(()=>{if(!d)return;d.auth.getSession().then(({data:a})=>O(a.session));const{data:e}=d.auth.onAuthStateChange((a,i)=>{O(i),i&&h(!1)}),r=a=>{(a==null?void 0:a.type)==="auth_complete"&&(d.auth.getSession().then(({data:i})=>{O(i.session),i.session&&D.current()}),h(!1)),(a==null?void 0:a.type)==="auth_signed_out"&&(O(null),h(!1),u(!0),f(!1))};return chrome.runtime.onMessage.addListener(r),()=>{e.subscription.unsubscribe(),chrome.runtime.onMessage.removeListener(r)}},[d]),n.useEffect(()=>{c||y(null)},[c]),n.useEffect(()=>{S(d?null:"Missing Supabase configuration.")},[]),n.useEffect(()=>{if(!o||!c)return;let e=0,r=null,a=!1;const i=async()=>{e+=1,!await _()&&!a&&e<3&&(r=window.setTimeout(i,1e3))};return i(),v("video_opened",{videoId:o}),()=>{a=!0,r!==null&&window.clearTimeout(r)}},[o,c,_,v]),n.useEffect(()=>{l&&C(e=>(e+1)%N.length)},[l,N.length]),n.useEffect(()=>{if(!l)return;let e=null;const r=()=>{e==null||e.pause()},a=()=>{const s=document.querySelector("video");if(!s){ue();return}e&&e!==s&&(e.removeEventListener("play",r),e.removeEventListener("playing",r)),e=s,e.autoplay=!1,e.addEventListener("play",r),e.addEventListener("playing",r),e.pause()};a();const i=new MutationObserver(a);return i.observe(document.body,{childList:!0,subtree:!0}),()=>{i.disconnect(),e&&(e.removeEventListener("play",r),e.removeEventListener("playing",r))}},[l,o]);const V=n.useCallback(async()=>{if(!c)return;u(!1),f(!1);const e=await v("watch_initiated",{minutes:10,videoId:o});e?y({level:e.level,readScore:e.readScore,watchBalanceMinutes:e.watchBalanceMinutes}):await _()},[v,o,c,_]),F=n.useCallback(async()=>{if(!c)return;f(!0);const e=await v("read_completed",{videoId:o});e?y({level:e.level,readScore:e.readScore,watchBalanceMinutes:e.watchBalanceMinutes}):await _()},[v,o,c,_]),H=n.useCallback(async()=>{var i;if(!d){S("Missing Supabase configuration.");return}h(!0);const e=(i=chrome.runtime)==null?void 0:i.getURL("auth.html"),{data:r,error:a}=await d.auth.signInWithOAuth({provider:"google",options:e?{redirectTo:e,skipBrowserRedirect:!0}:{skipBrowserRedirect:!0}});if(a||!(r!=null&&r.url)){S((a==null?void 0:a.message)||"Failed to start sign-in."),h(!1);return}try{chrome.runtime.sendMessage({type:"oauth_start",url:r.url},s=>{if(chrome.runtime.lastError){S(chrome.runtime.lastError.message),h(!1);return}s!=null&&s.ok||(S((s==null?void 0:s.error)||"OAuth failed."),h(!1))})}catch(s){S(s instanceof Error?s.message:"Extension runtime unavailable."),h(!1)}},[d]);return o?t.jsx(se,{isVisible:l,isLoading:R,isAuthenticated:!!c,authError:M,authInProgress:q,metrics:B,quote:N[P],onLogin:H,onReadFirst:F,onWatchNow:V}):null}function fe(){if(document.getElementById(X))return;const o=document.createElement("div");o.id=X,document.body.appendChild(o),ne(o).render(t.jsx(ae.StrictMode,{children:t.jsx(he,{})}))}fe();
