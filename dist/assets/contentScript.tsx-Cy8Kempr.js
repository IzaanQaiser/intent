import{j as a,r as n,c as Ae,R as Be}from"./client-DMp2t5-j.js";import{s as S}from"./supabaseClient-DihBYOwf.js";const Ee=10;function Pe({isVisible:r,isLoading:c,metrics:u,watchCostMinutes:v,readGainMinutes:y,readScoreGain:M,watchScorePenalty:I,summary:p,isClaimingRewards:T,hasClaimedRewards:pe,claimSecondsRemaining:C,claimCountdownLabel:ce,quote:H,isAuthenticated:b,authError:le,authInProgress:ae,onLogin:X,onReadFirst:G,onWatchNow:K,onClaimRewards:se}){var q;if(!r)return null;if(b&&!u)return a.jsx("div",{className:"intent-overlay",children:a.jsxs("div",{className:"intent-overlay__panel",children:[a.jsx("div",{className:"intent-overlay__title",children:"Read First"}),a.jsx("div",{className:"intent-overlay__subtitle",children:H}),a.jsx("div",{className:"intent-overlay__loading",children:"Syncing your watch balance…"})]})});const R=u??{readScore:0,watchBalanceMinutes:0},[i,P]=n.useState(0),[D,be]=n.useState(0),[ie,ue]=n.useState({left:0,width:0}),[O,de]=n.useState(!1),Z=n.useRef(null),A=n.useRef(null),Y=n.useRef(!1),w=n.useRef(null),z=n.useRef(0),m=n.useRef(null),$=n.useRef(null),E=n.useRef(null),we=5e3,f=120,ee=140,me=2e3,j=n.useCallback(()=>{A.current!==null&&(cancelAnimationFrame(A.current),A.current=null),w.current!==null&&(cancelAnimationFrame(w.current),w.current=null),Z.current=null,Y.current=!1;const d=z.current;if(d<=0){P(0);return}const _=performance.now(),U=Q=>{const V=Q-_,re=Math.min(V/ee,1),Me=d*(1-re);if(P(Me),re>=1){w.current=null;return}w.current=requestAnimationFrame(U)};w.current=requestAnimationFrame(U)},[]),B=n.useCallback(()=>{m.current!==null&&(window.clearTimeout(m.current),m.current=null),de(!1)},[]),te=n.useCallback(()=>{m.current!==null&&window.clearTimeout(m.current),m.current=window.setTimeout(()=>{de(!0)},me)},[]),oe=n.useCallback(()=>{const d=performance.now();Z.current=d,Y.current=!1,w.current!==null&&(cancelAnimationFrame(w.current),w.current=null),P(0);const _=U=>{if(Z.current===null)return;const Q=U-Z.current;let V=0;if(Q<=f)V=Q/f*.1;else{const re=Q-f,Me=we-f;V=.1+Math.min(re/Me,1)*.9}if(P(V),V>=1&&!Y.current){Y.current=!0,K(),j(),B();return}A.current=requestAnimationFrame(_)};A.current=requestAnimationFrame(_)},[K,j,B]),fe=n.useCallback(()=>{oe(),te()},[oe,te]),x=n.useCallback(()=>{j(),B()},[j,B]);n.useEffect(()=>{z.current=i},[i]),n.useEffect(()=>{r||j()},[r,j]),n.useEffect(()=>B,[B]),n.useLayoutEffect(()=>{if(!b)return;const d=()=>{const U=$.current,Q=E.current;if(!U||!Q)return;const V=U.getBoundingClientRect(),re=Q.getBoundingClientRect();be(V.width),ue({left:Math.max(0,re.left-V.left),width:re.width})};d();const _=new ResizeObserver(d);return $.current&&_.observe($.current),E.current&&_.observe(E.current),window.addEventListener("resize",d),()=>{_.disconnect(),window.removeEventListener("resize",d)}},[b]);const W=Math.floor(R.readScore/400)+1,h=Math.floor((R.readScore+M)/400)+1,Se=W*400,ne=Math.max(0,Se-R.readScore),k=R.watchBalanceMinutes-v,ge=R.readScore-I-(k<0?Ee:0),N=Math.floor(ge/400)+1,xe=h>W?"↑":"-",J=N<W?"↓":"-",he=d=>Number.isInteger(d)?String(d):d.toFixed(1),Ne=k>=0?`${k} min`:`-${Math.abs(k)} min`,_e=R.watchBalanceMinutes+y,ve=he(y),e=`+${M} score, +${ve}m`,t=C>0,s=t?`Read for ${ce} to claim rewards`:`Claim your reading rewards (${e})`,l=_e>=0?`+${he(_e)}m`:`-${he(Math.abs(_e))}m`,o=c?"Generating Summary...":`Read Instead (Watch Balance +${ve}m)`,g=D*i,L=Math.max(0,Math.min(ie.width,g-ie.left)),F=Math.max(0,L);return a.jsx("div",{className:"intent-overlay",children:a.jsxs("div",{className:"intent-overlay__panel",children:[a.jsxs("div",{className:`intent-overlay__content${O?" intent-overlay__content--dim":""}`,children:[a.jsx("div",{className:"intent-overlay__title",children:"Read First"}),a.jsx("div",{className:"intent-overlay__subtitle",children:H}),b?a.jsxs("div",{className:"intent-overlay__metrics",children:[a.jsxs("div",{className:"intent-overlay__metric",children:[a.jsx("span",{className:"intent-overlay__metric-label",children:"Level"}),a.jsx("span",{className:"intent-overlay__metric-value",children:W})]}),a.jsxs("div",{className:"intent-overlay__metric",children:[a.jsx("span",{className:"intent-overlay__metric-label",children:"Read Score"}),a.jsx("span",{className:"intent-overlay__metric-value",children:u.readScore})]}),a.jsxs("div",{className:"intent-overlay__metric",children:[a.jsx("span",{className:"intent-overlay__metric-label",children:"Watch Balance"}),a.jsxs("span",{className:"intent-overlay__metric-value",children:[R.watchBalanceMinutes," min"]})]})]}):a.jsxs("div",{className:"intent-overlay__auth",children:[a.jsx("div",{className:"intent-overlay__auth-title",children:"Sign in to continue"}),a.jsx("div",{className:"intent-overlay__auth-copy",children:"Your score and balance sync to your account. Sign in to proceed."}),a.jsx("button",{className:"intent-overlay__auth-button",type:"button",onClick:X,disabled:ae,children:ae?"Authenticating…":"Sign in with Google"})]}),b?p?a.jsxs("div",{className:"intent-overlay__summary",children:[a.jsxs("div",{className:"intent-overlay__summary-header",children:[a.jsx("div",{className:"intent-overlay__summary-title",children:p.title||"Read First Brief"}),a.jsxs("div",{className:"intent-overlay__summary-meta",children:[p.readingTimeMinutes," min read"]})]}),a.jsxs("div",{className:"intent-overlay__summary-body",children:[p.summary?a.jsx("div",{className:"intent-overlay__summary-text",children:p.summary}):null,(q=p.keyPoints)!=null&&q.length?a.jsx("ul",{className:"intent-overlay__summary-list",children:p.keyPoints.map((d,_)=>a.jsx("li",{children:d},`${_}-${d.slice(0,16)}`))}):null]}),a.jsx("button",{className:"intent-overlay__summary-claim",type:"button",onClick:se,disabled:T||pe||t,children:pe?"Rewards claimed":T?"Claiming rewards...":s})]}):a.jsxs("div",{className:"intent-overlay__choice",children:[a.jsx("div",{className:"intent-overlay__choice-title",children:"Your Choice"}),a.jsxs("div",{className:"intent-overlay__choice-grid",children:[a.jsxs("div",{className:"intent-overlay__choice-card intent-overlay__choice-card--watch",children:[a.jsx("div",{className:"intent-overlay__choice-header",children:"Watch Now"}),a.jsxs("div",{className:"intent-overlay__choice-chips",children:[a.jsxs("span",{className:"intent-overlay__chip intent-overlay__chip--warn",children:["Score -",I]}),a.jsxs("span",{className:"intent-overlay__chip intent-overlay__chip--warn",children:["Watch Balance -",v,"m"]}),a.jsxs("span",{className:"intent-overlay__chip intent-overlay__chip--highlight",children:["New Watch Balance ",Ne]}),a.jsxs("span",{className:"intent-overlay__chip",children:["Level ",N," ",J]})]}),k<0?a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"intent-overlay__choice-subline",children:["Additional score penalty -",Ee," (attention debt)"]}),a.jsx("div",{className:"intent-overlay__choice-subline",children:"Level progress paused while negative"}),N<W?a.jsxs("div",{className:"intent-overlay__choice-warning",children:["⚠️ Risk: Level down to ",N]}):null]}):null]}),a.jsxs("div",{className:"intent-overlay__choice-card intent-overlay__choice-card--read",children:[a.jsx("div",{className:"intent-overlay__choice-header",children:"Read Instead"}),a.jsxs("div",{className:"intent-overlay__choice-chips",children:[a.jsxs("span",{className:"intent-overlay__chip",children:["Score +",M]}),a.jsxs("span",{className:"intent-overlay__chip",children:["Watch Balance +",ve,"m"]}),a.jsxs("span",{className:"intent-overlay__chip intent-overlay__chip--highlight",children:["New Watch Balance ",l]}),a.jsxs("span",{className:"intent-overlay__chip",children:["Level ",h," ",xe]})]}),a.jsxs("div",{className:"intent-overlay__choice-note intent-overlay__choice-note--progress",children:[a.jsxs("span",{className:"intent-overlay__choice-note-label",children:["Level ",W+1," in"]}),a.jsx("span",{className:"intent-overlay__choice-note-score",children:ne}),a.jsx("span",{className:"intent-overlay__choice-note-unit",children:"pts"})]})]})]})]}):null]}),b&&!p?a.jsxs("div",{className:"intent-overlay__actions",children:[a.jsxs("button",{className:"intent-overlay__secondary",type:"button",onPointerDown:fe,onPointerUp:x,onPointerLeave:x,onPointerCancel:x,ref:$,children:[a.jsx("span",{className:"intent-overlay__hold-fill",style:{transform:`scaleX(${i})`}}),a.jsxs("span",{className:"intent-overlay__button-label intent-overlay__button-label--progress",children:[a.jsxs("span",{ref:E,className:"intent-overlay__button-label-base",children:["Watch Now (Watch Balance -",v,"m)"]}),a.jsxs("span",{className:"intent-overlay__button-label-fill",style:{"--label-fill-px":`${F}px`},children:["Watch Now (Watch Balance -",v,"m)"]})]})]}),a.jsxs("button",{className:`intent-overlay__primary intent-overlay__primary--read${c?" intent-overlay__primary--read-active":""}`,type:"button",onClick:G,disabled:c,children:[a.jsx("span",{className:"intent-overlay__press-fill"}),a.jsxs("span",{className:`intent-overlay__button-label intent-overlay__button-label--progress${c?" intent-overlay__button-label--loading":""}`,children:[a.jsx("span",{className:"intent-overlay__button-label-base",children:o}),a.jsx("span",{className:"intent-overlay__button-label-fill",children:o})]})]})]}):null,a.jsxs("div",{className:`intent-overlay__motto${O?" intent-overlay__motto--visible":""}`,children:[a.jsx("span",{className:"intent-overlay__motto-red",children:"Old ways"}),a.jsx("span",{className:"intent-overlay__motto-neutral",children:" dont open "}),a.jsx("span",{className:"intent-overlay__motto-green",children:"new doors"})]})]})})}const je="intent-read-first-root",ye="http://127.0.0.1:8787",Ce=40,De=5,Re=10,Oe=10,$e=200,We=15,ke=15e3,Fe=1e4,Le=r=>Math.floor(r/400)+1,qe=30;function Ie(r){return r?r.trim().split(/\s+/).filter(Boolean).length:0}function Ue(r){var M;if(!r)return 0;const c=Ie(r.summary),u=((M=r.keyPoints)==null?void 0:M.reduce((I,p)=>I+Ie(p),0))??0,v=c+u;if(v===0)return 0;const y=Math.round(v/$e*60);return Math.max(We,y)}function Ve(r){const c=Math.floor(r/60),u=r%60;return c<=0?`${u}s`:`${c}:${String(u).padStart(2,"0")}`}function Te(r){try{const c=new URL(r);return c.pathname!=="/watch"?null:c.searchParams.get("v")}catch{return null}}function He(){var u;const r=document.querySelector("video");if(r&&!r.paused&&r.pause(),r){r.autoplay=!1;return}const c=document.querySelector(".ytp-play-button");c&&((u=c.getAttribute("aria-label"))!=null&&u.toLowerCase().includes("pause"))&&c.click()}function Ge(r){const c=Math.floor(r),u=Math.floor(c/3600),v=Math.floor(c%3600/60),y=c%60;return(u>0?[u,v,y]:[v,y]).map(I=>String(I).padStart(2,"0")).join(":")}function Ye(){var r,c;return((c=(r=document.querySelector("h1 yt-formatted-string"))==null?void 0:r.textContent)==null?void 0:c.trim())||document.title.replace(/\s+-\s+YouTube$/i,"").trim()||"Untitled video"}function ze(){const r=document.querySelector("video");return!r||!Number.isFinite(r.duration)?null:r.duration}function Je(r){return Number.isFinite(r)?Math.round(r*2/10)*10:Ce}function Qe(r){if(!r||!Number.isFinite(r))return Re;const c=Math.max(0,r),u=Math.floor(c/60);return c%60>=qe?u+1:u}function Xe(){const[r,c]=n.useState(()=>Te(window.location.href));return n.useEffect(()=>{const u=()=>c(Te(window.location.href)),v=history.pushState,y=history.replaceState;history.pushState=function(...p){v.apply(this,p),u()},history.replaceState=function(...p){y.apply(this,p),u()},window.addEventListener("popstate",u);const M=new MutationObserver(u);M.observe(document.body,{childList:!0,subtree:!0});const I=window.setInterval(u,1e3);return()=>{history.pushState=v,history.replaceState=y,window.removeEventListener("popstate",u),M.disconnect(),window.clearInterval(I)}},[]),r}function Ke(){const r=Xe(),[c,u]=n.useState(!0),[v,y]=n.useState(!1),[M,I]=n.useState(0),[p,T]=n.useState(null),[pe,C]=n.useState(!1),[ce,H]=n.useState(null),[b,le]=n.useState(null),[ae,X]=n.useState(!1),[G,K]=n.useState(!1),[se,R]=n.useState(0),[i,P]=n.useState(null),[D,be]=n.useState(Re),ie=n.useRef(r),ue=n.useRef(null),O=n.useRef(null),de=n.useRef(async()=>!1),Z=n.useRef(crypto.randomUUID()),A=n.useRef(Date.now()),Y=n.useRef(!1),w=n.useRef(null),z=n.useRef(null),m=n.useRef(null),$=n.useRef(0),E=n.useRef(!1),we=n.useRef(null),f=n.useRef(null),ee=n.useRef(0),me=n.useRef(0),j=n.useRef(!1),B=n.useMemo(()=>D/2,[D]),te=n.useMemo(()=>Je(D),[D]),oe=te,fe=n.useMemo(()=>["It is not enough to be busy; so are the ants. The question is: What are we busy about? — Henry David Thoreau","The successful warrior is the average man, with laser-like focus. — Bruce Lee","Concentrate all your thoughts upon the work in hand. — Alexander Graham Bell","Simplicity is the ultimate sophistication. — Leonardo da Vinci","A well-spent day brings happy sleep. — Leonardo da Vinci","Your focus determines your reality. — George Lucas"],[]),x=n.useCallback(async(e,t)=>new Promise(s=>{var l;if(!((l=chrome==null?void 0:chrome.runtime)!=null&&l.sendMessage)){s({ok:!1,error:"Extension runtime unavailable."});return}try{chrome.runtime.sendMessage({type:"api_request",url:e,init:t},o=>{if(chrome.runtime.lastError){s({ok:!1,error:chrome.runtime.lastError.message});return}s(o)})}catch(o){s({ok:!1,error:o instanceof Error?o.message:String(o)})}}),[]),W=n.useCallback(()=>({page:"youtube_watch",url:window.location.href}),[]),h=n.useCallback(async(e,t)=>{if(!i)return;const s={type:e,videoId:r??void 0,sessionId:Z.current,data:t,context:W()};await x(`${ye}/stream`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i.access_token}`},body:JSON.stringify(s)})},[i,r,x,W]),Se=n.useCallback(()=>{if(!i||!r||Y.current)return;Y.current=!0;const e=Math.max(0,Date.now()-A.current);h("intent_panel_shown",{delay_ms:e,videoId:r})},[i,r,h]),ne=n.useCallback(e=>{if(!E.current||j.current)return;j.current=!0;const t=Math.max(0,Math.round(ee.current));h("watch_ended",{total_watch_seconds:t,ended_by:e})},[h]),k=n.useCallback(async()=>{var g;if(!S)return{ok:!1,error:"Supabase client not configured."};const e=(g=i==null?void 0:i.user)==null?void 0:g.id;if(!e)return{ok:!1,error:"Supabase session unavailable."};const{data:t,error:s}=await S.from("user_state").select("user_id, read_score, watch_balance_minutes").eq("user_id",e).maybeSingle();if(s)return{ok:!1,error:s.message};if(t)return{ok:!0,data:t};const{data:l,error:o}=await S.from("user_state").insert({user_id:e,read_score:0,watch_balance_minutes:0}).select("user_id, read_score, watch_balance_minutes").single();return o||!l?{ok:!1,error:(o==null?void 0:o.message)||"Failed to create watch balance state."}:{ok:!0,data:l}},[i,S]),ge=n.useCallback(async()=>{const e=await k();if(!e.ok)return{ok:!1,error:e.error};const t=e.data;return{ok:!0,data:{level:Le(t.read_score),readScore:t.read_score,watchBalanceMinutes:t.watch_balance_minutes}}},[k]);n.useEffect(()=>{r&&r!==ie.current&&(E.current&&!j.current&&ne("navigation"),ie.current=r,Z.current=crypto.randomUUID(),A.current=Date.now(),Y.current=!1,w.current=null,z.current=null,$.current=0,E.current=!1,we.current=null,ee.current=0,me.current=0,j.current=!1,m.current!==null&&(window.clearInterval(m.current),m.current=null),f.current!==null&&(window.clearInterval(f.current),f.current=null),u(!0),y(!1),be(Re),le(null),K(!1),X(!1),R(0),O.current=null,ue.current=null)},[r,ne]),n.useEffect(()=>{if(!b){R(0),O.current=null,$.current=0,m.current!==null&&(window.clearInterval(m.current),m.current=null);return}const e=Ue(b),t=Date.now()+e*1e3;if(O.current=t,R(e),z.current=Date.now(),e===0)return;const s=window.setInterval(()=>{if(!O.current)return;const l=O.current-Date.now(),o=Math.max(0,Math.ceil(l/1e3));R(o),o<=0&&window.clearInterval(s)},500);return()=>window.clearInterval(s)},[b]),n.useEffect(()=>{if(!(!b||G||!i)&&m.current===null)return m.current=window.setInterval(()=>{!b||G||($.current+=Math.round(ke/1e3),h("read_progress",{read_seconds_total:$.current}))},ke),()=>{m.current!==null&&(window.clearInterval(m.current),m.current=null)}},[b,G,h,i]),n.useEffect(()=>{if(!c||!r)return;let e=null;const t=()=>{const o=e?e.duration:null;be(Qe(o))},s=()=>{const o=document.querySelector("video");if(!o){t();return}e&&e!==o&&(e.removeEventListener("loadedmetadata",t),e.removeEventListener("durationchange",t)),e=o,t(),e.addEventListener("loadedmetadata",t),e.addEventListener("durationchange",t)};s();const l=new MutationObserver(s);return l.observe(document.body,{childList:!0,subtree:!0}),()=>{l.disconnect(),e&&(e.removeEventListener("loadedmetadata",t),e.removeEventListener("durationchange",t))}},[c,r]);const N=n.useCallback(async()=>{if(!i)return!1;const e=await ge();if(e.ok&&e.data)return H(e.data),!0;const t=await x(`${ye}/state`,{headers:{Authorization:`Bearer ${i.access_token}`}});if(!t.ok||!t.body)return!1;const s=t.body;return H({level:s.level,readScore:s.readScore,watchBalanceMinutes:s.watchBalanceMinutes}),!0},[i,ge,x]);n.useEffect(()=>{de.current=N},[N]);const xe=n.useCallback(async(e,t)=>{var d;if(!S)return{ok:!1,error:"Supabase client not configured."};const s=(d=i==null?void 0:i.user)==null?void 0:d.id;if(!s)return{ok:!1,error:"Supabase session unavailable."};let l=0,o=0;switch(e){case"read_completed":l+=typeof(t==null?void 0:t.score)=="number"?t.score:Ce,o+=typeof(t==null?void 0:t.minutes)=="number"?t.minutes:De;break;case"watch_initiated":{const _=typeof(t==null?void 0:t.minutes)=="number"?t.minutes:Re;o-=_;const U=typeof(t==null?void 0:t.score)=="number"?t.score:0;l-=U;break}case"session_end":{const _=await k();if(!_.ok||!_.data)return{ok:!1,error:_.error||"Unable to load state."};_.data.watch_balance_minutes<0&&(l-=Oe);break}default:return{ok:!0,data:null}}const g=await k();if(!g.ok||!g.data)return{ok:!1,error:g.error||"Unable to load state."};const L=g.data.read_score+l,F=g.data.watch_balance_minutes+o,{error:q}=await S.from("user_state").update({read_score:L,watch_balance_minutes:F,updated_at:new Date().toISOString()}).eq("user_id",s);return q?{ok:!1,error:q.message}:{ok:!0,data:{level:Le(L),readScore:L,watchBalanceMinutes:F}}},[i,k,S]),J=n.useCallback(async(e,t)=>{if(!i)return null;h(e,t);const s=await xe(e,t);if(s.ok)return s.data??null;const l=await x(`${ye}/event`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i.access_token}`},body:JSON.stringify({type:e,data:t})});return l.ok?l.body??null:null},[i,xe,x,h]);n.useEffect(()=>{if(!S)return;S.auth.getSession().then(({data:s})=>P(s.session));const{data:e}=S.auth.onAuthStateChange((s,l)=>{P(l),l&&C(!1)}),t=s=>{(s==null?void 0:s.type)==="auth_complete"&&(S.auth.getSession().then(({data:l})=>{P(l.session),l.session&&de.current()}),C(!1)),(s==null?void 0:s.type)==="auth_signed_out"&&(P(null),C(!1),u(!0),y(!1))};return chrome.runtime.onMessage.addListener(t),()=>{e.subscription.unsubscribe(),chrome.runtime.onMessage.removeListener(t)}},[S]),n.useEffect(()=>{i||(H(null),le(null),K(!1),X(!1),R(0),O.current=null)},[i]),n.useEffect(()=>{T(S?null:"Missing Supabase configuration.")},[]),n.useEffect(()=>{if(!r||!i)return;let e=0,t=null,s=!1;const l=async()=>{e+=1,!await N()&&!s&&e<3&&(t=window.setTimeout(l,1e3))};return l(),J("video_opened",{videoId:r}),()=>{s=!0,t!==null&&window.clearTimeout(t)}},[r,i,N,J]),n.useEffect(()=>{if(!r||!c||!i||!ce||ue.current===r)return;ue.current=r,(async()=>{var s,l,o;const t=await x(`${ye}/transcript`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({videoId:r})});if(t.ok&&((s=t.body)!=null&&s.transcript)){const g=t.body.source?` (${t.body.source})`:"",L=`https://www.youtube.com/watch?v=${r}`,F=((o=(l=document.querySelector("h1 yt-formatted-string"))==null?void 0:l.textContent)==null?void 0:o.trim())||document.title.replace(/\s+-\s+YouTube$/i,"").trim()||"Unknown",q=document.querySelector("video"),d=q&&Number.isFinite(q.duration)?Ge(q.duration):"Unknown";console.log(`[Intent]
URL: ${L}
LENGTH: ${d}
TITLE: ${F}
TRANSCRIPT:${g}
${t.body.transcript}`)}else console.warn(`[Intent] Transcript unavailable for ${r}.`)})()},[r,c,i,ce,x]),n.useEffect(()=>{c&&I(e=>(e+1)%fe.length)},[c,fe.length]),n.useEffect(()=>{c&&Se()},[c,Se]),n.useEffect(()=>{if(!c)return;let e=null;const t=()=>{e==null||e.pause()},s=()=>{const o=document.querySelector("video");if(!o){He();return}e&&e!==o&&(e.removeEventListener("play",t),e.removeEventListener("playing",t)),e=o,e.autoplay=!1,e.addEventListener("play",t),e.addEventListener("playing",t),e.pause()};s();const l=new MutationObserver(s);return l.observe(document.body,{childList:!0,subtree:!0}),()=>{l.disconnect(),e&&(e.removeEventListener("play",t),e.removeEventListener("playing",t))}},[c,r]),n.useEffect(()=>{if(c||!E.current||!r)return;let e=document.querySelector("video"),t=!1;const s=()=>{(!e||!document.contains(e))&&(e=document.querySelector("video"))},l=()=>{if(t||(s(),!e||!Number.isFinite(e.currentTime)))return;const L=Math.max(0,e.currentTime),F=L-ee.current;F>=1&&(ee.current=L,me.current+=1,h("watch_progress",{watch_seconds_total:Math.round(L),watch_seconds_delta:Math.round(F),sample_index:me.current}))},o=()=>{ne("video_end"),E.current=!1,f.current!==null&&(window.clearInterval(f.current),f.current=null),t=!0},g=()=>{e!=null&&e.ended||(ne("paused"),E.current=!1,f.current!==null&&(window.clearInterval(f.current),f.current=null),t=!0)};return s(),e&&(ee.current=Math.max(0,e.currentTime||0),e.addEventListener("ended",o),e.addEventListener("pause",g)),f.current=window.setInterval(l,Fe),()=>{t=!0,f.current!==null&&(window.clearInterval(f.current),f.current=null),e&&(e.removeEventListener("ended",o),e.removeEventListener("pause",g))}},[c,r,h,ne]);const he=n.useCallback(async()=>{if(!i)return;u(!1),y(!1);const e=await J("watch_initiated",{minutes:D,videoId:r,score:oe,time_since_open_ms:Math.max(0,Date.now()-A.current)});E.current=!0,we.current=Date.now(),j.current=!1,e?H({level:e.level,readScore:e.readScore,watchBalanceMinutes:e.watchBalanceMinutes}):await N()},[J,r,i,N,D,oe]),Ne=n.useCallback(async()=>{var l,o;if(!i)return;y(!0),le(null),K(!1),X(!1);const e=Ye(),t=ze();h("summary_requested",{videoId:r,title:e,durationSeconds:t,time_since_open_ms:Math.max(0,Date.now()-A.current)}),w.current=Date.now();const s=await x(`${ye}/summarize`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({videoId:r,title:e,durationSeconds:t})});s.ok&&((l=s.body)!=null&&l.summary)?(le(s.body),z.current=Date.now(),h("summary_generated",{videoId:r,latency_ms:w.current?Math.max(0,Date.now()-w.current):null,readingTimeMinutes:s.body.readingTimeMinutes,summaryLength:s.body.summary.length,keyPointCount:((o=s.body.keyPoints)==null?void 0:o.length)??0,source:s.body.source,language:s.body.language})):(h("summary_failed",{videoId:r,latency_ms:w.current?Math.max(0,Date.now()-w.current):null,status:s.status,error:s.error}),console.warn("[Intent] Summary unavailable",{videoId:r,status:s.status,error:s.error,body:s.body})),y(!1)},[r,i,x,h]),_e=n.useCallback(async()=>{if(!i||!b||ae||G||se>0)return;X(!0);const e=z.current?Math.max(0,Date.now()-z.current):null,t=await J("read_completed",{videoId:r,minutes:B,score:te,read_time_ms:e});t?H({level:t.level,readScore:t.readScore,watchBalanceMinutes:t.watchBalanceMinutes}):await N(),K(!0),X(!1),window.location.assign("https://www.youtube.com/")},[i,b,ae,G,se,J,r,B,te,N]),ve=n.useCallback(async()=>{var l;if(!S){T("Missing Supabase configuration.");return}C(!0);const e=(l=chrome.runtime)==null?void 0:l.getURL("auth.html"),{data:t,error:s}=await S.auth.signInWithOAuth({provider:"google",options:e?{redirectTo:e,skipBrowserRedirect:!0}:{skipBrowserRedirect:!0}});if(s||!(t!=null&&t.url)){T((s==null?void 0:s.message)||"Failed to start sign-in."),C(!1);return}try{chrome.runtime.sendMessage({type:"oauth_start",url:t.url},o=>{if(chrome.runtime.lastError){T(chrome.runtime.lastError.message),C(!1);return}o!=null&&o.ok||(T((o==null?void 0:o.error)||"OAuth failed."),C(!1))})}catch(o){T(o instanceof Error?o.message:"Extension runtime unavailable."),C(!1)}},[S]);return r?a.jsx(Pe,{isVisible:c,isLoading:v,isAuthenticated:!!i,authError:p,authInProgress:pe,metrics:ce,watchCostMinutes:D,readGainMinutes:B,readScoreGain:te,watchScorePenalty:oe,summary:b,isClaimingRewards:ae,hasClaimedRewards:G,claimSecondsRemaining:se,claimCountdownLabel:Ve(se),quote:fe[M],onLogin:ve,onReadFirst:Ne,onWatchNow:he,onClaimRewards:_e}):null}function Ze(){if(document.getElementById(je))return;const r=document.createElement("div");r.id=je,document.body.appendChild(r),Ae(r).render(a.jsx(Be.StrictMode,{children:a.jsx(Ke,{})}))}Ze();
