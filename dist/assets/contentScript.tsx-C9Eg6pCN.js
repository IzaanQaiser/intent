import{j as t,r as a,c as ne,R as ae}from"./client-DMp2t5-j.js";import{s as d}from"./supabaseClient-DihBYOwf.js";const Q=40,re=5,X=10,K=10;function se({isVisible:s,isLoading:l,metrics:u,quote:M,isAuthenticated:m,authError:P,authInProgress:T,onLogin:I,onReadFirst:b,onWatchNow:G}){if(!s)return null;if(m&&!u)return t.jsx("div",{className:"intent-overlay",children:t.jsxs("div",{className:"intent-overlay__panel",children:[t.jsx("div",{className:"intent-overlay__title",children:"Read First"}),t.jsx("div",{className:"intent-overlay__subtitle",children:M}),t.jsx("div",{className:"intent-overlay__loading",children:"Syncing your watch balance…"})]})});const h=u??{readScore:0,watchBalanceMinutes:0},[N,p]=a.useState(0),[i,O]=a.useState(0),[W,$]=a.useState({left:0,width:0}),L=a.useRef(null),w=a.useRef(null),v=a.useRef(!1),f=a.useRef(null),q=a.useRef(0),_=a.useRef(null),A=a.useRef(null),j=5e3,F=120,z=140,S=a.useCallback(()=>{w.current!==null&&(cancelAnimationFrame(w.current),w.current=null),f.current!==null&&(cancelAnimationFrame(f.current),f.current=null),L.current=null,v.current=!1;const g=q.current;if(g<=0){p(0);return}const R=performance.now(),C=E=>{const x=E-R,B=Math.min(x/z,1),Y=g*(1-B);if(p(Y),B>=1){f.current=null;return}f.current=requestAnimationFrame(C)};f.current=requestAnimationFrame(C)},[]),e=a.useCallback(()=>{const g=performance.now();L.current=g,v.current=!1,f.current!==null&&(cancelAnimationFrame(f.current),f.current=null),p(0);const R=C=>{if(L.current===null)return;const E=C-L.current;let x=0;if(E<=F)x=E/F*.1;else{const B=E-F,Y=j-F;x=.1+Math.min(B/Y,1)*.9}if(p(x),x>=1&&!v.current){v.current=!0,G(),S();return}w.current=requestAnimationFrame(R)};w.current=requestAnimationFrame(R)},[G,S]);a.useEffect(()=>{q.current=N},[N]),a.useEffect(()=>{s||S()},[s,S]),a.useLayoutEffect(()=>{if(!m)return;const g=()=>{const C=_.current,E=A.current;if(!C||!E)return;const x=C.getBoundingClientRect(),B=E.getBoundingClientRect();O(x.width),$({left:Math.max(0,B.left-x.left),width:B.width})};g();const R=new ResizeObserver(g);return _.current&&R.observe(_.current),A.current&&R.observe(A.current),window.addEventListener("resize",g),()=>{R.disconnect(),window.removeEventListener("resize",g)}},[m]);const n=Math.floor(h.readScore/400)+1,r=Math.floor((h.readScore+Q)/400)+1,o=h.watchBalanceMinutes-X,c=o<0?h.readScore-K:h.readScore,y=Math.floor(c/400)+1,D=r>n?"↑":"=",U=o>=0?`${o} min`:`-${Math.abs(o)} min`,V=i*N,H=Math.max(0,Math.min(W.width,V-W.left)),k=Math.max(0,H);return t.jsx("div",{className:"intent-overlay",children:t.jsxs("div",{className:"intent-overlay__panel",children:[t.jsx("div",{className:"intent-overlay__title",children:"Read First"}),t.jsx("div",{className:"intent-overlay__subtitle",children:M}),m?t.jsxs("div",{className:"intent-overlay__metrics",children:[t.jsxs("div",{className:"intent-overlay__metric",children:[t.jsx("span",{className:"intent-overlay__metric-label",children:"Level"}),t.jsx("span",{className:"intent-overlay__metric-value",children:n})]}),t.jsxs("div",{className:"intent-overlay__metric",children:[t.jsx("span",{className:"intent-overlay__metric-label",children:"Read Score"}),t.jsx("span",{className:"intent-overlay__metric-value",children:u.readScore})]}),t.jsxs("div",{className:"intent-overlay__metric",children:[t.jsx("span",{className:"intent-overlay__metric-label",children:"Watch Balance"}),t.jsxs("span",{className:"intent-overlay__metric-value",children:[h.watchBalanceMinutes," min"]})]})]}):t.jsxs("div",{className:"intent-overlay__auth",children:[t.jsx("div",{className:"intent-overlay__auth-title",children:"Sign in to continue"}),t.jsx("div",{className:"intent-overlay__auth-copy",children:"Your score and balance sync to your account. Sign in to proceed."}),t.jsx("button",{className:"intent-overlay__auth-button",type:"button",onClick:I,disabled:T,children:T?"Authenticating…":"Sign in with Google"})]}),m?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"intent-overlay__choice",children:[t.jsx("div",{className:"intent-overlay__choice-title",children:"Your Choice"}),t.jsxs("div",{className:"intent-overlay__choice-grid",children:[t.jsxs("div",{className:"intent-overlay__choice-card",children:[t.jsx("div",{className:"intent-overlay__choice-header",children:"Read Instead"}),t.jsxs("div",{className:"intent-overlay__choice-chips",children:[t.jsxs("span",{className:"intent-overlay__chip",children:["Score +",Q]}),t.jsxs("span",{className:"intent-overlay__chip",children:["Watch Balance +",re,"m"]}),t.jsxs("span",{className:"intent-overlay__chip",children:["Level ",r," ",D]})]}),t.jsx("div",{className:"intent-overlay__choice-note",children:"Reading restores progress."})]}),t.jsxs("div",{className:"intent-overlay__choice-card intent-overlay__choice-card--watch",children:[t.jsx("div",{className:"intent-overlay__choice-header",children:"Watch Now"}),t.jsxs("div",{className:"intent-overlay__choice-chips",children:[t.jsxs("span",{className:"intent-overlay__chip intent-overlay__chip--warn",children:["Watch Balance -",X,"m"]}),t.jsxs("span",{className:"intent-overlay__chip intent-overlay__chip--highlight",children:["New Watch Balance ",U]})]}),o<0?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"intent-overlay__choice-subline",children:["Score penalty -",K," (attention debt)"]}),t.jsx("div",{className:"intent-overlay__choice-subline",children:"Level progress paused while negative"}),y<n?t.jsxs("div",{className:"intent-overlay__choice-warning",children:["⚠️ Risk: Level down to ",y]}):null]}):t.jsx("div",{className:"intent-overlay__choice-subline",children:"No score penalty (balance stays non-negative)"})]})]})]}),t.jsxs("div",{className:"intent-overlay__actions",children:[t.jsx("button",{className:"intent-overlay__primary",type:"button",onClick:b,disabled:l,children:l?"Generating summary…":"Read Instead"}),t.jsxs("button",{className:"intent-overlay__secondary",type:"button",onPointerDown:e,onPointerUp:S,onPointerLeave:S,onPointerCancel:S,ref:_,children:[t.jsx("span",{className:"intent-overlay__hold-fill",style:{transform:`scaleX(${N})`}}),t.jsxs("span",{className:"intent-overlay__button-label intent-overlay__button-label--progress",children:[t.jsx("span",{ref:A,className:"intent-overlay__button-label-base",children:"Watch Now"}),t.jsx("span",{className:"intent-overlay__button-label-fill",style:{"--label-fill-px":`${k}px`},children:"Watch Now"})]})]})]}),l?t.jsx("div",{className:"intent-overlay__loading",children:"Preparing a focused summary and key points…"}):null]}):null]})})}const Z="intent-read-first-root",J="http://127.0.0.1:8787",oe=40,ce=5,ie=10,le=10,ee=s=>Math.floor(s/400)+1;function te(s){try{const l=new URL(s);return l.pathname!=="/watch"?null:l.searchParams.get("v")}catch{return null}}function ue(){var u;const s=document.querySelector("video");if(s&&!s.paused&&s.pause(),s){s.autoplay=!1;return}const l=document.querySelector(".ytp-play-button");l&&((u=l.getAttribute("aria-label"))!=null&&u.toLowerCase().includes("pause"))&&l.click()}function de(){const[s,l]=a.useState(()=>te(window.location.href));return a.useEffect(()=>{const u=()=>l(te(window.location.href)),M=history.pushState,m=history.replaceState;history.pushState=function(...I){M.apply(this,I),u()},history.replaceState=function(...I){m.apply(this,I),u()},window.addEventListener("popstate",u);const P=new MutationObserver(u);P.observe(document.body,{childList:!0,subtree:!0});const T=window.setInterval(u,1e3);return()=>{history.pushState=M,history.replaceState=m,window.removeEventListener("popstate",u),P.disconnect(),window.clearInterval(T)}},[]),s}function he(){const s=de(),[l,u]=a.useState(!0),[M,m]=a.useState(!1),[P,T]=a.useState(0),[I,b]=a.useState(null),[G,h]=a.useState(!1),[N,p]=a.useState(null),[i,O]=a.useState(null),W=a.useRef(s),$=a.useRef(null),L=a.useRef(async()=>!1),w=a.useMemo(()=>["It is not enough to be busy; so are the ants. The question is: What are we busy about? — Henry David Thoreau","The successful warrior is the average man, with laser-like focus. — Bruce Lee","Concentrate all your thoughts upon the work in hand. — Alexander Graham Bell","Simplicity is the ultimate sophistication. — Leonardo da Vinci","A well-spent day brings happy sleep. — Leonardo da Vinci","Your focus determines your reality. — George Lucas"],[]),v=a.useCallback(async(e,n)=>new Promise(r=>{var o;if(!((o=chrome==null?void 0:chrome.runtime)!=null&&o.sendMessage)){r({ok:!1,error:"Extension runtime unavailable."});return}try{chrome.runtime.sendMessage({type:"api_request",url:e,init:n},c=>{if(chrome.runtime.lastError){r({ok:!1,error:chrome.runtime.lastError.message});return}r(c)})}catch(c){r({ok:!1,error:c instanceof Error?c.message:String(c)})}}),[]),f=a.useCallback(async()=>{var y;if(!d)return{ok:!1,error:"Supabase client not configured."};const e=(y=i==null?void 0:i.user)==null?void 0:y.id;if(!e)return{ok:!1,error:"Supabase session unavailable."};const{data:n,error:r}=await d.from("user_state").select("user_id, read_score, watch_balance_minutes").eq("user_id",e).maybeSingle();if(r)return{ok:!1,error:r.message};if(n)return{ok:!0,data:n};const{data:o,error:c}=await d.from("user_state").insert({user_id:e,read_score:0,watch_balance_minutes:0}).select("user_id, read_score, watch_balance_minutes").single();return c||!o?{ok:!1,error:(c==null?void 0:c.message)||"Failed to create watch balance state."}:{ok:!0,data:o}},[i,d]),q=a.useCallback(async()=>{const e=await f();if(!e.ok)return{ok:!1,error:e.error};const n=e.data;return{ok:!0,data:{level:ee(n.read_score),readScore:n.read_score,watchBalanceMinutes:n.watch_balance_minutes}}},[f]);a.useEffect(()=>{s&&s!==W.current&&(W.current=s,u(!0),m(!1),$.current=null)},[s]);const _=a.useCallback(async()=>{if(!i)return!1;const e=await q();if(e.ok&&e.data)return p(e.data),!0;const n=await v(`${J}/state`,{headers:{Authorization:`Bearer ${i.access_token}`}});if(!n.ok||!n.body)return!1;const r=n.body;return p({level:r.level,readScore:r.readScore,watchBalanceMinutes:r.watchBalanceMinutes}),!0},[i,q,v]);a.useEffect(()=>{L.current=_},[_]);const A=a.useCallback(async(e,n)=>{var H;if(!d)return{ok:!1,error:"Supabase client not configured."};const r=(H=i==null?void 0:i.user)==null?void 0:H.id;if(!r)return{ok:!1,error:"Supabase session unavailable."};let o=0,c=0;switch(e){case"read_completed":o+=oe,c+=ce;break;case"watch_initiated":{const k=typeof(n==null?void 0:n.minutes)=="number"?n.minutes:ie;c-=k;break}case"session_end":{const k=await f();if(!k.ok||!k.data)return{ok:!1,error:k.error||"Unable to load state."};k.data.watch_balance_minutes<0&&(o-=le);break}default:return{ok:!0,data:null}}const y=await f();if(!y.ok||!y.data)return{ok:!1,error:y.error||"Unable to load state."};const D=y.data.read_score+o,U=y.data.watch_balance_minutes+c,{error:V}=await d.from("user_state").update({read_score:D,watch_balance_minutes:U,updated_at:new Date().toISOString()}).eq("user_id",r);return V?{ok:!1,error:V.message}:{ok:!0,data:{level:ee(D),readScore:D,watchBalanceMinutes:U}}},[i,f,d]),j=a.useCallback(async(e,n)=>{if(!i)return null;const r=await A(e,n);if(r.ok)return r.data??null;const o=await v(`${J}/event`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i.access_token}`},body:JSON.stringify({type:e,data:n})});return o.ok?o.body??null:null},[i,A,v]);a.useEffect(()=>{if(!d)return;d.auth.getSession().then(({data:r})=>O(r.session));const{data:e}=d.auth.onAuthStateChange((r,o)=>{O(o),o&&h(!1)}),n=r=>{(r==null?void 0:r.type)==="auth_complete"&&(d.auth.getSession().then(({data:o})=>{O(o.session),o.session&&L.current()}),h(!1)),(r==null?void 0:r.type)==="auth_signed_out"&&(O(null),h(!1),u(!0),m(!1))};return chrome.runtime.onMessage.addListener(n),()=>{e.subscription.unsubscribe(),chrome.runtime.onMessage.removeListener(n)}},[d]),a.useEffect(()=>{i||p(null)},[i]),a.useEffect(()=>{b(d?null:"Missing Supabase configuration.")},[]),a.useEffect(()=>{if(!s||!i)return;let e=0,n=null,r=!1;const o=async()=>{e+=1,!await _()&&!r&&e<3&&(n=window.setTimeout(o,1e3))};return o(),j("video_opened",{videoId:s}),()=>{r=!0,n!==null&&window.clearTimeout(n)}},[s,i,_,j]),a.useEffect(()=>{if(!s||!l||!i||!N||$.current===s)return;$.current=s,(async()=>{var r;const n=await v(`${J}/transcript`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({videoId:s})});if(n.ok&&((r=n.body)!=null&&r.transcript)){const o=n.body.source?` (${n.body.source})`:"";console.log(`[Intent] Transcript${o} for ${s}:
${n.body.transcript}`)}else console.warn(`[Intent] Transcript unavailable for ${s}.`)})()},[s,l,i,N,v]),a.useEffect(()=>{l&&T(e=>(e+1)%w.length)},[l,w.length]),a.useEffect(()=>{if(!l)return;let e=null;const n=()=>{e==null||e.pause()},r=()=>{const c=document.querySelector("video");if(!c){ue();return}e&&e!==c&&(e.removeEventListener("play",n),e.removeEventListener("playing",n)),e=c,e.autoplay=!1,e.addEventListener("play",n),e.addEventListener("playing",n),e.pause()};r();const o=new MutationObserver(r);return o.observe(document.body,{childList:!0,subtree:!0}),()=>{o.disconnect(),e&&(e.removeEventListener("play",n),e.removeEventListener("playing",n))}},[l,s]);const F=a.useCallback(async()=>{if(!i)return;u(!1),m(!1);const e=await j("watch_initiated",{minutes:10,videoId:s});e?p({level:e.level,readScore:e.readScore,watchBalanceMinutes:e.watchBalanceMinutes}):await _()},[j,s,i,_]),z=a.useCallback(async()=>{if(!i)return;m(!0);const e=await j("read_completed",{videoId:s});e?p({level:e.level,readScore:e.readScore,watchBalanceMinutes:e.watchBalanceMinutes}):await _()},[j,s,i,_]),S=a.useCallback(async()=>{var o;if(!d){b("Missing Supabase configuration.");return}h(!0);const e=(o=chrome.runtime)==null?void 0:o.getURL("auth.html"),{data:n,error:r}=await d.auth.signInWithOAuth({provider:"google",options:e?{redirectTo:e,skipBrowserRedirect:!0}:{skipBrowserRedirect:!0}});if(r||!(n!=null&&n.url)){b((r==null?void 0:r.message)||"Failed to start sign-in."),h(!1);return}try{chrome.runtime.sendMessage({type:"oauth_start",url:n.url},c=>{if(chrome.runtime.lastError){b(chrome.runtime.lastError.message),h(!1);return}c!=null&&c.ok||(b((c==null?void 0:c.error)||"OAuth failed."),h(!1))})}catch(c){b(c instanceof Error?c.message:"Extension runtime unavailable."),h(!1)}},[d]);return s?t.jsx(se,{isVisible:l,isLoading:M,isAuthenticated:!!i,authError:I,authInProgress:G,metrics:N,quote:w[P],onLogin:S,onReadFirst:z,onWatchNow:F}):null}function fe(){if(document.getElementById(Z))return;const s=document.createElement("div");s.id=Z,document.body.appendChild(s),ne(s).render(t.jsx(ae.StrictMode,{children:t.jsx(he,{})}))}fe();
