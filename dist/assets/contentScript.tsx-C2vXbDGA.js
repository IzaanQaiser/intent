import{r as n,j as e,c as ee,R as te}from"./client-DMp2t5-j.js";import{s as p}from"./supabaseClient-CWLpkwh3.js";const D=40,ne=5,V=10,$=10;function ae({isVisible:a,isLoading:o,metrics:i,quote:E,isAuthenticated:d,authError:I,authInProgress:M,onLogin:S,onReadFirst:b,onWatchNow:C}){if(!a)return null;const[h,L]=n.useState(0),[B,l]=n.useState(0),[g,O]=n.useState({left:0,width:0}),w=n.useRef(null),m=n.useRef(null),v=n.useRef(!1),f=n.useRef(null),F=n.useRef(0),A=n.useRef(null),t=n.useRef(null),r=5e3,s=120,u=140,c=n.useCallback(()=>{m.current!==null&&(cancelAnimationFrame(m.current),m.current=null),f.current!==null&&(cancelAnimationFrame(f.current),f.current=null),w.current=null,v.current=!1;const _=F.current;if(_<=0){L(0);return}const x=performance.now(),j=N=>{const y=N-x,R=Math.min(y/u,1),W=_*(1-R);if(L(W),R>=1){f.current=null;return}f.current=requestAnimationFrame(j)};f.current=requestAnimationFrame(j)},[]),z=n.useCallback(()=>{const _=performance.now();w.current=_,v.current=!1,f.current!==null&&(cancelAnimationFrame(f.current),f.current=null),L(0);const x=j=>{if(w.current===null)return;const N=j-w.current;let y=0;if(N<=s)y=N/s*.1;else{const R=N-s,W=r-s;y=.1+Math.min(R/W,1)*.9}if(L(y),y>=1&&!v.current){v.current=!0,C(),c();return}m.current=requestAnimationFrame(x)};m.current=requestAnimationFrame(x)},[C,c]);n.useEffect(()=>{F.current=h},[h]),n.useEffect(()=>{a||c()},[a,c]),n.useLayoutEffect(()=>{if(!d)return;const _=()=>{const j=A.current,N=t.current;if(!j||!N)return;const y=j.getBoundingClientRect(),R=N.getBoundingClientRect();l(y.width),O({left:Math.max(0,R.left-y.left),width:R.width})};_();const x=new ResizeObserver(_);return A.current&&x.observe(A.current),t.current&&x.observe(t.current),window.addEventListener("resize",_),()=>{x.disconnect(),window.removeEventListener("resize",_)}},[d]);const P=Math.floor(i.readScore/400)+1,T=Math.floor((i.readScore+D)/400)+1,k=i.watchBalanceMinutes-V,Y=k<0?i.readScore-$:i.readScore,q=Math.floor(Y/400)+1,J=T>P?"↑":"=",Q=k>=0?`${k} min`:`-${Math.abs(k)} min`,X=B*h,K=Math.max(0,Math.min(g.width,X-g.left)),Z=Math.max(0,K);return e.jsx("div",{className:"intent-overlay",children:e.jsxs("div",{className:"intent-overlay__panel",children:[e.jsx("div",{className:"intent-overlay__title",children:"Read First"}),e.jsx("div",{className:"intent-overlay__subtitle",children:E}),d?e.jsxs("div",{className:"intent-overlay__metrics",children:[e.jsxs("div",{className:"intent-overlay__metric",children:[e.jsx("span",{className:"intent-overlay__metric-label",children:"Level"}),e.jsx("span",{className:"intent-overlay__metric-value",children:P})]}),e.jsxs("div",{className:"intent-overlay__metric",children:[e.jsx("span",{className:"intent-overlay__metric-label",children:"Read Score"}),e.jsx("span",{className:"intent-overlay__metric-value",children:i.readScore})]}),e.jsxs("div",{className:"intent-overlay__metric",children:[e.jsx("span",{className:"intent-overlay__metric-label",children:"Watch Balance"}),e.jsxs("span",{className:"intent-overlay__metric-value",children:[i.watchBalanceMinutes," min"]})]})]}):e.jsxs("div",{className:"intent-overlay__auth",children:[e.jsx("div",{className:"intent-overlay__auth-title",children:"Sign in to continue"}),e.jsx("div",{className:"intent-overlay__auth-copy",children:"Your score and balance sync to your account. Sign in to proceed."}),e.jsx("button",{className:"intent-overlay__auth-button",type:"button",onClick:S,disabled:M,children:M?"Authenticating…":"Sign in with Google"})]}),d?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"intent-overlay__choice",children:[e.jsx("div",{className:"intent-overlay__choice-title",children:"Your Choice"}),e.jsxs("div",{className:"intent-overlay__choice-grid",children:[e.jsxs("div",{className:"intent-overlay__choice-card",children:[e.jsx("div",{className:"intent-overlay__choice-header",children:"Read Instead"}),e.jsxs("div",{className:"intent-overlay__choice-chips",children:[e.jsxs("span",{className:"intent-overlay__chip",children:["Score +",D]}),e.jsxs("span",{className:"intent-overlay__chip",children:["Watch Balance +",ne,"m"]}),e.jsxs("span",{className:"intent-overlay__chip",children:["Level ",T," ",J]})]}),e.jsx("div",{className:"intent-overlay__choice-note",children:"Reading restores progress."})]}),e.jsxs("div",{className:"intent-overlay__choice-card intent-overlay__choice-card--watch",children:[e.jsx("div",{className:"intent-overlay__choice-header",children:"Watch Now"}),e.jsxs("div",{className:"intent-overlay__choice-chips",children:[e.jsxs("span",{className:"intent-overlay__chip intent-overlay__chip--warn",children:["Watch Balance -",V,"m"]}),e.jsxs("span",{className:"intent-overlay__chip",children:["New Watch Balance ",Q]})]}),k<0?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"intent-overlay__choice-subline",children:["Score penalty -",$," (attention debt)"]}),e.jsx("div",{className:"intent-overlay__choice-subline",children:"Level progress paused while negative"}),q<P?e.jsxs("div",{className:"intent-overlay__choice-warning",children:["⚠️ Risk: Level down to ",q]}):null]}):e.jsx("div",{className:"intent-overlay__choice-subline",children:"No score penalty (balance stays non-negative)"})]})]})]}),e.jsxs("div",{className:"intent-overlay__actions",children:[e.jsx("button",{className:"intent-overlay__primary",type:"button",onClick:b,disabled:o,children:o?"Generating summary…":"Read Instead"}),e.jsxs("button",{className:"intent-overlay__secondary",type:"button",onPointerDown:z,onPointerUp:c,onPointerLeave:c,onPointerCancel:c,ref:A,children:[e.jsx("span",{className:"intent-overlay__hold-fill",style:{transform:`scaleX(${h})`}}),e.jsxs("span",{className:"intent-overlay__button-label intent-overlay__button-label--progress",children:[e.jsx("span",{ref:t,className:"intent-overlay__button-label-base",children:"Watch Now"}),e.jsx("span",{className:"intent-overlay__button-label-fill",style:{"--label-fill-px":`${Z}px`},children:"Watch Now"})]})]})]}),o?e.jsx("div",{className:"intent-overlay__loading",children:"Preparing a focused summary and key points…"}):null]}):null]})})}const G="intent-read-first-root",U="http://localhost:8787";function H(a){try{const o=new URL(a);return o.pathname!=="/watch"?null:o.searchParams.get("v")}catch{return null}}function se(){var i;const a=document.querySelector("video");if(a&&!a.paused&&a.pause(),a){a.autoplay=!1;return}const o=document.querySelector(".ytp-play-button");o&&((i=o.getAttribute("aria-label"))!=null&&i.toLowerCase().includes("pause"))&&o.click()}function re(){const[a,o]=n.useState(()=>H(window.location.href));return n.useEffect(()=>{const i=()=>o(H(window.location.href)),E=history.pushState,d=history.replaceState;history.pushState=function(...S){E.apply(this,S),i()},history.replaceState=function(...S){d.apply(this,S),i()},window.addEventListener("popstate",i);const I=new MutationObserver(i);I.observe(document.body,{childList:!0,subtree:!0});const M=window.setInterval(i,1e3);return()=>{history.pushState=E,history.replaceState=d,window.removeEventListener("popstate",i),I.disconnect(),window.clearInterval(M)}},[]),a}function ie(){const a=re(),[o,i]=n.useState(!0),[E,d]=n.useState(!1),[I,M]=n.useState(0),[S,b]=n.useState(null),[C,h]=n.useState(!1),[L,B]=n.useState({level:1,readScore:0,watchBalanceMinutes:0}),[l,g]=n.useState(null),O=n.useRef(a),w=n.useMemo(()=>["It is not enough to be busy; so are the ants. The question is: What are we busy about? — Henry David Thoreau","The successful warrior is the average man, with laser-like focus. — Bruce Lee","Concentrate all your thoughts upon the work in hand. — Alexander Graham Bell","Simplicity is the ultimate sophistication. — Leonardo da Vinci","A well-spent day brings happy sleep. — Leonardo da Vinci","Your focus determines your reality. — George Lucas"],[]);n.useEffect(()=>{a&&a!==O.current&&(O.current=a,i(!0),d(!1))},[a]);const m=n.useCallback(async()=>{if(!l)return;const t=await fetch(`${U}/state`,{headers:{Authorization:`Bearer ${l.access_token}`}});if(!t.ok)return;const r=await t.json();B({level:r.level,readScore:r.readScore,watchBalanceMinutes:r.watchBalanceMinutes})},[l]),v=n.useCallback(async(t,r)=>{if(!l)return null;const s=await fetch(`${U}/event`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l.access_token}`},body:JSON.stringify({type:t,data:r})});return s.ok?s.json():null},[l]);n.useEffect(()=>{if(!p)return;p.auth.getSession().then(({data:s})=>g(s.session));const{data:t}=p.auth.onAuthStateChange((s,u)=>{g(u),u&&h(!1)}),r=s=>{(s==null?void 0:s.type)==="auth_complete"&&(p.auth.getSession().then(({data:u})=>{g(u.session),u.session&&m()}),h(!1)),(s==null?void 0:s.type)==="auth_signed_out"&&(g(null),h(!1),i(!0),d(!1))};return chrome.runtime.onMessage.addListener(r),()=>{t.subscription.unsubscribe(),chrome.runtime.onMessage.removeListener(r)}},[p,m]),n.useEffect(()=>{b(p?null:"Missing Supabase configuration.")},[]),n.useEffect(()=>{!a||!l||(m(),v("video_opened",{videoId:a}))},[a,l,m,v]),n.useEffect(()=>{o&&M(t=>(t+1)%w.length)},[o,w.length]),n.useEffect(()=>{if(!o)return;let t=null;const r=()=>{t==null||t.pause()},s=()=>{const c=document.querySelector("video");if(!c){se();return}t&&t!==c&&(t.removeEventListener("play",r),t.removeEventListener("playing",r)),t=c,t.autoplay=!1,t.addEventListener("play",r),t.addEventListener("playing",r),t.pause()};s();const u=new MutationObserver(s);return u.observe(document.body,{childList:!0,subtree:!0}),()=>{u.disconnect(),t&&(t.removeEventListener("play",r),t.removeEventListener("playing",r))}},[o,a]);const f=n.useCallback(async()=>{if(!l)return;const t=await v("watch_initiated",{minutes:10,videoId:a});t&&B({level:t.level,readScore:t.readScore,watchBalanceMinutes:t.watchBalanceMinutes}),i(!1),d(!1)},[v,a,l]),F=n.useCallback(async()=>{if(!l)return;d(!0);const t=await v("read_completed",{videoId:a});t&&B({level:t.level,readScore:t.readScore,watchBalanceMinutes:t.watchBalanceMinutes})},[v,a,l]),A=n.useCallback(async()=>{var u;if(!p){b("Missing Supabase configuration.");return}h(!0);const t=(u=chrome.runtime)==null?void 0:u.getURL("auth.html"),{data:r,error:s}=await p.auth.signInWithOAuth({provider:"google",options:t?{redirectTo:t,skipBrowserRedirect:!0}:{skipBrowserRedirect:!0}});if(s||!(r!=null&&r.url)){b((s==null?void 0:s.message)||"Failed to start sign-in."),h(!1);return}chrome.runtime.sendMessage({type:"oauth_start",url:r.url},c=>{if(chrome.runtime.lastError){b(chrome.runtime.lastError.message),h(!1);return}c!=null&&c.ok||(b((c==null?void 0:c.error)||"OAuth failed."),h(!1))})},[p]);return a?e.jsx(ae,{isVisible:o,isLoading:E,isAuthenticated:!!l,authError:S,authInProgress:C,metrics:L,quote:w[I],onLogin:A,onReadFirst:F,onWatchNow:f}):null}function oe(){if(document.getElementById(G))return;const a=document.createElement("div");a.id=G,document.body.appendChild(a),ee(a).render(e.jsx(te.StrictMode,{children:e.jsx(ie,{})}))}oe();
