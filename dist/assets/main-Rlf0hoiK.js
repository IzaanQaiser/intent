import"./modulepreload-polyfill-B5Qt9EMX.js";import{r as l,j as e,c as ya,R as ba}from"./client-DMp2t5-j.js";import{s as q}from"./supabaseClient-DihBYOwf.js";const v=(n,c=1)=>new Intl.NumberFormat("en-US",{maximumFractionDigits:c}).format(n),I=(n,c=0)=>`${v(n*100,c)}%`,X=n=>{const c=n>=12?"pm":"am";return`${n%12===0?12:n%12}${c}`},Pe=n=>n.toLocaleDateString("en-US",{month:"short",day:"numeric"}),_e=n=>`${n} window${n===1?"":"s"}`,ja=n=>new Date(n).toLocaleString("en-US",{hour:"numeric",minute:"2-digit",second:"2-digit",month:"short",day:"numeric"}),ee=n=>n>0?`+${n}`:`${n}`,de=5,le=10,$e=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],_a=5e3,$a=3,Na=60,ka=14,De=10,Ne=5,Ve=5,Ye=12,Ma=.6,Ke={risk:"Risk Score",bypass:"Bypass Rate",negative:"Negative Balance"},Ca={risk:"Composite risk score derived from fast time-to-watch, bypass streaks, negative balance hits, and low read completion.",bypass:"Share of windows that went straight to watch instead of read (watch / (watch + read)).",negative:"Debt minutes per window computed as max(0, watch_count × 10 - read_count × 5). Higher means that hour drains balance faster."},Ra=n=>!Number.isFinite(n)||n===0?0:n>0?Math.ceil(n):-Math.ceil(Math.abs(n)),Sa=n=>{if(n==="watch_initiated")return"Watch initiated";if(n==="read_completed")return"Read completed";const c=n.replace(/_/g," ");return c.charAt(0).toUpperCase()+c.slice(1)},Ta=n=>{var p;const c=(p=n.metadata)==null?void 0:p.minutes;return typeof c=="number"&&Number.isFinite(c)?c:n.event_type==="read_completed"?de:n.event_type==="watch_initiated"?le:0},ze=n=>Math.max(0,Math.min(1,n)),Aa=(n,c)=>Math.ceil(n/c)*c,La=n=>{const c=ze(n),p=170-c*140,B=86-c*22;return`hsl(${Math.round(p)}, 45%, ${Math.round(B)}%)`},Ea=n=>Array.isArray(n)?n.filter(c=>typeof c=="string").map(c=>c.trim()).filter(Boolean):[],Ia=n=>{const c=Array.isArray(n)?n:[],p=B=>{const _=c.find(D=>D.toLowerCase().startsWith(B.toLowerCase()));return _?_.replace(new RegExp(`^${B}`,"i"),"").trim():null};return{evidence:p("Evidence:")??c[0]??"AI insight generated from your behavior stream.",weakness:p("Weak point:")??c[1]??"Review the top drivers from recent sessions.",action:p("Next step:")??c[2]??"Keep the read-first path active."}},Ge=(n,c,p)=>{const B=Array.from({length:7},()=>Array.from({length:24},()=>({sum:0,count:0})));let _=0,D=0;for(const d of n){const j=new Date(d.window_start),N=(j.getDay()+6)%7,k=j.getHours();let w=null;if(c==="risk"){if(d.risk_score===null)continue;w=d.risk_score}else if(c==="bypass"){const H=d.watch_initiated_count||0,W=d.read_completed_count||0,O=H+W;if(O===0)continue;w=H/O}else{const H=d.watch_initiated_count||0,W=d.read_completed_count||0;if(H+W===0)continue;w=Math.max(0,H*le-W*de)}const ae=B[N][k];ae.sum+=w,ae.count+=1,_+=w,D+=1}if(p){const d=p.watchCount,j=p.readCount,N=d+j;if(N>0){let k=0;if(c==="risk"){const ae=Math.min(1,d/Math.max(1,j)/2),H=Math.max(0,d*le-j*de),W=Math.min(1,H/(le*3));k=ze(ae*.65+W*.35)}else c==="bypass"?k=d/N:k=Math.max(0,d*le-j*de);const w=B[p.dayIndex][p.hour];w.sum+=k,w.count+=1,_+=k,D+=1}}let S={value:0,day:0,hour:0,count:0};const he=B.map((d,j)=>d.map((N,k)=>{const w=N.count?N.sum/N.count:0;return w>S.value&&(S={value:w,day:j,hour:k,count:N.count}),{value:w,count:N.count,intensity:0}})),ie=S.value;return{values:he.map(d=>d.map(j=>({...j,intensity:ie>0?j.value/ie:0}))),max:S,average:D>0?_/D:0,totalCount:D}},Ba=(n,c)=>c==="bypass"?`${Math.round(n*100)}%`:c==="negative"?`${v(n,1)} min`:v(n,2);function Da(){const[n,c]=l.useState({loading:!0,error:null,rows:[]}),[p,B]=l.useState(null),[_,D]=l.useState([]),[S,he]=l.useState(null),[ie,ue]=l.useState(!1),[d,j]=l.useState("risk"),[N,k]=l.useState(0),[w,ae]=l.useState(ka),[H,W]=l.useState(De),O=l.useCallback(async()=>{if(!q){c({loading:!1,error:"Missing Supabase config. Set VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY.",rows:[]});return}if(!ie){c(b=>({...b,loading:!0}));return}if(!(S!=null&&S.user)){c({loading:!1,error:"Sign in to view your dashboard.",rows:[]});return}c(b=>({...b,loading:!0,error:null}));const{data:a,error:s}=await q.from("user_state").select("read_score, watch_balance_minutes").eq("user_id",S.user.id).maybeSingle();s&&console.warn("[dashboard] Failed to load stream_state",s.message),B(a??null);const{data:t,error:i}=await q.from("feature_windows").select("*").eq("user_id_raw",S.user.id).order("window_start",{ascending:!1}).limit(200);if(i){c({loading:!1,error:i.message,rows:[]});return}const{data:o,error:r}=await q.from("risk_scores").select("*").eq("user_id_raw",S.user.id).order("window_start",{ascending:!1}).limit(200);if(r){c({loading:!1,error:r.message,rows:[]});return}const{data:g,error:y}=await q.from("action_events").select("id, event_type, occurred_at, metadata").eq("user_id_raw",S.user.id).order("occurred_at",{ascending:!1}).limit(200);y?(console.warn("[dashboard] Failed to load action_events",y.message),D([])):D(g??[]);const f=new Map;o==null||o.forEach(b=>{f.set(`${b.user_id}|${b.window_start}`,b)});const Q=(t==null?void 0:t.map(b=>{const K=`${b.user_id}|${b.window_start}`,m=f.get(K);return{...b,risk_score:(m==null?void 0:m.risk_score)??null,scored_at:(m==null?void 0:m.scored_at)??null,insight_summary:(m==null?void 0:m.insight_summary)??null,insight_bullets:Ea(m==null?void 0:m.insight_bullets),risk_source:(m==null?void 0:m.risk_source)??null,model:(m==null?void 0:m.model)??null}}))??[];c({loading:!1,error:null,rows:Q})},[ie,S]);l.useEffect(()=>{O()},[O]),l.useEffect(()=>{const a=()=>{document.hidden||O()};return document.addEventListener("visibilitychange",a),()=>{document.removeEventListener("visibilitychange",a)}},[O]),l.useEffect(()=>{const a=window.setInterval(()=>{O()},_a);return()=>window.clearInterval(a)},[O]),l.useEffect(()=>{if(!q){ue(!0);return}q.auth.getSession().then(({data:s})=>{he(s.session),ue(!0)});const{data:a}=q.auth.onAuthStateChange((s,t)=>{he(t),ue(!0)});return()=>{a.subscription.unsubscribe()}},[]);const u=l.useMemo(()=>n.rows,[n.rows]),V=l.useMemo(()=>{const a=new Date;return new Date(a.getFullYear(),a.getMonth(),a.getDate(),a.getHours(),0,0,0)},[n.rows,_]),me=l.useMemo(()=>new Date(V.getTime()+60*60*1e3),[V]),ke=l.useMemo(()=>{if(_.length===0)return null;let a=0,s=0;for(const t of _){const i=new Date(t.occurred_at);i<V||i>=me||(t.event_type==="watch_initiated"?a+=1:t.event_type==="read_completed"&&(s+=1))}return a+s===0?null:{dayIndex:(V.getDay()+6)%7,hour:V.getHours(),watchCount:a,readCount:s}},[_,V,me]),He=l.useMemo(()=>{if(u.length===0)return!1;const a=V.getTime(),s=me.getTime();return u.some(t=>{const i=new Date(t.window_start).getTime();return i>=a&&i<s})},[u,V,me]),T=l.useMemo(()=>ke&&!He?ke:null,[ke,He]),h=l.useMemo(()=>{const a=u.slice(0,24),s={videoOpened:0,summaryGenerated:0,summaryLatencyTotal:0,summaryLatencyCount:0,readCompleted:0,readTimeTotal:0,readTimeCount:0,watchInitiated:0,watchEnded:0,watchSecondsTotal:0,watchTimeSinceOpenTotal:0,watchTimeSinceOpenCount:0,negativeBalanceCount:0};for(const $ of a)s.videoOpened+=$.video_opened_count||0,s.summaryGenerated+=$.summary_generated_count||0,s.summaryLatencyTotal+=$.summary_latency_ms_total||0,s.summaryLatencyCount+=$.summary_latency_ms_count||0,s.readCompleted+=$.read_completed_count||0,s.readTimeTotal+=$.read_time_ms_total||0,s.readTimeCount+=$.read_time_ms_count||0,s.watchInitiated+=$.watch_initiated_count||0,s.watchEnded+=$.watch_ended_count||0,s.watchSecondsTotal+=$.watch_seconds_total||0,s.watchTimeSinceOpenTotal+=$.watch_time_since_open_ms_total||0,s.watchTimeSinceOpenCount+=$.watch_time_since_open_ms_count||0,s.negativeBalanceCount+=$.negative_balance_count||0;const t=s.watchInitiated,i=s.readCompleted,o=s.videoOpened,r=s.summaryGenerated,g=s.watchEnded,y=s.watchTimeSinceOpenCount>0?s.watchTimeSinceOpenTotal/s.watchTimeSinceOpenCount:null,f=s.watchSecondsTotal>0?s.watchSecondsTotal/60/Math.max(1,g||t):null,Q=s.readTimeCount>0?s.readTimeTotal/s.readTimeCount/6e4:null,b=s.summaryLatencyCount>0?s.summaryLatencyTotal/s.summaryLatencyCount:null,K=o>0?r/o:null,m=r>0?i/r:null,R=o>0?t/o:null,L=t>0?g/t:null,Z=t/Math.max(1,i),E=t>0?s.negativeBalanceCount/t:null;return{windowCount:a.length,watchCount:t,readCount:i,openCount:o,summaryCount:r,watchEnded:g,avgTimeToWatchMs:y,avgWatchMinutes:f,avgReadMinutes:Q,avgSummaryLatencyMs:b,summaryRate:K,readCompletionRate:m,watchStartRate:R,watchCompletionRate:L,watchToReadRatio:Z,negativeBalanceRate:E,negativeBalanceCount:s.negativeBalanceCount}},[u]),M=l.useMemo(()=>{const a=(p==null?void 0:p.read_score)??0,s=Math.floor(a/400)+1,t=(p==null?void 0:p.watch_balance_minutes)??0,i=(s-1)*400,o=Math.max(0,a-i),r=Math.min(100,o/400*100),g=Math.max(0,s*400-a);return{readScore:a,level:s,watchBalance:t,levelProgress:o,levelPercent:r,scoreToNext:g}},[p]),pe=M.watchBalance,Me=pe<0,se=Aa(Math.max(pe+Ne,De),Ne),oe=se+Ne*20,qe=l.useMemo(()=>{let a=0;for(const s of _){if(s.event_type==="watch_initiated")break;s.event_type==="read_completed"&&(a+=1)}return a},[_]),Xe=l.useMemo(()=>{const s=u.slice(0,7).reverse().map(i=>i.read_completed_count),t=Math.max(1,...s);return s.map(i=>Math.max(10,i/t*100))},[u]),F=l.useMemo(()=>{let a=0,s=0;const t=[0,0,0,0];for(const o of u){const r=o.watch_time_since_open_ms_count||0;if(!r)continue;const g=o.watch_time_since_open_ms_total/r;a+=o.watch_time_since_open_ms_total,s+=r,g<5e3?t[0]+=r:g<15e3?t[1]+=r:g<3e4?t[2]+=r:t[3]+=r}return{avgMs:s>0?a/s:null,buckets:t}},[u]);l.useMemo(()=>{const a=["<5s","5-15s","15-30s",">30s"],s=Math.max(1,...F.buckets);return a.map((t,i)=>({label:t,count:F.buckets[i],height:Math.max(8,F.buckets[i]/s*100)}))},[F.buckets]);const C=l.useMemo(()=>Ge(u,"risk"),[u]),x=l.useMemo(()=>Ge(u,d,T),[u,d,T]),ge=l.useMemo(()=>{if(u.length===0)return null;const a=u.map(i=>new Date(i.window_start).getTime()),s=new Date(Math.min(...a)),t=new Date(Math.max(...a));return{range:`${Pe(s)}–${Pe(t)}`,total:u.length}},[u]),re=l.useMemo(()=>{const a=Ke[d],s=Ca[d],t=ge?`Coverage: ${ge.range} (${ge.total} windows, local time).`:"Coverage: awaiting more windows.",i=T?`Live activity included for ${$e[T.dayIndex]} ${X(T.hour)}.`:"";if(x.totalCount===0)return{definition:s,coverage:i?`${t} ${i}`:t,meaning:`No ${a.toLowerCase()} data yet, so the grid is empty. As soon as a few windows stream in, you will see the time blocks that tend to spike or stay calm.`,suggestion:"Keep running a few sessions at different times of day so the model can compare patterns. Once data lands, use the highlighted hours to pre-plan a read-first flow or a watch delay.",footnote:`No ${a.toLowerCase()} windows yet.`};const o=$e[x.max.day],r=X(x.max.hour),g=`${x.totalCount} window${x.totalCount===1?"":"s"}`,y=x.average,f=x.max.value>0;if(d==="risk"){const R=v(x.max.value,2),L=v(y,2),Z=f?`Based on ${g}, risk peaks around ${o} ${r} at ${R} (avg ${L}). That time block is where fast watch decisions and balance pressure cluster most often.`:`Based on ${g}, risk stays low across tracked windows (avg ${L}). That suggests your routine is stable and there are no consistent danger hours yet.`;let E="Keep the read-first flow active during your usual hours. If you want to pressure test, add a short pause before Watch Now to keep choices deliberate.";return f&&(x.max.value>=.7?E=`Plan a read-first block 20 minutes before ${o} ${r} and delay Watch Now. Treat that window as a known hotspot: start with a summary, set a timer, and avoid autoplay until the urge passes.`:x.max.value>=.4?E=`Set a reminder to start with a summary before ${o} ${r}. The goal is to slow the initial jump so you can choose intentionally instead of sliding into a watch streak.`:E=`Add a light guardrail around ${o} ${r} (read-first + timer). You are mostly steady, so small nudges here should be enough to keep balance positive.`),{definition:s,coverage:i?`${t} ${i}`:t,meaning:Z,suggestion:E,footnote:f?`Highest risk appears around ${o} ${r}.`:"Risk stays flat across recent windows."}}if(d==="bypass"){const R=`${Math.round(x.max.value*100)}%`,L=`${Math.round(y*100)}%`,Z=f?`Based on ${g}, bypass rate peaks around ${o} ${r} at ${R} (avg ${L}). That means you are choosing watch over read most often in that slot.`:`Based on ${g}, bypass rate stays low across tracked windows (avg ${L}). You are generally choosing the read-first path before watching.`;let E="Keep the read-first step visible when opening content. A short summary or checklist at the entry point helps preserve the habit even on busy days.";return f&&(x.max.value>=.6?E=`Require a read or summary before watch around ${o} ${r}. If you still want to watch, set a small rule: one read first, then decide if the watch is still worth it.`:x.max.value>=.35?E=`Add a quick prompt before watch near ${o} ${r} to slow the jump. Even a 10-second pause helps you notice the impulse and choose a read-first path instead.`:E=`Maintain a light prompt around ${o} ${r} to avoid auto-bypasses. You are close to balanced, so a single nudge is usually enough.`),{definition:s,coverage:i?`${t} ${i}`:t,meaning:Z,suggestion:E,footnote:f?`Highest bypass rate appears around ${o} ${r}.`:"Bypass stays flat across recent windows."}}const Q=v(x.max.value,1),b=v(y,1),K=f?`Based on ${g}, debt minutes spike around ${o} ${r} at ${Q} min per window (avg ${b}). That hour is where watch sessions outpace reads the most.`:`Based on ${g}, debt minutes stay near zero (avg ${b}). Your read and watch habits are balanced across recent windows.`;let m="Balance looks stable; keep your current read cadence. If you want extra buffer, add a short read before longer watch sessions.";return f&&(x.max.value>=1.5?m=`Bank extra reads earlier on ${o} to offset the ${r} debt spike. Aim for two short reads before your typical watch window so the balance does not dip below zero.`:x.max.value>=.5?m=`Schedule a read-first block before ${o} ${r} to prevent balance dips. That buffer makes it harder to spiral into debt once the watch session starts.`:m=`Add a short read before ${o} ${r} to stay in surplus. You are close to balance, so a small pre-read keeps the window neutral.`),{definition:s,coverage:i?`${t} ${i}`:t,meaning:K,suggestion:m,footnote:f?`Highest negative balance appears around ${o} ${r}.`:"Negative balance stays flat across recent windows."}},[x,d,ge,T]),Y=l.useMemo(()=>{for(const a of u)if(a.insight_summary||a.insight_bullets&&a.insight_bullets.length>0)return a;return null},[u]),Ce=l.useMemo(()=>{const a=[],s=h.windowCount>0?`last ${h.windowCount}h`:"recent",t=h.watchCount,i=h.readCount,o=h.openCount,r=h.summaryCount,g=h.watchToReadRatio,y=v(g,2),f=h.watchStartRate!==null?I(h.watchStartRate,0):"n/a",Q=h.negativeBalanceRate!==null?I(h.negativeBalanceRate,0):"n/a",b=h.avgWatchMinutes!==null?`${v(h.avgWatchMinutes,1)} min`:"n/a",K=h.avgReadMinutes!==null?`${v(h.avgReadMinutes,1)} min`:"n/a",m=h.avgSummaryLatencyMs!==null?`${v(h.avgSummaryLatencyMs/1e3,1)}s`:"n/a",R=M.watchBalance,L=R<0?Math.ceil(Math.abs(R)/de):0,Z=Math.max(0,t-i),$=(R<0?`Current watch balance is ${ee(R)} minutes, and it would take ${L} read${L===1?"":"s"} to return to zero at your current pacing. `:`Current watch balance is ${ee(R)} minutes, which gives you a surplus buffer before debt. `)+`Over the ${s}, you logged ${o} opens, ${t} watch starts, and ${i} completed reads (watch-to-read ratio ${y}:1, watch start rate ${f}). `+(h.negativeBalanceCount>0?`Negative balance was triggered ${h.negativeBalanceCount} times (${Q} of watch starts).`:"No negative balance triggers were recorded in this window."),ua=R<0||h.watchToReadRatio>1.2?`Watch starts are outpacing reads (${t} vs ${i}), which is why the watch-to-read ratio is ${y}:1. `+(h.negativeBalanceCount>0?`That imbalance shows up as attention debt and ${h.negativeBalanceCount} negative balance triggers in the same window.`:"That imbalance is enough to push balance negative even before triggers appear."):`Reads are keeping pace with watch starts (${i} reads for ${t} watches), which keeps the ratio near ${y}:1. Debt pressure is contained because the cadence matches your recent volume.`,ma=R<0?`Complete ${L} read${L===1?"":"s"} to return to zero, then hold a 1:1 read-to-watch buffer. If your next ${s} looks like the last one (${t} watch starts), matching that with ${t} reads keeps you positive.`:h.watchToReadRatio>1.2?`Reduce the gap by adding about ${Z||1} extra reads across your next few sessions to bring the ratio back toward 1:1. That single change offsets the current watch volume without needing new product features.`:`Keep the read-first cadence and add one extra read before any long watch. Your recent ratio of ${y}:1 shows the balance is stable, so the goal is to sustain it.`;a.push({title:R<0?"Watch balance in debt":"Watch balance in surplus",evidence:$,weakness:ua,action:ma});const ce=h.summaryRate,te=h.readCompletionRate;let fe="Summary habits forming",we="Not enough summary activity to judge follow-through.",xe="Generate a summary on your next open to build signal.";if(h.openCount>0&&ce!==null)if(ce<.4)fe="Summary step skipped",we=`Only ${r} of ${o} opens generated a summary (${I(ce)}), so most sessions skip the read gate. That makes it harder to slow down a watch impulse with data.`,xe=`Aim to generate summaries on at least 60% of opens; with your recent volume, that means ${Math.max(1,Math.ceil(o*.6)-r)} more summaries in the next ${s}. This keeps the decision point earlier without changing any settings.`;else if(te!==null&&te<.5)fe="Summary reads drop off",we=`Summaries are generated (${r}), but only ${i} were completed (${I(te)}). That drop-off means the read step is being started but not finished.`,xe=`Commit to finishing one summary before Watch Now on your next few sessions. Pushing completion to 60% would mean about ${Math.max(1,Math.ceil(r*.6)-i)} more completed reads at your current summary volume.`;else{fe="Summary follow-through is strong",we=`Read completion is holding at ${I(te??0)} (${i} of ${r}). The remaining opportunity is to scale this across more opens.`;const z=Math.max(0,Math.ceil(o*.6)-r);xe=z>0?`Keep Read First as your default gate and expand coverage to more opens. If you add ${z} more summaries, the same completion rate keeps reads high.`:"Keep Read First as your default gate; summary coverage is already above 60% of opens. Focus on sustaining completion so the read habit stays strong."}const pa=h.openCount>0&&ce!==null?`In the ${s}, you opened ${o} videos and generated ${r} summaries (${I(ce)} of opens). Read completion is ${te!==null?I(te):"n/a"} with an average read time of ${K}, and summary latency averages ${m}.`:"No summary activity recorded in the selected window.";a.push({title:fe,evidence:pa,weakness:we,action:xe});const Fe=F.buckets.reduce((z,Be)=>z+Be,0),G=Fe>0?F.buckets[0]/Fe:null,U=h.avgTimeToWatchMs!==null?Math.round(h.avgTimeToWatchMs/1e3):null;let ye="Impulse timing forming",be="Not enough watch timing data yet.",je="Log a few watch sessions to unlock timing insights.";U!==null&&(U<15?(ye="Fast watch pivot",be=`Watch starts are happening quickly (avg ${U}s), which leaves little time for a summary check. Fast starts under 5s account for ${G!==null?I(G):"n/a"} of watch starts.`,je="When the impulse hits under 15s, open the summary first and commit to a 2-minute read. Raising time-to-watch above 30s will lower the fast-start share and reduce impulsive pivots."):U<30?(ye="Moderate watch pivot",be=`There is some pause (avg ${U}s), but watch still starts relatively quickly. You still see ${G!==null?I(G):"n/a"} of watch starts under 5s.`,je="Use the summary as a decision gate on every open before Watch Now. Try to keep time-to-watch above 30s on your next few sessions to push the average up."):(ye="Deliberate watch starts",be=`You are already pausing before watch (avg ${U}s), which reduces impulsive pivots. Fast starts under 5s are limited to ${G!==null?I(G):"n/a"} of sessions.`,je="Keep the pre-watch pause and make Read First the default on high-risk hours. This keeps time-to-watch elevated while you maintain your current watch volume."));const ga=U!==null?`Average time from open to watch is ${U}s across ${t} watch starts in the ${s}. Fast starts under 5s account for ${G!==null?I(G):"n/a"}, and watch completion is ${h.watchCompletionRate!==null?I(h.watchCompletionRate):"n/a"}.`:"Waiting for watch timing data.";a.push({title:ye,evidence:ga,weakness:be,action:je});const ne=C.max.value>0?C.max.hour:null,va=C.max.value>0?$e[C.max.day]:null,fa=C.totalCount>0?v(C.average,2):"n/a",wa=v(Math.max(0,C.max.value-C.average),2);if(a.push({title:ne!==null?`Peak risk window: ${va} ${X(ne)}`:"Risk window forming",evidence:ne!==null?`Highest risk averages ${v(C.max.value,2)} across ${C.max.count} windows. Baseline risk across ${C.totalCount} scored windows is ${fa}, so this window sits ${wa} above average.`:"Collecting more scored windows for timing. Once risk scores land, this will highlight the highest-risk hour.",weakness:ne!==null?`That hour shows the most consistent risk spikes relative to your baseline. Even when overall risk is stable, this slot remains the peak in the last ${s}.`:"Need more scored windows to detect timing risk. Keep streaming events to build the hourly pattern.",action:ne!==null?`Schedule a read-first block 30-60 minutes before ${X(ne)} and avoid watch-first in that window. If you expect to watch, complete one read beforehand to offset the peak-risk slot.`:"Keep streaming events to sharpen timing insights and populate this window."}),Y!=null&&Y.insight_summary){const z=Ia(Y.insight_bullets),Be=typeof Y.risk_score=="number"?`Latest scored risk is ${v(Y.risk_score,2)}. `:"",xa=o>0?`Data used: ${o} opens, ${r} summaries, ${i} reads, and ${t} watch starts over the ${s}. Average read time is ${K} and average watch session is ${b}.`:"Data volume is thin in this window, so insights are directional.";a.push({title:Y.insight_summary,evidence:`${z.evidence} ${Be}${xa}`,weakness:`${z.weakness} This aligns with a watch-to-read ratio of ${y}:1 and ${h.negativeBalanceCount} negative balance triggers in the ${s}.`,action:`${z.action} Given your recent volume (${t} watches vs ${i} reads), a 1:1 ratio is the fastest lever to pull.`})}else a.push({title:"AI insight incoming",evidence:`No Vertex insight has been generated yet. Data in the ${s} includes ${o} opens, ${r} summaries, ${i} reads, and ${t} watches, which will feed the model once scored.`,weakness:"No Vertex insights are available yet, so weakpoints are inferred from aggregates only. Run the scorer to turn these events into a personalized narrative.",action:"Keep streaming events and run the scorer to unlock long-form insights. Once scored, the AI card will include evidence, weakpoint, and next-step guidance."});return a},[F.buckets,h,Y,M.watchBalance,C.average,C.max,C.totalCount]),A=Ce.length,J=Math.min(N,Math.max(0,A-1));l.useEffect(()=>{J!==N&&k(J)},[J,N]);const Je=l.useCallback(()=>{k(a=>A<=1?0:(a-1+A)%A)},[A]),Qe=l.useCallback(()=>{k(a=>A<=1?0:(a+1)%A)},[A]),Re=l.useMemo(()=>{let a=0,s=0;for(const t of u)a+=t.read_time_ms_total||0,s+=t.read_time_ms_count||0;return s>0?a/s/6e4:null},[u]);l.useEffect(()=>{W(a=>a<se?se:a>oe?oe:a)},[se,oe]);const Ze=l.useMemo(()=>_.slice(0,Ye).map(a=>{const s=Ta(a),t=Ra(a.event_type==="read_completed"?s:a.event_type==="watch_initiated"?-s:0),i=t>0?"Intentional":t<0?"Impulsive":"Mixed",o=i.toLowerCase();return{id:a.id,time:ja(a.occurred_at),action:Sa(a.event_type),balanceDelta:t,balanceLabel:ee(t),outcome:i,outcomeKey:o}}),[_]),ea=M.watchBalance<0?"card stat-card stat-card--balance stat-card--debt":"card stat-card stat-card--balance",aa=Math.round(M.levelPercent),Se=Me?De:Math.min(Math.max(H,se),oe),Oe=Math.max(0,Se-pe),Te=Re??Ve,We=w>0?Oe/w:0,sa=Te>0?We/Te:0,ta=Me?"Target fixed at +10 min while in debt.":"Choose a higher target to grow your buffer.",na=Re?`Average read length: ${v(Re,1)} min.`:`Assumes ${Ve} min/read until more data arrives.`,ve=l.useMemo(()=>{for(const a of u)if(a.risk_score!==null)return a.risk_score;return null},[u]),Ae=l.useMemo(()=>{let a=0;for(const s of u)if(s.negative_balance_count>0)a+=1;else break;return a},[u]),Le=l.useMemo(()=>{let a=0;for(const s of u){const t=s.watch_initiated_count||0,i=s.read_completed_count||0;if(t>i)a+=1;else break}return a},[u]),Ee=ve!==null?v(ve,2):"--",Ie=F.avgMs!==null?`${Math.round(F.avgMs/1e3)}s`:"--",ia=u[0]?u[0].watch_initiated_count>0?"watch":"search":"--",oa=X(new Date().getHours()),P=ve!==null&&ve>=Ma,ra=P?"High risk detected":"Low risk",ca=P?`Active because risk score is ${Ee}${Ie!=="--"?` and watch starts around ${Ie}`:""}.`:"Arms when risk score spikes or watch starts are fast.",la=P?`Active because risk score is ${Ee}${Ae>0?` and balance dipped for ${_e(Ae)}`:""}.`:"Arms when risk is high or balance turns negative.",da=P?`Active because risk is high${Le>0?` and bypass streak hit ${_e(Le)}`:""}.`:"Arms when autoplay drives most recent debt sessions.",ha=[{id:"decision-delay",name:"Decision Delay",active:P,enabled:!0,reason:ca,action:"Insert a temporary delay with a read-first countdown prompt.",affects:"Watch button, Autoplay start",effectiveness:"Prevented debt in 74% of recent activations",settings:[{label:"Delay length",value:"10s"},{label:"Scope",value:"High-risk windows only"},{label:"Applies to",value:"All videos"}]},{id:"read-first",name:"Read-First Default",active:P,enabled:!0,reason:la,action:"Open read-first panel by default while watch stays available.",affects:"Initial UI state only",effectiveness:"Reading first is 3x more effective late at night",settings:[{label:"Apply to",value:"Shorts + recommended"},{label:"Minimum read time",value:"20s before Watch is highlighted"},{label:"Mode",value:"Soft default, no delay"}]},{id:"autoplay-guard",name:"Autoplay Guard",active:P,enabled:!0,reason:da,action:"Pause autoplay during vulnerable windows with a neutral message.",affects:"Autoplay continuation only",effectiveness:"Most debt sessions start from autoplay for you",settings:[{label:"Time rule",value:"After 11 PM"},{label:"Context",value:"Shorts + watch page"},{label:"Auto-resume",value:"Off during high-risk windows"}]}];return e.jsxs("div",{className:"app",children:[e.jsx("header",{className:"dashboard-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Intent Analytics"}),e.jsx("h1",{children:"Attention, scored in real time."}),e.jsx("p",{className:"subtitle",children:"Stream events into Confluent, transform them into behavior signals, then score risk windows for the dashboard."})]})}),n.error?e.jsxs("div",{className:"card error-card",children:[e.jsx("h3",{children:"Dashboard offline"}),e.jsx("p",{children:n.error})]}):null,e.jsxs("section",{className:"stat-row",children:[e.jsx("div",{className:"card stat-card stat-card--level",children:e.jsxs("div",{className:"stat-header",children:[e.jsxs("div",{className:"stat-level-row",children:[e.jsxs("div",{className:"stat-stack",children:[e.jsx("p",{className:"stat-label",children:"Level"}),e.jsx("div",{className:"stat-value",children:M.level})]}),e.jsx("div",{className:"stat-ring",style:{"--progress":`${M.levelPercent}`},children:e.jsxs("span",{children:[aa,"%"]})})]}),e.jsxs("div",{className:"level-progress",children:[e.jsxs("div",{className:"level-progress__title",children:["Progress to Level ",M.level+1]}),e.jsx("div",{className:"level-progress__bar",children:e.jsx("span",{style:{width:`${M.levelPercent}%`}})}),e.jsxs("div",{className:"level-progress__meta",children:[M.levelProgress," / 400 points"]})]})]})}),e.jsxs("div",{className:"card stat-card stat-card--read",children:[e.jsx("p",{className:"stat-label",children:"Read Score"}),e.jsx("div",{className:"stat-value",children:M.readScore}),e.jsx("div",{className:"stat-spark",children:Xe.map((a,s)=>e.jsx("span",{style:{height:`${a}%`}},`spark-${s}`))}),e.jsxs("div",{className:"read-callout",children:[e.jsx("div",{className:"read-callout__title",children:"Keep Reading to Level Up!"}),e.jsxs("div",{className:"read-callout__body",children:["Only ",M.scoreToNext," more points needed. Read more articles to boost your score and unlock new achievements."]})]})]}),e.jsxs("div",{className:ea,children:[e.jsx("p",{className:"stat-label",children:"Watch Balance"}),e.jsxs("div",{className:"stat-value",children:[ee(M.watchBalance)," min"]}),e.jsx("p",{className:"stat-meta",children:M.watchBalance<0?"In debt":"In surplus"})]}),e.jsxs("div",{className:"card stat-card",children:[e.jsx("p",{className:"stat-label",children:"Current Read Streak"}),e.jsx("div",{className:"stat-value",children:qe}),e.jsx("p",{className:"stat-meta",children:"Consecutive reads build your streak, watches break it."})]})]}),e.jsx("section",{className:"section-heading section-heading--insights",children:e.jsxs("div",{className:"section-heading__row",children:[e.jsxs("div",{children:[e.jsx("h2",{children:"AI Insights"}),e.jsx("p",{children:"Data-backed guidance, no judgment"})]}),e.jsx("div",{className:"insight-counter",children:A>0?`${J+1} of ${A}`:"0 of 0"})]})}),e.jsxs("section",{className:"insight-carousel","aria-label":"AI insights carousel",children:[e.jsx("div",{className:"insight-track",style:{transform:`translateX(-${J*100}%)`},children:Ce.map((a,s)=>e.jsx("div",{className:"insight-slide",children:e.jsxs("div",{className:"card insight-tile",children:[e.jsx("h3",{children:a.title}),e.jsxs("div",{className:"insight-block",children:[e.jsx("span",{children:"Evidence"}),e.jsx("p",{children:a.evidence})]}),e.jsxs("div",{className:"insight-block insight-block--weakness",children:[e.jsx("span",{children:"Weak point"}),e.jsx("p",{children:a.weakness})]}),e.jsxs("div",{className:"insight-block insight-block--action",children:[e.jsx("span",{children:"Next step"}),e.jsx("p",{children:a.action})]})]})},`insight-${s}`))}),e.jsxs("div",{className:"insight-nav",children:[e.jsx("button",{type:"button",className:"insight-arrow",onClick:Je,"aria-label":"Previous insight",disabled:A<=1,children:"‹"}),e.jsx("div",{className:"insight-dots",role:"tablist","aria-label":"Insight slides",children:Ce.map((a,s)=>e.jsx("button",{type:"button",className:`insight-dot ${s===J?"insight-dot--active":""}`,onClick:()=>k(s),"aria-label":`Go to insight ${s+1}`,"aria-pressed":s===J},`insight-dot-${s}`))}),e.jsx("button",{type:"button",className:"insight-arrow",onClick:Qe,"aria-label":"Next insight",disabled:A<=1,children:"›"})]})]}),e.jsxs("section",{className:"section-heading",children:[e.jsx("h2",{children:"Risk & Pattern Analysis"}),e.jsx("p",{children:"Hour of day x day of week analysis"})]}),e.jsxs("section",{className:"card section-card",children:[e.jsxs("div",{className:"panel-header",children:[e.jsx("div",{}),e.jsxs("div",{className:"heatmap-controls",children:[e.jsxs("div",{className:"toggle-group",children:[e.jsx("button",{className:`toggle ${d==="risk"?"toggle--active":""}`,type:"button",onClick:()=>j("risk"),"aria-pressed":d==="risk",children:"Risk Score"}),e.jsx("button",{className:`toggle ${d==="bypass"?"toggle--active":""}`,type:"button",onClick:()=>j("bypass"),"aria-pressed":d==="bypass",children:"Bypass Rate"}),e.jsx("button",{className:`toggle ${d==="negative"?"toggle--active":""}`,type:"button",onClick:()=>j("negative"),"aria-pressed":d==="negative",children:"Negative Balance"})]}),e.jsxs("div",{className:"heatmap-legend",children:[e.jsx("span",{children:"Low"}),e.jsx("div",{className:"heatmap-legend__bar"}),e.jsx("span",{children:"High"})]}),e.jsx("div",{className:"heatmap-legend__note",children:"Darker = more extreme"})]})]}),e.jsxs("div",{className:"heatmap-layout",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"heatmap",children:[e.jsxs("div",{className:"heatmap-header",children:[e.jsx("span",{}),Array.from({length:24},(a,s)=>e.jsx("span",{children:X(s)},`hour-${s}`))]}),$e.map((a,s)=>e.jsxs("div",{className:"heatmap-row",children:[e.jsx("span",{className:"heatmap-day",children:a}),x.values[s].map((t,i)=>{const o=Ba(t.value,d),r=t.count?` (${t.count} window${t.count===1?"":"s"})`:"",g=Ke[d].toLowerCase(),y=t.count===0,f=(T==null?void 0:T.dayIndex)===s&&(T==null?void 0:T.hour)===i;return e.jsx("span",{className:`heatmap-cell${y?" heatmap-cell--empty":""}${f?" heatmap-cell--live":""}`,style:{backgroundColor:y?void 0:La(t.intensity)},title:y?`${a} ${X(i)} - no data`:`${a} ${X(i)} - ${g} ${o}${r}${f?" (live activity)":""}`},`${a}-${i}`)})]},a))]}),e.jsx("div",{className:"heatmap-footnote",children:re.footnote})]}),e.jsxs("aside",{className:"heatmap-panel",children:[e.jsxs("div",{className:"heatmap-panel__section",children:[e.jsx("div",{className:"heatmap-panel__title",children:"Metric definition"}),e.jsx("p",{children:re.definition})]}),e.jsxs("div",{className:"heatmap-panel__section",children:[e.jsx("div",{className:"heatmap-panel__title",children:"What this means"}),e.jsx("p",{children:re.meaning})]}),e.jsxs("div",{className:"heatmap-panel__section heatmap-panel__section--accent",children:[e.jsx("div",{className:"heatmap-panel__title",children:"AI suggestion"}),e.jsx("p",{children:re.suggestion})]}),e.jsx("div",{className:"heatmap-panel__footnote",children:re.coverage})]})]})]}),e.jsxs("section",{className:"section-heading",children:[e.jsx("h2",{children:"Addiction Mechanics"}),e.jsx("p",{children:"Making the habit visible and explainable"})]}),e.jsxs("section",{className:"grid-two",children:[e.jsxs("div",{className:"card panel failsafe-panel",children:[e.jsxs("div",{className:"panel-header failsafe-header",children:[e.jsxs("div",{children:[e.jsx("h3",{children:"Vulnerability Failsafes"}),e.jsx("span",{className:"panel-subtitle",children:"Protective actions during high-risk moments"})]}),e.jsx("span",{className:`status-badge${P?" status-badge--alert":" status-badge--calm"}`,children:ra})]}),e.jsx("p",{className:"failsafe-summary",children:"A user-controlled safety system that activates soft, reversible protections when vulnerability rises. It does not block content or auto-decide; it simply biases the environment so you can choose better in the moment."}),e.jsxs("div",{className:"failsafe-signal-card",children:[e.jsxs("div",{className:"failsafe-signal-header",children:[e.jsx("span",{children:"Signals in play"}),e.jsx("span",{className:"failsafe-signal-note",children:"Computed, not raw events"})]}),e.jsxs("div",{className:"failsafe-chip-row",children:[e.jsx("span",{className:"chip",children:"risk_score"}),e.jsx("span",{className:"chip",children:"time_to_watch_ms"}),e.jsx("span",{className:"chip",children:"negative_balance_streak"}),e.jsx("span",{className:"chip",children:"bypass_streak"}),e.jsx("span",{className:"chip",children:"page_type"}),e.jsx("span",{className:"chip",children:"hour_of_day"})]}),e.jsxs("div",{className:"failsafe-signal-grid",children:[e.jsxs("div",{className:"failsafe-signal",children:[e.jsx("span",{children:"Risk score"}),e.jsx("strong",{children:Ee})]}),e.jsxs("div",{className:"failsafe-signal",children:[e.jsx("span",{children:"Time to watch"}),e.jsx("strong",{children:Ie})]}),e.jsxs("div",{className:"failsafe-signal",children:[e.jsx("span",{children:"Negative balance streak"}),e.jsx("strong",{children:_e(Ae)})]}),e.jsxs("div",{className:"failsafe-signal",children:[e.jsx("span",{children:"Bypass streak"}),e.jsx("strong",{children:_e(Le)})]}),e.jsxs("div",{className:"failsafe-signal",children:[e.jsx("span",{children:"Page type"}),e.jsx("strong",{children:ia})]}),e.jsxs("div",{className:"failsafe-signal",children:[e.jsx("span",{children:"Hour of day"}),e.jsx("strong",{children:oa})]})]}),e.jsx("div",{className:"failsafe-signal-footnote",children:"Logic fires first. The LLM only explains after activation."})]}),P?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"failsafe-list",children:ha.map(a=>e.jsxs("div",{className:`failsafe-row${a.active?" failsafe-row--active":""}`,children:[e.jsxs("div",{className:"failsafe-row__top",children:[e.jsxs("div",{children:[e.jsx("h4",{children:a.name}),e.jsx("span",{className:`failsafe-status${a.active?" failsafe-status--active":""}`,children:a.active?"Active":"Inactive"})]}),e.jsxs("label",{className:"failsafe-switch","aria-label":`${a.name} toggle`,children:[e.jsx("input",{type:"checkbox",checked:a.enabled,readOnly:!0}),e.jsx("span",{className:"failsafe-slider"})]})]}),e.jsx("p",{className:"failsafe-reason",children:a.reason}),e.jsxs("div",{className:"failsafe-meta",children:[e.jsxs("div",{children:[e.jsx("span",{children:"Action"}),e.jsx("strong",{children:a.action})]}),e.jsxs("div",{children:[e.jsx("span",{children:"Affects"}),e.jsx("strong",{children:a.affects})]}),e.jsxs("div",{children:[e.jsx("span",{children:"Effectiveness"}),e.jsx("strong",{children:a.effectiveness})]})]}),e.jsxs("details",{className:"failsafe-settings",children:[e.jsx("summary",{children:"Settings"}),e.jsx("div",{className:"failsafe-settings__grid",children:a.settings.map(s=>e.jsxs("div",{children:[e.jsx("span",{children:s.label}),e.jsx("strong",{children:s.value})]},`${a.id}-${s.label}`))})]})]},a.id))}),e.jsxs("div",{className:"failsafe-stack",children:[e.jsx("div",{className:"failsafe-section-title",children:"Failsafe stacking"}),e.jsxs("div",{className:"failsafe-stack__body",children:[e.jsxs("ol",{children:[e.jsx("li",{children:"Decision Delay"}),e.jsx("li",{children:"Read-First Default"}),e.jsx("li",{children:"Autoplay Guard"})]}),e.jsx("p",{children:"Delay + read-first can coexist. Autoplay guard is independent."})]})]}),e.jsxs("div",{className:"failsafe-events",children:[e.jsx("div",{className:"failsafe-section-title",children:"Events emitted"}),e.jsxs("div",{className:"failsafe-chip-row",children:[e.jsx("span",{className:"chip chip--event",children:"failsafe_armed"}),e.jsx("span",{className:"chip chip--event",children:"failsafe_triggered"}),e.jsx("span",{className:"chip chip--event",children:"failsafe_dismissed"}),e.jsx("span",{className:"chip chip--event",children:"failsafe_effective"})]})]})]}):e.jsx("div",{className:"failsafe-collapsed",children:"No failsafes needed right now."})]}),e.jsxs("div",{className:"grid-two__stack",children:[e.jsxs("div",{className:"card panel recovery-card",children:[e.jsxs("div",{className:"panel-header",children:[e.jsx("h3",{children:"Recovery Profile"}),e.jsx("span",{className:"panel-meta",children:"How quickly you can bounce back"})]}),e.jsxs("div",{className:"recovery-plan",children:[e.jsxs("div",{className:"recovery-status",children:[e.jsxs("div",{className:"recovery-stat",children:[e.jsx("span",{children:"Current balance"}),e.jsxs("strong",{children:[ee(pe)," min"]})]}),e.jsxs("div",{className:"recovery-stat",children:[e.jsx("span",{children:"Target balance"}),e.jsxs("strong",{children:[ee(Se)," min"]})]}),e.jsxs("div",{className:"recovery-stat",children:[e.jsx("span",{children:"Balance gap"}),e.jsxs("strong",{children:[v(Oe,1)," min"]})]})]}),e.jsxs("div",{className:"recovery-controls",children:[e.jsxs("label",{className:"range-field",children:[e.jsxs("div",{className:"range-title",children:[e.jsx("span",{children:"Days to recover"}),e.jsxs("strong",{children:[w," days"]})]}),e.jsx("input",{type:"range",min:$a,max:Na,value:w,onChange:a=>ae(Number(a.target.value))})]}),Me?null:e.jsxs("label",{className:"range-field",children:[e.jsxs("div",{className:"range-title",children:[e.jsx("span",{children:"Target watch balance"}),e.jsxs("strong",{children:[ee(Se)," min"]})]}),e.jsx("input",{type:"range",min:se,max:oe,step:Ne,value:H,onChange:a=>W(Number(a.target.value))})]})]}),e.jsxs("div",{className:"recovery-note",children:[e.jsxs("strong",{children:["Read about ",v(We,1)," min/day for ",w," days."]}),e.jsxs("span",{children:["About ",v(sa,1)," reads/day at ~",v(Te,1)," min/read."]}),e.jsx("span",{children:na}),e.jsx("span",{children:ta})]})]})]}),e.jsxs("section",{className:"card table-card session-log-card",children:[e.jsxs("div",{className:"panel-header",children:[e.jsx("h3",{children:"Session Log"}),e.jsxs("span",{className:"panel-meta",children:["Last ",Ye," actions with exact timestamps"]})]}),e.jsxs("div",{className:"table session-table",children:[e.jsxs("div",{className:"table-row header",children:[e.jsx("span",{children:"Time"}),e.jsx("span",{children:"Action"}),e.jsx("span",{children:"Balance +/-"}),e.jsx("span",{children:"Analysis"})]}),Ze.map(a=>e.jsxs("div",{className:"table-row",children:[e.jsx("span",{children:a.time}),e.jsx("span",{children:a.action}),e.jsx("span",{className:a.balanceDelta<0?"negative":"positive",children:a.balanceLabel}),e.jsx("span",{className:`pill outcome outcome-${a.outcomeKey}`,children:a.outcome})]},`session-${a.id}`))]})]})]})]})]})}const Ue=document.getElementById("root");Ue&&ya(Ue).render(e.jsx(ba.StrictMode,{children:e.jsx(Da,{})}));
