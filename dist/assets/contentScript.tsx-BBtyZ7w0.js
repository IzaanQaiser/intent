import{j as n,r,c as ge,R as xe}from"./client-DMp2t5-j.js";import{s as d}from"./supabaseClient-DihBYOwf.js";const le=10;function Ne({isVisible:a,isLoading:i,metrics:u,watchCostMinutes:m,readGainMinutes:f,readScoreGain:M,watchScorePenalty:R,quote:L,isAuthenticated:h,authError:oe,authInProgress:g,onLogin:G,onReadFirst:O,onWatchNow:l}){if(!a)return null;if(h&&!u)return n.jsx("div",{className:"intent-overlay",children:n.jsxs("div",{className:"intent-overlay__panel",children:[n.jsx("div",{className:"intent-overlay__title",children:"Read First"}),n.jsx("div",{className:"intent-overlay__subtitle",children:L}),n.jsx("div",{className:"intent-overlay__loading",children:"Syncing your watch balance…"})]})});const p=u??{readScore:0,watchBalanceMinutes:0},[b,F]=r.useState(0),[X,Y]=r.useState(0),[z,J]=r.useState({left:0,width:0}),[$,U]=r.useState(!1),I=r.useRef(null),w=r.useRef(null),j=r.useRef(!1),S=r.useRef(null),x=r.useRef(0),E=r.useRef(null),N=r.useRef(null),H=r.useRef(null),ee=5e3,V=120,e=140,t=2e3,s=r.useCallback(()=>{w.current!==null&&(cancelAnimationFrame(w.current),w.current=null),S.current!==null&&(cancelAnimationFrame(S.current),S.current=null),I.current=null,j.current=!1;const y=x.current;if(y<=0){F(0);return}const A=performance.now(),D=C=>{const k=C-A,q=Math.min(k/e,1),ae=y*(1-q);if(F(ae),q>=1){S.current=null;return}S.current=requestAnimationFrame(D)};S.current=requestAnimationFrame(D)},[]),o=r.useCallback(()=>{E.current!==null&&(window.clearTimeout(E.current),E.current=null),U(!1)},[]),c=r.useCallback(()=>{E.current!==null&&window.clearTimeout(E.current),E.current=window.setTimeout(()=>{U(!0)},t)},[]),_=r.useCallback(()=>{const y=performance.now();I.current=y,j.current=!1,S.current!==null&&(cancelAnimationFrame(S.current),S.current=null),F(0);const A=D=>{if(I.current===null)return;const C=D-I.current;let k=0;if(C<=V)k=C/V*.1;else{const q=C-V,ae=ee-V;k=.1+Math.min(q/ae,1)*.9}if(F(k),k>=1&&!j.current){j.current=!0,l(),s(),o();return}w.current=requestAnimationFrame(A)};w.current=requestAnimationFrame(A)},[l,s,o]),W=r.useCallback(()=>{_(),c()},[_,c]),T=r.useCallback(()=>{s(),o()},[s,o]);r.useEffect(()=>{x.current=b},[b]),r.useEffect(()=>{a||s()},[a,s]),r.useEffect(()=>o,[o]),r.useLayoutEffect(()=>{if(!h)return;const y=()=>{const D=N.current,C=H.current;if(!D||!C)return;const k=D.getBoundingClientRect(),q=C.getBoundingClientRect();Y(k.width),J({left:Math.max(0,q.left-k.left),width:q.width})};y();const A=new ResizeObserver(y);return N.current&&A.observe(N.current),H.current&&A.observe(H.current),window.addEventListener("resize",y),()=>{A.disconnect(),window.removeEventListener("resize",y)}},[h]);const v=Math.floor(p.readScore/400)+1,P=Math.floor((p.readScore+M)/400)+1,B=v*400,te=Math.max(0,B-p.readScore),Q=p.watchBalanceMinutes-m,fe=p.readScore-R-(Q<0?le:0),K=Math.floor(fe/400)+1,_e=P>v?"↑":"-",ve=K<v?"↓":"-",ne=y=>Number.isInteger(y)?String(y):y.toFixed(1),ye=Q>=0?`${Q} min`:`-${Math.abs(Q)} min`,re=p.watchBalanceMinutes+f,ce=ne(f),pe=re>=0?`+${ne(re)}m`:`-${ne(Math.abs(re))}m`,ie=i?"Generating Summary...":`Read Instead (Watch Balance +${ce}m)`,be=X*b,we=Math.max(0,Math.min(z.width,be-z.left)),Se=Math.max(0,we);return n.jsx("div",{className:"intent-overlay",children:n.jsxs("div",{className:"intent-overlay__panel",children:[n.jsxs("div",{className:`intent-overlay__content${$?" intent-overlay__content--dim":""}`,children:[n.jsx("div",{className:"intent-overlay__title",children:"Read First"}),n.jsx("div",{className:"intent-overlay__subtitle",children:L}),h?n.jsxs("div",{className:"intent-overlay__metrics",children:[n.jsxs("div",{className:"intent-overlay__metric",children:[n.jsx("span",{className:"intent-overlay__metric-label",children:"Level"}),n.jsx("span",{className:"intent-overlay__metric-value",children:v})]}),n.jsxs("div",{className:"intent-overlay__metric",children:[n.jsx("span",{className:"intent-overlay__metric-label",children:"Read Score"}),n.jsx("span",{className:"intent-overlay__metric-value",children:u.readScore})]}),n.jsxs("div",{className:"intent-overlay__metric",children:[n.jsx("span",{className:"intent-overlay__metric-label",children:"Watch Balance"}),n.jsxs("span",{className:"intent-overlay__metric-value",children:[p.watchBalanceMinutes," min"]})]})]}):n.jsxs("div",{className:"intent-overlay__auth",children:[n.jsx("div",{className:"intent-overlay__auth-title",children:"Sign in to continue"}),n.jsx("div",{className:"intent-overlay__auth-copy",children:"Your score and balance sync to your account. Sign in to proceed."}),n.jsx("button",{className:"intent-overlay__auth-button",type:"button",onClick:G,disabled:g,children:g?"Authenticating…":"Sign in with Google"})]}),h?n.jsxs("div",{className:"intent-overlay__choice",children:[n.jsx("div",{className:"intent-overlay__choice-title",children:"Your Choice"}),n.jsxs("div",{className:"intent-overlay__choice-grid",children:[n.jsxs("div",{className:"intent-overlay__choice-card intent-overlay__choice-card--watch",children:[n.jsx("div",{className:"intent-overlay__choice-header",children:"Watch Now"}),n.jsxs("div",{className:"intent-overlay__choice-chips",children:[n.jsxs("span",{className:"intent-overlay__chip intent-overlay__chip--warn",children:["Score -",R]}),n.jsxs("span",{className:"intent-overlay__chip intent-overlay__chip--warn",children:["Watch Balance -",m,"m"]}),n.jsxs("span",{className:"intent-overlay__chip intent-overlay__chip--highlight",children:["New Watch Balance ",ye]}),n.jsxs("span",{className:"intent-overlay__chip",children:["Level ",K," ",ve]})]}),Q<0?n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"intent-overlay__choice-subline",children:["Additional score penalty -",le," (attention debt)"]}),n.jsx("div",{className:"intent-overlay__choice-subline",children:"Level progress paused while negative"}),K<v?n.jsxs("div",{className:"intent-overlay__choice-warning",children:["⚠️ Risk: Level down to ",K]}):null]}):null]}),n.jsxs("div",{className:"intent-overlay__choice-card intent-overlay__choice-card--read",children:[n.jsx("div",{className:"intent-overlay__choice-header",children:"Read Instead"}),n.jsxs("div",{className:"intent-overlay__choice-chips",children:[n.jsxs("span",{className:"intent-overlay__chip",children:["Score +",M]}),n.jsxs("span",{className:"intent-overlay__chip",children:["Watch Balance +",ce,"m"]}),n.jsxs("span",{className:"intent-overlay__chip intent-overlay__chip--highlight",children:["New Watch Balance ",pe]}),n.jsxs("span",{className:"intent-overlay__chip",children:["Level ",P," ",_e]})]}),n.jsxs("div",{className:"intent-overlay__choice-note intent-overlay__choice-note--progress",children:[n.jsxs("span",{className:"intent-overlay__choice-note-label",children:["Level ",v+1," in"]}),n.jsx("span",{className:"intent-overlay__choice-note-score",children:te}),n.jsx("span",{className:"intent-overlay__choice-note-unit",children:"pts"})]})]})]})]}):null]}),h?n.jsxs("div",{className:"intent-overlay__actions",children:[n.jsxs("button",{className:"intent-overlay__secondary",type:"button",onPointerDown:W,onPointerUp:T,onPointerLeave:T,onPointerCancel:T,ref:N,children:[n.jsx("span",{className:"intent-overlay__hold-fill",style:{transform:`scaleX(${b})`}}),n.jsxs("span",{className:"intent-overlay__button-label intent-overlay__button-label--progress",children:[n.jsxs("span",{ref:H,className:"intent-overlay__button-label-base",children:["Watch Now (Watch Balance -",m,"m)"]}),n.jsxs("span",{className:"intent-overlay__button-label-fill",style:{"--label-fill-px":`${Se}px`},children:["Watch Now (Watch Balance -",m,"m)"]})]})]}),n.jsxs("button",{className:`intent-overlay__primary intent-overlay__primary--read${i?" intent-overlay__primary--read-active":""}`,type:"button",onClick:O,disabled:i,children:[n.jsx("span",{className:"intent-overlay__press-fill"}),n.jsxs("span",{className:`intent-overlay__button-label intent-overlay__button-label--progress${i?" intent-overlay__button-label--loading":""}`,children:[n.jsx("span",{className:"intent-overlay__button-label-base",children:ie}),n.jsx("span",{className:"intent-overlay__button-label-fill",children:ie})]})]})]}):null,n.jsxs("div",{className:`intent-overlay__motto${$?" intent-overlay__motto--visible":""}`,children:[n.jsx("span",{className:"intent-overlay__motto-red",children:"Old ways"}),n.jsx("span",{className:"intent-overlay__motto-neutral",children:" dont open "}),n.jsx("span",{className:"intent-overlay__motto-green",children:"new doors"})]})]})})}const ue="intent-read-first-root",se="http://127.0.0.1:8787",me=40,je=5,Z=10,Ee=10,de=a=>Math.floor(a/400)+1,ke=30;function he(a){try{const i=new URL(a);return i.pathname!=="/watch"?null:i.searchParams.get("v")}catch{return null}}function Me(){var u;const a=document.querySelector("video");if(a&&!a.paused&&a.pause(),a){a.autoplay=!1;return}const i=document.querySelector(".ytp-play-button");i&&((u=i.getAttribute("aria-label"))!=null&&u.toLowerCase().includes("pause"))&&i.click()}function Re(a){const i=Math.floor(a),u=Math.floor(i/3600),m=Math.floor(i%3600/60),f=i%60;return(u>0?[u,m,f]:[m,f]).map(R=>String(R).padStart(2,"0")).join(":")}function Le(a){return Number.isFinite(a)?Math.round(a*2/10)*10:me}function Ie(a){if(!a||!Number.isFinite(a))return Z;const i=Math.max(0,a),u=Math.floor(i/60);return i%60>=ke?u+1:u}function Te(){const[a,i]=r.useState(()=>he(window.location.href));return r.useEffect(()=>{const u=()=>i(he(window.location.href)),m=history.pushState,f=history.replaceState;history.pushState=function(...L){m.apply(this,L),u()},history.replaceState=function(...L){f.apply(this,L),u()},window.addEventListener("popstate",u);const M=new MutationObserver(u);M.observe(document.body,{childList:!0,subtree:!0});const R=window.setInterval(u,1e3);return()=>{history.pushState=m,history.replaceState=f,window.removeEventListener("popstate",u),M.disconnect(),window.clearInterval(R)}},[]),a}function Be(){const a=Te(),[i,u]=r.useState(!0),[m,f]=r.useState(!1),[M,R]=r.useState(0),[L,h]=r.useState(null),[oe,g]=r.useState(!1),[G,O]=r.useState(null),[l,p]=r.useState(null),[b,F]=r.useState(Z),X=r.useRef(a),Y=r.useRef(null),z=r.useRef(async()=>!1),J=r.useMemo(()=>b/2,[b]),$=r.useMemo(()=>Le(b),[b]),U=$,I=r.useMemo(()=>["It is not enough to be busy; so are the ants. The question is: What are we busy about? — Henry David Thoreau","The successful warrior is the average man, with laser-like focus. — Bruce Lee","Concentrate all your thoughts upon the work in hand. — Alexander Graham Bell","Simplicity is the ultimate sophistication. — Leonardo da Vinci","A well-spent day brings happy sleep. — Leonardo da Vinci","Your focus determines your reality. — George Lucas"],[]),w=r.useCallback(async(e,t)=>new Promise(s=>{var o;if(!((o=chrome==null?void 0:chrome.runtime)!=null&&o.sendMessage)){s({ok:!1,error:"Extension runtime unavailable."});return}try{chrome.runtime.sendMessage({type:"api_request",url:e,init:t},c=>{if(chrome.runtime.lastError){s({ok:!1,error:chrome.runtime.lastError.message});return}s(c)})}catch(c){s({ok:!1,error:c instanceof Error?c.message:String(c)})}}),[]),j=r.useCallback(async()=>{var _;if(!d)return{ok:!1,error:"Supabase client not configured."};const e=(_=l==null?void 0:l.user)==null?void 0:_.id;if(!e)return{ok:!1,error:"Supabase session unavailable."};const{data:t,error:s}=await d.from("user_state").select("user_id, read_score, watch_balance_minutes").eq("user_id",e).maybeSingle();if(s)return{ok:!1,error:s.message};if(t)return{ok:!0,data:t};const{data:o,error:c}=await d.from("user_state").insert({user_id:e,read_score:0,watch_balance_minutes:0}).select("user_id, read_score, watch_balance_minutes").single();return c||!o?{ok:!1,error:(c==null?void 0:c.message)||"Failed to create watch balance state."}:{ok:!0,data:o}},[l,d]),S=r.useCallback(async()=>{const e=await j();if(!e.ok)return{ok:!1,error:e.error};const t=e.data;return{ok:!0,data:{level:de(t.read_score),readScore:t.read_score,watchBalanceMinutes:t.watch_balance_minutes}}},[j]);r.useEffect(()=>{a&&a!==X.current&&(X.current=a,u(!0),f(!1),F(Z),Y.current=null)},[a]),r.useEffect(()=>{if(!i||!a)return;let e=null;const t=()=>{const c=e?e.duration:null;F(Ie(c))},s=()=>{const c=document.querySelector("video");if(!c){t();return}e&&e!==c&&(e.removeEventListener("loadedmetadata",t),e.removeEventListener("durationchange",t)),e=c,t(),e.addEventListener("loadedmetadata",t),e.addEventListener("durationchange",t)};s();const o=new MutationObserver(s);return o.observe(document.body,{childList:!0,subtree:!0}),()=>{o.disconnect(),e&&(e.removeEventListener("loadedmetadata",t),e.removeEventListener("durationchange",t))}},[i,a]);const x=r.useCallback(async()=>{if(!l)return!1;const e=await S();if(e.ok&&e.data)return O(e.data),!0;const t=await w(`${se}/state`,{headers:{Authorization:`Bearer ${l.access_token}`}});if(!t.ok||!t.body)return!1;const s=t.body;return O({level:s.level,readScore:s.readScore,watchBalanceMinutes:s.watchBalanceMinutes}),!0},[l,S,w]);r.useEffect(()=>{z.current=x},[x]);const E=r.useCallback(async(e,t)=>{var P;if(!d)return{ok:!1,error:"Supabase client not configured."};const s=(P=l==null?void 0:l.user)==null?void 0:P.id;if(!s)return{ok:!1,error:"Supabase session unavailable."};let o=0,c=0;switch(e){case"read_completed":o+=typeof(t==null?void 0:t.score)=="number"?t.score:me,c+=typeof(t==null?void 0:t.minutes)=="number"?t.minutes:je;break;case"watch_initiated":{const B=typeof(t==null?void 0:t.minutes)=="number"?t.minutes:Z;c-=B;const te=typeof(t==null?void 0:t.score)=="number"?t.score:0;o-=te;break}case"session_end":{const B=await j();if(!B.ok||!B.data)return{ok:!1,error:B.error||"Unable to load state."};B.data.watch_balance_minutes<0&&(o-=Ee);break}default:return{ok:!0,data:null}}const _=await j();if(!_.ok||!_.data)return{ok:!1,error:_.error||"Unable to load state."};const W=_.data.read_score+o,T=_.data.watch_balance_minutes+c,{error:v}=await d.from("user_state").update({read_score:W,watch_balance_minutes:T,updated_at:new Date().toISOString()}).eq("user_id",s);return v?{ok:!1,error:v.message}:{ok:!0,data:{level:de(W),readScore:W,watchBalanceMinutes:T}}},[l,j,d]),N=r.useCallback(async(e,t)=>{if(!l)return null;const s=await E(e,t);if(s.ok)return s.data??null;const o=await w(`${se}/event`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l.access_token}`},body:JSON.stringify({type:e,data:t})});return o.ok?o.body??null:null},[l,E,w]);r.useEffect(()=>{if(!d)return;d.auth.getSession().then(({data:s})=>p(s.session));const{data:e}=d.auth.onAuthStateChange((s,o)=>{p(o),o&&g(!1)}),t=s=>{(s==null?void 0:s.type)==="auth_complete"&&(d.auth.getSession().then(({data:o})=>{p(o.session),o.session&&z.current()}),g(!1)),(s==null?void 0:s.type)==="auth_signed_out"&&(p(null),g(!1),u(!0),f(!1))};return chrome.runtime.onMessage.addListener(t),()=>{e.subscription.unsubscribe(),chrome.runtime.onMessage.removeListener(t)}},[d]),r.useEffect(()=>{l||O(null)},[l]),r.useEffect(()=>{h(d?null:"Missing Supabase configuration.")},[]),r.useEffect(()=>{if(!a||!l)return;let e=0,t=null,s=!1;const o=async()=>{e+=1,!await x()&&!s&&e<3&&(t=window.setTimeout(o,1e3))};return o(),N("video_opened",{videoId:a}),()=>{s=!0,t!==null&&window.clearTimeout(t)}},[a,l,x,N]),r.useEffect(()=>{if(!a||!i||!l||!G||Y.current===a)return;Y.current=a,(async()=>{var s,o,c;const t=await w(`${se}/transcript`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({videoId:a})});if(t.ok&&((s=t.body)!=null&&s.transcript)){const _=t.body.source?` (${t.body.source})`:"",W=`https://www.youtube.com/watch?v=${a}`,T=((c=(o=document.querySelector("h1 yt-formatted-string"))==null?void 0:o.textContent)==null?void 0:c.trim())||document.title.replace(/\s+-\s+YouTube$/i,"").trim()||"Unknown",v=document.querySelector("video"),P=v&&Number.isFinite(v.duration)?Re(v.duration):"Unknown";console.log(`[Intent]
URL: ${W}
LENGTH: ${P}
TITLE: ${T}
TRANSCRIPT:${_}
${t.body.transcript}`)}else console.warn(`[Intent] Transcript unavailable for ${a}.`)})()},[a,i,l,G,w]),r.useEffect(()=>{i&&R(e=>(e+1)%I.length)},[i,I.length]),r.useEffect(()=>{if(!i)return;let e=null;const t=()=>{e==null||e.pause()},s=()=>{const c=document.querySelector("video");if(!c){Me();return}e&&e!==c&&(e.removeEventListener("play",t),e.removeEventListener("playing",t)),e=c,e.autoplay=!1,e.addEventListener("play",t),e.addEventListener("playing",t),e.pause()};s();const o=new MutationObserver(s);return o.observe(document.body,{childList:!0,subtree:!0}),()=>{o.disconnect(),e&&(e.removeEventListener("play",t),e.removeEventListener("playing",t))}},[i,a]);const H=r.useCallback(async()=>{if(!l)return;u(!1),f(!1);const e=await N("watch_initiated",{minutes:b,videoId:a,score:U});e?O({level:e.level,readScore:e.readScore,watchBalanceMinutes:e.watchBalanceMinutes}):await x()},[N,a,l,x,b,U]),ee=r.useCallback(async()=>{if(!l)return;f(!0);const e=await N("read_completed",{videoId:a,minutes:J,score:$});e?O({level:e.level,readScore:e.readScore,watchBalanceMinutes:e.watchBalanceMinutes}):await x()},[N,a,l,x,J,$]),V=r.useCallback(async()=>{var o;if(!d){h("Missing Supabase configuration.");return}g(!0);const e=(o=chrome.runtime)==null?void 0:o.getURL("auth.html"),{data:t,error:s}=await d.auth.signInWithOAuth({provider:"google",options:e?{redirectTo:e,skipBrowserRedirect:!0}:{skipBrowserRedirect:!0}});if(s||!(t!=null&&t.url)){h((s==null?void 0:s.message)||"Failed to start sign-in."),g(!1);return}try{chrome.runtime.sendMessage({type:"oauth_start",url:t.url},c=>{if(chrome.runtime.lastError){h(chrome.runtime.lastError.message),g(!1);return}c!=null&&c.ok||(h((c==null?void 0:c.error)||"OAuth failed."),g(!1))})}catch(c){h(c instanceof Error?c.message:"Extension runtime unavailable."),g(!1)}},[d]);return a?n.jsx(Ne,{isVisible:i,isLoading:m,isAuthenticated:!!l,authError:L,authInProgress:oe,metrics:G,watchCostMinutes:b,readGainMinutes:J,readScoreGain:$,watchScorePenalty:U,quote:I[M],onLogin:V,onReadFirst:ee,onWatchNow:H}):null}function Ae(){if(document.getElementById(ue))return;const a=document.createElement("div");a.id=ue,document.body.appendChild(a),ge(a).render(n.jsx(xe.StrictMode,{children:n.jsx(Be,{})}))}Ae();
