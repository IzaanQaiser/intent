import{j as n,r as a,c as he,R as me}from"./client-DMp2t5-j.js";import{s as h}from"./supabaseClient-DihBYOwf.js";const re=10;function fe({isVisible:r,isLoading:i,metrics:u,watchCostMinutes:m,readGainMinutes:f,readScoreGain:M,watchScorePenalty:L,quote:I,isAuthenticated:_,authError:ne,authInProgress:g,onLogin:V,onReadFirst:O,onWatchNow:l}){if(!r)return null;if(_&&!u)return n.jsx("div",{className:"intent-overlay",children:n.jsxs("div",{className:"intent-overlay__panel",children:[n.jsx("div",{className:"intent-overlay__title",children:"Read First"}),n.jsx("div",{className:"intent-overlay__subtitle",children:I}),n.jsx("div",{className:"intent-overlay__loading",children:"Syncing your watch balance…"})]})});const p=u??{readScore:0,watchBalanceMinutes:0},[b,W]=a.useState(0),[J,G]=a.useState(0),[H,Y]=a.useState({left:0,width:0}),j=a.useRef(null),E=a.useRef(null),B=a.useRef(!1),d=a.useRef(null),A=a.useRef(0),$=a.useRef(null),v=a.useRef(null),Q=5e3,S=120,K=140,R=a.useCallback(()=>{E.current!==null&&(cancelAnimationFrame(E.current),E.current=null),d.current!==null&&(cancelAnimationFrame(d.current),d.current=null),j.current=null,B.current=!1;const y=A.current;if(y<=0){W(0);return}const C=performance.now(),P=F=>{const k=F-C,q=Math.min(k/K,1),ee=y*(1-q);if(W(ee),q>=1){d.current=null;return}d.current=requestAnimationFrame(P)};d.current=requestAnimationFrame(P)},[]),Z=a.useCallback(()=>{const y=performance.now();j.current=y,B.current=!1,d.current!==null&&(cancelAnimationFrame(d.current),d.current=null),W(0);const C=P=>{if(j.current===null)return;const F=P-j.current;let k=0;if(F<=S)k=F/S*.1;else{const q=F-S,ee=Q-S;k=.1+Math.min(q/ee,1)*.9}if(W(k),k>=1&&!B.current){B.current=!0,l(),R();return}E.current=requestAnimationFrame(C)};E.current=requestAnimationFrame(C)},[l,R]);a.useEffect(()=>{A.current=b},[b]),a.useEffect(()=>{r||R()},[r,R]),a.useLayoutEffect(()=>{if(!_)return;const y=()=>{const P=$.current,F=v.current;if(!P||!F)return;const k=P.getBoundingClientRect(),q=F.getBoundingClientRect();G(k.width),Y({left:Math.max(0,q.left-k.left),width:q.width})};y();const C=new ResizeObserver(y);return $.current&&C.observe($.current),v.current&&C.observe(v.current),window.addEventListener("resize",y),()=>{C.disconnect(),window.removeEventListener("resize",y)}},[_]);const e=Math.floor(p.readScore/400)+1,t=Math.floor((p.readScore+M)/400)+1,s=e*400,c=Math.max(0,s-p.readScore),o=p.watchBalanceMinutes-m,w=p.readScore-L-(o<0?re:0),T=Math.floor(w/400)+1,D=t>e?"↑":"=",x=y=>Number.isInteger(y)?String(y):y.toFixed(1),U=o>=0?`${o} min`:`-${Math.abs(o)} min`,N=p.watchBalanceMinutes+f,z=x(f),ie=N>=0?`+${x(N)}m`:`-${x(Math.abs(N))}m`,le=J*b,ue=Math.max(0,Math.min(H.width,le-H.left)),de=Math.max(0,ue);return n.jsx("div",{className:"intent-overlay",children:n.jsxs("div",{className:"intent-overlay__panel",children:[n.jsx("div",{className:"intent-overlay__title",children:"Read First"}),n.jsx("div",{className:"intent-overlay__subtitle",children:I}),_?n.jsxs("div",{className:"intent-overlay__metrics",children:[n.jsxs("div",{className:"intent-overlay__metric",children:[n.jsx("span",{className:"intent-overlay__metric-label",children:"Level"}),n.jsx("span",{className:"intent-overlay__metric-value",children:e})]}),n.jsxs("div",{className:"intent-overlay__metric",children:[n.jsx("span",{className:"intent-overlay__metric-label",children:"Read Score"}),n.jsx("span",{className:"intent-overlay__metric-value",children:u.readScore})]}),n.jsxs("div",{className:"intent-overlay__metric",children:[n.jsx("span",{className:"intent-overlay__metric-label",children:"Watch Balance"}),n.jsxs("span",{className:"intent-overlay__metric-value",children:[p.watchBalanceMinutes," min"]})]})]}):n.jsxs("div",{className:"intent-overlay__auth",children:[n.jsx("div",{className:"intent-overlay__auth-title",children:"Sign in to continue"}),n.jsx("div",{className:"intent-overlay__auth-copy",children:"Your score and balance sync to your account. Sign in to proceed."}),n.jsx("button",{className:"intent-overlay__auth-button",type:"button",onClick:V,disabled:g,children:g?"Authenticating…":"Sign in with Google"})]}),_?n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"intent-overlay__choice",children:[n.jsx("div",{className:"intent-overlay__choice-title",children:"Your Choice"}),n.jsxs("div",{className:"intent-overlay__choice-grid",children:[n.jsxs("div",{className:"intent-overlay__choice-card intent-overlay__choice-card--watch",children:[n.jsx("div",{className:"intent-overlay__choice-header",children:"Watch Now"}),n.jsxs("div",{className:"intent-overlay__choice-chips",children:[n.jsxs("span",{className:"intent-overlay__chip intent-overlay__chip--warn",children:["Score -",L]}),n.jsxs("span",{className:"intent-overlay__chip intent-overlay__chip--warn",children:["Watch Balance -",m,"m"]}),n.jsxs("span",{className:"intent-overlay__chip intent-overlay__chip--highlight",children:["New Watch Balance ",U]})]}),o<0?n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"intent-overlay__choice-subline",children:["Additional score penalty -",re," (attention debt)"]}),n.jsx("div",{className:"intent-overlay__choice-subline",children:"Level progress paused while negative"}),T<e?n.jsxs("div",{className:"intent-overlay__choice-warning",children:["⚠️ Risk: Level down to ",T]}):null]}):n.jsx("div",{className:"intent-overlay__choice-subline",children:"No additional score penalty (balance stays non-negative)"})]}),n.jsxs("div",{className:"intent-overlay__choice-card intent-overlay__choice-card--read",children:[n.jsx("div",{className:"intent-overlay__choice-header",children:"Read Instead"}),n.jsxs("div",{className:"intent-overlay__choice-chips",children:[n.jsxs("span",{className:"intent-overlay__chip",children:["Score +",M]}),n.jsxs("span",{className:"intent-overlay__chip",children:["Watch Balance +",z,"m"]}),n.jsxs("span",{className:"intent-overlay__chip intent-overlay__chip--highlight",children:["New Watch Balance ",ie]}),n.jsxs("span",{className:"intent-overlay__chip",children:["Level ",t," ",D]})]}),n.jsxs("div",{className:"intent-overlay__choice-note intent-overlay__choice-note--progress",children:[n.jsxs("span",{className:"intent-overlay__choice-note-label",children:["Level ",e+1," in"]}),n.jsx("span",{className:"intent-overlay__choice-note-score",children:c}),n.jsx("span",{className:"intent-overlay__choice-note-unit",children:"pts"})]})]})]})]}),n.jsxs("div",{className:"intent-overlay__actions",children:[n.jsxs("button",{className:"intent-overlay__secondary",type:"button",onPointerDown:Z,onPointerUp:R,onPointerLeave:R,onPointerCancel:R,ref:$,children:[n.jsx("span",{className:"intent-overlay__hold-fill",style:{transform:`scaleX(${b})`}}),n.jsxs("span",{className:"intent-overlay__button-label intent-overlay__button-label--progress",children:[n.jsxs("span",{ref:v,className:"intent-overlay__button-label-base",children:["Watch Now (Watch Balance -",m,"m)"]}),n.jsxs("span",{className:"intent-overlay__button-label-fill",style:{"--label-fill-px":`${de}px`},children:["Watch Now (Watch Balance -",m,"m)"]})]})]}),n.jsxs("button",{className:`intent-overlay__primary intent-overlay__primary--read${i?" intent-overlay__primary--read-active":""}`,type:"button",onClick:O,disabled:i,children:[n.jsx("span",{className:"intent-overlay__press-fill"}),n.jsxs("span",{className:"intent-overlay__button-label intent-overlay__button-label--progress",children:[n.jsx("span",{className:"intent-overlay__button-label-base",children:i?"Generating summary…":`Read Instead (Watch Balance +${z}m)`}),n.jsx("span",{className:"intent-overlay__button-label-fill",children:i?"Generating summary…":`Read Instead (Watch Balance +${z}m)`})]})]})]}),i?n.jsx("div",{className:"intent-overlay__loading",children:"Preparing a focused summary and key points…"}):null]}):null]})})}const ae="intent-read-first-root",te="http://127.0.0.1:8787",ce=40,_e=5,X=10,ve=10,se=r=>Math.floor(r/400)+1,ye=30;function oe(r){try{const i=new URL(r);return i.pathname!=="/watch"?null:i.searchParams.get("v")}catch{return null}}function pe(){var u;const r=document.querySelector("video");if(r&&!r.paused&&r.pause(),r){r.autoplay=!1;return}const i=document.querySelector(".ytp-play-button");i&&((u=i.getAttribute("aria-label"))!=null&&u.toLowerCase().includes("pause"))&&i.click()}function be(r){const i=Math.floor(r),u=Math.floor(i/3600),m=Math.floor(i%3600/60),f=i%60;return(u>0?[u,m,f]:[m,f]).map(L=>String(L).padStart(2,"0")).join(":")}function we(r){return Number.isFinite(r)?Math.round(r*2/10)*10:ce}function ge(r){if(!r||!Number.isFinite(r))return X;const i=Math.max(0,r),u=Math.floor(i/60);return i%60>=ye?u+1:u}function Se(){const[r,i]=a.useState(()=>oe(window.location.href));return a.useEffect(()=>{const u=()=>i(oe(window.location.href)),m=history.pushState,f=history.replaceState;history.pushState=function(...I){m.apply(this,I),u()},history.replaceState=function(...I){f.apply(this,I),u()},window.addEventListener("popstate",u);const M=new MutationObserver(u);M.observe(document.body,{childList:!0,subtree:!0});const L=window.setInterval(u,1e3);return()=>{history.pushState=m,history.replaceState=f,window.removeEventListener("popstate",u),M.disconnect(),window.clearInterval(L)}},[]),r}function xe(){const r=Se(),[i,u]=a.useState(!0),[m,f]=a.useState(!1),[M,L]=a.useState(0),[I,_]=a.useState(null),[ne,g]=a.useState(!1),[V,O]=a.useState(null),[l,p]=a.useState(null),[b,W]=a.useState(X),J=a.useRef(r),G=a.useRef(null),H=a.useRef(async()=>!1),Y=a.useMemo(()=>b/2,[b]),j=a.useMemo(()=>we(b),[b]),E=j,B=a.useMemo(()=>["It is not enough to be busy; so are the ants. The question is: What are we busy about? — Henry David Thoreau","The successful warrior is the average man, with laser-like focus. — Bruce Lee","Concentrate all your thoughts upon the work in hand. — Alexander Graham Bell","Simplicity is the ultimate sophistication. — Leonardo da Vinci","A well-spent day brings happy sleep. — Leonardo da Vinci","Your focus determines your reality. — George Lucas"],[]),d=a.useCallback(async(e,t)=>new Promise(s=>{var c;if(!((c=chrome==null?void 0:chrome.runtime)!=null&&c.sendMessage)){s({ok:!1,error:"Extension runtime unavailable."});return}try{chrome.runtime.sendMessage({type:"api_request",url:e,init:t},o=>{if(chrome.runtime.lastError){s({ok:!1,error:chrome.runtime.lastError.message});return}s(o)})}catch(o){s({ok:!1,error:o instanceof Error?o.message:String(o)})}}),[]),A=a.useCallback(async()=>{var w;if(!h)return{ok:!1,error:"Supabase client not configured."};const e=(w=l==null?void 0:l.user)==null?void 0:w.id;if(!e)return{ok:!1,error:"Supabase session unavailable."};const{data:t,error:s}=await h.from("user_state").select("user_id, read_score, watch_balance_minutes").eq("user_id",e).maybeSingle();if(s)return{ok:!1,error:s.message};if(t)return{ok:!0,data:t};const{data:c,error:o}=await h.from("user_state").insert({user_id:e,read_score:0,watch_balance_minutes:0}).select("user_id, read_score, watch_balance_minutes").single();return o||!c?{ok:!1,error:(o==null?void 0:o.message)||"Failed to create watch balance state."}:{ok:!0,data:c}},[l,h]),$=a.useCallback(async()=>{const e=await A();if(!e.ok)return{ok:!1,error:e.error};const t=e.data;return{ok:!0,data:{level:se(t.read_score),readScore:t.read_score,watchBalanceMinutes:t.watch_balance_minutes}}},[A]);a.useEffect(()=>{r&&r!==J.current&&(J.current=r,u(!0),f(!1),W(X),G.current=null)},[r]),a.useEffect(()=>{if(!i||!r)return;let e=null;const t=()=>{const o=e?e.duration:null;W(ge(o))},s=()=>{const o=document.querySelector("video");if(!o){t();return}e&&e!==o&&(e.removeEventListener("loadedmetadata",t),e.removeEventListener("durationchange",t)),e=o,t(),e.addEventListener("loadedmetadata",t),e.addEventListener("durationchange",t)};s();const c=new MutationObserver(s);return c.observe(document.body,{childList:!0,subtree:!0}),()=>{c.disconnect(),e&&(e.removeEventListener("loadedmetadata",t),e.removeEventListener("durationchange",t))}},[i,r]);const v=a.useCallback(async()=>{if(!l)return!1;const e=await $();if(e.ok&&e.data)return O(e.data),!0;const t=await d(`${te}/state`,{headers:{Authorization:`Bearer ${l.access_token}`}});if(!t.ok||!t.body)return!1;const s=t.body;return O({level:s.level,readScore:s.readScore,watchBalanceMinutes:s.watchBalanceMinutes}),!0},[l,$,d]);a.useEffect(()=>{H.current=v},[v]);const Q=a.useCallback(async(e,t)=>{var U;if(!h)return{ok:!1,error:"Supabase client not configured."};const s=(U=l==null?void 0:l.user)==null?void 0:U.id;if(!s)return{ok:!1,error:"Supabase session unavailable."};let c=0,o=0;switch(e){case"read_completed":c+=typeof(t==null?void 0:t.score)=="number"?t.score:ce,o+=typeof(t==null?void 0:t.minutes)=="number"?t.minutes:_e;break;case"watch_initiated":{const N=typeof(t==null?void 0:t.minutes)=="number"?t.minutes:X;o-=N;const z=typeof(t==null?void 0:t.score)=="number"?t.score:0;c-=z;break}case"session_end":{const N=await A();if(!N.ok||!N.data)return{ok:!1,error:N.error||"Unable to load state."};N.data.watch_balance_minutes<0&&(c-=ve);break}default:return{ok:!0,data:null}}const w=await A();if(!w.ok||!w.data)return{ok:!1,error:w.error||"Unable to load state."};const T=w.data.read_score+c,D=w.data.watch_balance_minutes+o,{error:x}=await h.from("user_state").update({read_score:T,watch_balance_minutes:D,updated_at:new Date().toISOString()}).eq("user_id",s);return x?{ok:!1,error:x.message}:{ok:!0,data:{level:se(T),readScore:T,watchBalanceMinutes:D}}},[l,A,h]),S=a.useCallback(async(e,t)=>{if(!l)return null;const s=await Q(e,t);if(s.ok)return s.data??null;const c=await d(`${te}/event`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l.access_token}`},body:JSON.stringify({type:e,data:t})});return c.ok?c.body??null:null},[l,Q,d]);a.useEffect(()=>{if(!h)return;h.auth.getSession().then(({data:s})=>p(s.session));const{data:e}=h.auth.onAuthStateChange((s,c)=>{p(c),c&&g(!1)}),t=s=>{(s==null?void 0:s.type)==="auth_complete"&&(h.auth.getSession().then(({data:c})=>{p(c.session),c.session&&H.current()}),g(!1)),(s==null?void 0:s.type)==="auth_signed_out"&&(p(null),g(!1),u(!0),f(!1))};return chrome.runtime.onMessage.addListener(t),()=>{e.subscription.unsubscribe(),chrome.runtime.onMessage.removeListener(t)}},[h]),a.useEffect(()=>{l||O(null)},[l]),a.useEffect(()=>{_(h?null:"Missing Supabase configuration.")},[]),a.useEffect(()=>{if(!r||!l)return;let e=0,t=null,s=!1;const c=async()=>{e+=1,!await v()&&!s&&e<3&&(t=window.setTimeout(c,1e3))};return c(),S("video_opened",{videoId:r}),()=>{s=!0,t!==null&&window.clearTimeout(t)}},[r,l,v,S]),a.useEffect(()=>{if(!r||!i||!l||!V||G.current===r)return;G.current=r,(async()=>{var s,c,o;const t=await d(`${te}/transcript`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({videoId:r})});if(t.ok&&((s=t.body)!=null&&s.transcript)){const w=t.body.source?` (${t.body.source})`:"",T=`https://www.youtube.com/watch?v=${r}`,D=((o=(c=document.querySelector("h1 yt-formatted-string"))==null?void 0:c.textContent)==null?void 0:o.trim())||document.title.replace(/\s+-\s+YouTube$/i,"").trim()||"Unknown",x=document.querySelector("video"),U=x&&Number.isFinite(x.duration)?be(x.duration):"Unknown";console.log(`[Intent]
URL: ${T}
LENGTH: ${U}
TITLE: ${D}
TRANSCRIPT:${w}
${t.body.transcript}`)}else console.warn(`[Intent] Transcript unavailable for ${r}.`)})()},[r,i,l,V,d]),a.useEffect(()=>{i&&L(e=>(e+1)%B.length)},[i,B.length]),a.useEffect(()=>{if(!i)return;let e=null;const t=()=>{e==null||e.pause()},s=()=>{const o=document.querySelector("video");if(!o){pe();return}e&&e!==o&&(e.removeEventListener("play",t),e.removeEventListener("playing",t)),e=o,e.autoplay=!1,e.addEventListener("play",t),e.addEventListener("playing",t),e.pause()};s();const c=new MutationObserver(s);return c.observe(document.body,{childList:!0,subtree:!0}),()=>{c.disconnect(),e&&(e.removeEventListener("play",t),e.removeEventListener("playing",t))}},[i,r]);const K=a.useCallback(async()=>{if(!l)return;u(!1),f(!1);const e=await S("watch_initiated",{minutes:b,videoId:r,score:E});e?O({level:e.level,readScore:e.readScore,watchBalanceMinutes:e.watchBalanceMinutes}):await v()},[S,r,l,v,b,E]),R=a.useCallback(async()=>{if(!l)return;f(!0);const e=await S("read_completed",{videoId:r,minutes:Y,score:j});e?O({level:e.level,readScore:e.readScore,watchBalanceMinutes:e.watchBalanceMinutes}):await v()},[S,r,l,v,Y,j]),Z=a.useCallback(async()=>{var c;if(!h){_("Missing Supabase configuration.");return}g(!0);const e=(c=chrome.runtime)==null?void 0:c.getURL("auth.html"),{data:t,error:s}=await h.auth.signInWithOAuth({provider:"google",options:e?{redirectTo:e,skipBrowserRedirect:!0}:{skipBrowserRedirect:!0}});if(s||!(t!=null&&t.url)){_((s==null?void 0:s.message)||"Failed to start sign-in."),g(!1);return}try{chrome.runtime.sendMessage({type:"oauth_start",url:t.url},o=>{if(chrome.runtime.lastError){_(chrome.runtime.lastError.message),g(!1);return}o!=null&&o.ok||(_((o==null?void 0:o.error)||"OAuth failed."),g(!1))})}catch(o){_(o instanceof Error?o.message:"Extension runtime unavailable."),g(!1)}},[h]);return r?n.jsx(fe,{isVisible:i,isLoading:m,isAuthenticated:!!l,authError:I,authInProgress:ne,metrics:V,watchCostMinutes:b,readGainMinutes:Y,readScoreGain:j,watchScorePenalty:E,quote:B[M],onLogin:Z,onReadFirst:R,onWatchNow:K}):null}function Ne(){if(document.getElementById(ae))return;const r=document.createElement("div");r.id=ae,document.body.appendChild(r),he(r).render(n.jsx(me.StrictMode,{children:n.jsx(xe,{})}))}Ne();
