import"./modulepreload-polyfill-B5Qt9EMX.js";import{r as c,j as e,c as z,R as G}from"./client-DMp2t5-j.js";import{s as _}from"./supabaseClient-DihBYOwf.js";const y=(i,d=1)=>new Intl.NumberFormat("en-US",{maximumFractionDigits:d}).format(i),J=i=>new Date(i).toLocaleString("en-US",{hour:"numeric",minute:"2-digit",month:"short",day:"numeric"}),S=i=>i>0?`+${i}`:`${i}`,Q=5,X=10,k=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],Z=5e3,ee=i=>{const d=170-i*140,g=86-i*22;return`hsl(${Math.round(d)}, 45%, ${Math.round(g)}%)`},se=i=>Array.isArray(i)?i.filter(d=>typeof d=="string").map(d=>d.trim()).filter(Boolean):[];function ae(){const[i,d]=c.useState({loading:!0,error:null,rows:[]}),[g,L]=c.useState(null),[$,A]=c.useState([]),[j,E]=c.useState(null),[R,M]=c.useState(!1),f=c.useCallback(async()=>{if(!_){d({loading:!1,error:"Missing Supabase config. Set VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY.",rows:[]});return}if(!R){d(x=>({...x,loading:!0}));return}if(!(j!=null&&j.user)){d({loading:!1,error:"Sign in to view your dashboard.",rows:[]});return}d(x=>({...x,loading:!0,error:null}));const{data:s,error:a}=await _.from("user_state").select("read_score, watch_balance_minutes").eq("user_id",j.user.id).maybeSingle();a&&console.warn("[dashboard] Failed to load stream_state",a.message),L(s??null);const{data:t,error:n}=await _.from("feature_windows").select("*").eq("user_id_raw",j.user.id).order("window_start",{ascending:!1}).limit(200);if(n){d({loading:!1,error:n.message,rows:[]});return}const{data:l,error:r}=await _.from("risk_scores").select("*").eq("user_id_raw",j.user.id).order("window_start",{ascending:!1}).limit(200);if(r){d({loading:!1,error:r.message,rows:[]});return}const{data:p,error:b}=await _.from("action_events").select("event_type, occurred_at").eq("user_id_raw",j.user.id).order("occurred_at",{ascending:!1}).limit(200);b?(console.warn("[dashboard] Failed to load action_events",b.message),A([])):A(p??[]);const C=new Map;l==null||l.forEach(x=>{C.set(`${x.user_id}|${x.window_start}`,x)});const V=(t==null?void 0:t.map(x=>{const Y=`${x.user_id}|${x.window_start}`,o=C.get(Y);return{...x,risk_score:(o==null?void 0:o.risk_score)??null,scored_at:(o==null?void 0:o.scored_at)??null,insight_summary:(o==null?void 0:o.insight_summary)??null,insight_bullets:se(o==null?void 0:o.insight_bullets),risk_source:(o==null?void 0:o.risk_source)??null,model:(o==null?void 0:o.model)??null}}))??[];d({loading:!1,error:null,rows:V})},[R,j]);c.useEffect(()=>{f()},[f]),c.useEffect(()=>{const s=()=>{document.hidden||f()};return document.addEventListener("visibilitychange",s),()=>{document.removeEventListener("visibilitychange",s)}},[f]),c.useEffect(()=>{const s=window.setInterval(()=>{f()},Z);return()=>window.clearInterval(s)},[f]),c.useEffect(()=>{if(!_){M(!0);return}_.auth.getSession().then(({data:a})=>{E(a.session),M(!0)});const{data:s}=_.auth.onAuthStateChange((a,t)=>{E(t),M(!0)});return()=>{s.subscription.unsubscribe()}},[]);const h=c.useMemo(()=>i.rows,[i.rows]),u=c.useMemo(()=>{const s=(g==null?void 0:g.read_score)??0,a=Math.floor(s/400)+1,t=(g==null?void 0:g.watch_balance_minutes)??0,n=(a-1)*400,l=Math.max(0,s-n),r=Math.min(100,l/400*100),p=Math.max(0,a*400-s);return{readScore:s,level:a,watchBalance:t,levelProgress:l,levelPercent:r,scoreToNext:p}},[g]),T=c.useMemo(()=>{let s=0;for(const a of $){if(a.event_type==="watch_initiated")break;a.event_type==="read_completed"&&(s+=1)}return s},[$]),H=c.useMemo(()=>{const a=h.slice(0,7).reverse().map(n=>n.read_completed_count),t=Math.max(1,...a);return a.map(n=>Math.max(10,n/t*100))},[h]),m=c.useMemo(()=>{let s=0,a=0;const t=[0,0,0,0];for(const l of h){const r=l.watch_time_since_open_ms_count||0;if(!r)continue;const p=l.watch_time_since_open_ms_total/r;s+=l.watch_time_since_open_ms_total,a+=r,p<5e3?t[0]+=r:p<15e3?t[1]+=r:p<3e4?t[2]+=r:t[3]+=r}return{avgMs:a>0?s/a:null,buckets:t}},[h]),P=c.useMemo(()=>{const s=["<5s","5-15s","15-30s",">30s"],a=Math.max(1,...m.buckets);return s.map((t,n)=>({label:t,count:m.buckets[n],height:Math.max(8,m.buckets[n]/a*100)}))},[m.buckets]),v=c.useMemo(()=>{const s=Array.from({length:7},()=>Array.from({length:24},()=>({sum:0,count:0})));for(const n of h){if(n.risk_score===null)continue;const l=new Date(n.window_start),r=(l.getUTCDay()+6)%7,p=l.getUTCHours();s[r][p].sum+=n.risk_score,s[r][p].count+=1}let a={value:0,day:0,hour:0};return{values:s.map((n,l)=>n.map((r,p)=>{const b=r.count?r.sum/r.count:0;return b>a.value&&(a={value:b,day:l,hour:p}),b})),max:a}},[h]),D=c.useMemo(()=>{if(v.max.value<=0)return"Collecting more data to highlight high-risk hours.";const s=k[v.max.day],a=`${v.max.hour}:00`;return`Highest risk appears around ${s} ${a}.`},[v.max]),N=c.useMemo(()=>{for(const s of h)if(s.insight_summary||s.insight_bullets&&s.insight_bullets.length>0)return s;return null},[h]),O=c.useMemo(()=>{const s=[],a=m.avgMs?Math.round(m.avgMs/1e3):null,t=v.max.value>0?v.max.hour:null,n=v.max.value>0?k[v.max.day]:null;if(s.push({title:t!==null?`Peak risk around ${n} ${t}:00`:"High-risk windows forming",evidence:t!==null?`Highest risk average: ${y(v.max.value,2)}.`:"Collecting more hourly data.",suggestion:t!==null?`Plan a read-first block before ${t}:00.`:"Run more sessions to calibrate."}),s.push({title:a!==null?"Impulse speed is trending fast":"Impulse speed is forming",evidence:a!==null?`Average time to watch: ${a}s.`:"Waiting for watch timing data.",suggestion:"Add a 10-second pause before Watch Now."}),s.push({title:"Balance pressure check-in",evidence:`Current watch balance: ${S(u.watchBalance)} min.`,suggestion:"Complete a read to restore balance."}),N!=null&&N.insight_summary){const l=N.insight_bullets??[];s.push({title:N.insight_summary,evidence:l[0]??"AI insight generated from your behavior stream.",suggestion:l[1]??"Keep the read-first path active."})}else s.push({title:"AI insight incoming",evidence:"Run the scorer to generate personalized insight.",suggestion:"Keep streaming events for richer signals."});return s},[m.avgMs,N,u.watchBalance,v.max]),w=c.useMemo(()=>{const s=m.avgMs?Math.round(m.avgMs/1e3):null,a=h.reduce((l,r)=>l+r.watch_seconds_total/60,0),t=h.reduce((l,r)=>l+r.watch_initiated_count,0),n=t>0?a/t:null;return{avgOpenToWatch:s,avgWatchMinutes:n}},[h,m.avgMs]),I=c.useMemo(()=>{let s=0,a=0;for(const n of h)s+=n.read_time_ms_total,a+=n.read_time_ms_count;return{avgHours:a>0?s/a/36e5:null}},[h]),U=c.useMemo(()=>h.slice(0,5).map(s=>{const a=s.read_completed_count*Q-s.watch_initiated_count*X,t=a>0?"Intentional":a<0?"Impulsive":"Mixed",n=t.toLowerCase();return{time:J(s.window_start),context:s.watch_initiated_count>0?"Watch page":"Read-first",read:s.read_completed_count>0?"Yes":"No",watchMinutes:Math.round(s.watch_seconds_total/60),balanceDelta:a,balanceLabel:S(a),outcome:t,outcomeKey:n}}),[h]),F=u.watchBalance<0?"card stat-card stat-card--balance stat-card--debt":"card stat-card stat-card--balance",K=Math.round(u.levelPercent),B=m.avgMs?Math.round(m.avgMs/1e3):null,q=I.avgHours?y(I.avgHours,1):"--";return e.jsxs("div",{className:"app",children:[e.jsx("header",{className:"dashboard-header",children:e.jsxs("div",{children:[e.jsx("p",{className:"eyebrow",children:"Intent Analytics"}),e.jsx("h1",{children:"Attention, scored in real time."}),e.jsx("p",{className:"subtitle",children:"Stream events into Confluent, transform them into behavior signals, then score risk windows for the dashboard."})]})}),i.error?e.jsxs("div",{className:"card error-card",children:[e.jsx("h3",{children:"Dashboard offline"}),e.jsx("p",{children:i.error})]}):null,e.jsxs("section",{className:"stat-row",children:[e.jsx("div",{className:"card stat-card stat-card--level",children:e.jsxs("div",{className:"stat-header",children:[e.jsxs("div",{className:"stat-level-row",children:[e.jsxs("div",{className:"stat-stack",children:[e.jsx("p",{className:"stat-label",children:"Level"}),e.jsx("div",{className:"stat-value",children:u.level})]}),e.jsx("div",{className:"stat-ring",style:{"--progress":`${u.levelPercent}`},children:e.jsxs("span",{children:[K,"%"]})})]}),e.jsxs("div",{className:"level-progress",children:[e.jsxs("div",{className:"level-progress__title",children:["Progress to Level ",u.level+1]}),e.jsx("div",{className:"level-progress__bar",children:e.jsx("span",{style:{width:`${u.levelPercent}%`}})}),e.jsxs("div",{className:"level-progress__meta",children:[u.levelProgress," / 400 points"]})]})]})}),e.jsxs("div",{className:"card stat-card stat-card--read",children:[e.jsx("p",{className:"stat-label",children:"Read Score"}),e.jsx("div",{className:"stat-value",children:u.readScore}),e.jsx("div",{className:"stat-spark",children:H.map((s,a)=>e.jsx("span",{style:{height:`${s}%`}},`spark-${a}`))}),e.jsxs("div",{className:"read-callout",children:[e.jsx("div",{className:"read-callout__title",children:"Keep Reading to Level Up!"}),e.jsxs("div",{className:"read-callout__body",children:["Only ",u.scoreToNext," more points needed. Read more articles to boost your score and unlock new achievements."]})]})]}),e.jsxs("div",{className:F,children:[e.jsx("p",{className:"stat-label",children:"Watch Balance"}),e.jsxs("div",{className:"stat-value",children:[S(u.watchBalance)," min"]}),e.jsx("p",{className:"stat-meta",children:u.watchBalance<0?"In debt":"In surplus"})]}),e.jsxs("div",{className:"card stat-card",children:[e.jsx("p",{className:"stat-label",children:"Current Read Streak"}),e.jsx("div",{className:"stat-value",children:T}),e.jsx("p",{className:"stat-meta",children:"Consecutive reads build your streak, watches break it."})]})]}),e.jsxs("section",{className:"card section-card",children:[e.jsx("div",{className:"panel-header",children:e.jsxs("div",{children:[e.jsx("h3",{children:"Impulse Speed Distribution"}),e.jsx("span",{className:"panel-meta",children:"Time from open to watch decision"})]})}),e.jsxs("div",{className:"impulse-grid",children:[e.jsx("div",{className:"impulse-chart",children:P.map(s=>e.jsxs("div",{className:"impulse-bar",children:[e.jsx("div",{style:{height:`${s.height}%`}}),e.jsx("span",{children:s.label})]},s.label))}),e.jsxs("div",{className:"impulse-note",children:["Most watch decisions happen in"," ",e.jsx("strong",{children:B!==null?`${B}s`:"--"})]})]})]}),e.jsxs("section",{className:"card section-card",children:[e.jsxs("div",{className:"panel-header",children:[e.jsxs("div",{children:[e.jsx("h3",{children:"Risk & Pattern Analysis"}),e.jsx("span",{className:"panel-meta",children:"Hour of day x day of week analysis"})]}),e.jsxs("div",{className:"toggle-group",children:[e.jsx("button",{className:"toggle toggle--active",type:"button",children:"Risk Score"}),e.jsx("button",{className:"toggle",type:"button",disabled:!0,children:"Bypass Rate"}),e.jsx("button",{className:"toggle",type:"button",disabled:!0,children:"Negative Balance"})]})]}),e.jsxs("div",{className:"heatmap",children:[e.jsxs("div",{className:"heatmap-header",children:[e.jsx("span",{}),Array.from({length:24},(s,a)=>e.jsx("span",{children:a},`hour-${a}`))]}),k.map((s,a)=>e.jsxs("div",{className:"heatmap-row",children:[e.jsx("span",{className:"heatmap-day",children:s}),v.values[a].map((t,n)=>e.jsx("span",{className:"heatmap-cell",style:{backgroundColor:ee(t)},title:`${s} ${n}:00 - risk ${y(t,2)}`},`${s}-${n}`))]},s))]}),e.jsx("div",{className:"heatmap-footnote",children:D})]}),e.jsxs("section",{className:"section-heading",children:[e.jsx("h2",{children:"Addiction Mechanics"}),e.jsx("p",{children:"Making the habit visible and explainable"})]}),e.jsxs("section",{className:"grid-two",children:[e.jsxs("div",{className:"card panel",children:[e.jsxs("div",{className:"panel-header",children:[e.jsx("h3",{children:"Relapse Pattern"}),e.jsx("span",{className:"panel-meta",children:"What happens when you slip"})]}),e.jsxs("div",{className:"flow",children:[e.jsx("div",{className:"flow-step",children:"Video Opened"}),e.jsx("div",{className:"flow-connector",children:">"}),e.jsx("div",{className:"flow-step",children:"Watch Intent"}),e.jsx("div",{className:"flow-connector",children:">"}),e.jsx("div",{className:"flow-step flow-step--alert",children:"Negative Balance"})]}),e.jsxs("div",{className:"flow-metrics",children:[e.jsxs("div",{className:"flow-metric",children:[e.jsx("span",{children:"Open -> Watch"}),e.jsx("strong",{children:w.avgOpenToWatch!==null?`${w.avgOpenToWatch}s`:"--"})]}),e.jsxs("div",{className:"flow-metric",children:[e.jsx("span",{children:"Watch -> Debt"}),e.jsx("strong",{children:w.avgWatchMinutes!==null?`${y(w.avgWatchMinutes,1)} min`:"--"})]})]}),e.jsx("p",{className:"panel-footnote",children:"Median timing across sessions where watch intent precedes debt."})]}),e.jsxs("div",{className:"card panel",children:[e.jsxs("div",{className:"panel-header",children:[e.jsx("h3",{children:"Recovery Profile"}),e.jsx("span",{className:"panel-meta",children:"How quickly you bounce back"})]}),e.jsx("div",{className:"recovery-chart",children:["Mon","Tue","Wed","Thu","Fri"].map(s=>e.jsxs("div",{className:"recovery-column",children:[e.jsx("span",{}),e.jsx("small",{children:s})]},s))}),e.jsxs("div",{className:"recovery-note",children:[e.jsxs("strong",{children:["Median Recovery: ",q," hours"]}),e.jsx("span",{children:"Estimated time to restore balance after debt."})]})]})]}),e.jsxs("section",{className:"section-heading",children:[e.jsx("h2",{children:"Insights"}),e.jsx("p",{children:"Data-backed guidance, no judgment"})]}),e.jsx("section",{className:"insight-grid",children:O.map((s,a)=>e.jsxs("div",{className:"card insight-tile",children:[e.jsx("h3",{children:s.title}),e.jsxs("div",{className:"insight-block",children:[e.jsx("span",{children:"Evidence"}),e.jsx("p",{children:s.evidence})]}),e.jsxs("div",{className:"insight-block insight-block--suggestion",children:[e.jsx("span",{children:"Suggestion"}),e.jsx("p",{children:s.suggestion})]})]},`insight-${a}`))}),e.jsxs("section",{className:"card table-card",children:[e.jsxs("div",{className:"panel-header",children:[e.jsx("h3",{children:"Session Log"}),e.jsx("span",{className:"panel-meta",children:"Last 5 sessions with detailed metrics"})]}),e.jsxs("div",{className:"table session-table",children:[e.jsxs("div",{className:"table-row header",children:[e.jsx("span",{children:"Time"}),e.jsx("span",{children:"Context"}),e.jsx("span",{children:"Read"}),e.jsx("span",{children:"Watch (min)"}),e.jsx("span",{children:"Balance +/-"}),e.jsx("span",{children:"Outcome"})]}),U.map(s=>e.jsxs("div",{className:"table-row",children:[e.jsx("span",{children:s.time}),e.jsx("span",{children:s.context}),e.jsx("span",{children:s.read}),e.jsx("span",{children:s.watchMinutes}),e.jsx("span",{className:s.balanceDelta<0?"negative":"positive",children:s.balanceLabel}),e.jsx("span",{className:`pill outcome outcome-${s.outcomeKey}`,children:s.outcome})]},`session-${s.time}`))]})]})]})}const W=document.getElementById("root");W&&z(W).render(e.jsx(G.StrictMode,{children:e.jsx(ae,{})}));
