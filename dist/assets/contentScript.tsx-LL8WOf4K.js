import{j as t,r as a,c as ne,R as ae}from"./client-DMp2t5-j.js";import{s as h}from"./supabaseClient-DihBYOwf.js";const Q=40,re=5,X=10,K=10;function se({isVisible:s,isLoading:l,metrics:u,quote:p,isAuthenticated:d,authError:P,authInProgress:j,onLogin:A,onReadFirst:w,onWatchNow:V}){if(!s)return null;if(d&&!u)return t.jsx("div",{className:"intent-overlay",children:t.jsxs("div",{className:"intent-overlay__panel",children:[t.jsx("div",{className:"intent-overlay__title",children:"Read First"}),t.jsx("div",{className:"intent-overlay__subtitle",children:p}),t.jsx("div",{className:"intent-overlay__loading",children:"Syncing your watch balance…"})]})});const f=u??{readScore:0,watchBalanceMinutes:0},[R,b]=a.useState(0),[i,$]=a.useState(0),[U,G]=a.useState({left:0,width:0}),C=a.useRef(null),S=a.useRef(null),y=a.useRef(!1),m=a.useRef(null),H=a.useRef(0),_=a.useRef(null),T=a.useRef(null),k=5e3,W=120,Y=140,g=a.useCallback(()=>{S.current!==null&&(cancelAnimationFrame(S.current),S.current=null),m.current!==null&&(cancelAnimationFrame(m.current),m.current=null),C.current=null,y.current=!1;const N=H.current;if(N<=0){b(0);return}const L=performance.now(),O=I=>{const x=I-L,F=Math.min(x/Y,1),z=N*(1-F);if(b(z),F>=1){m.current=null;return}m.current=requestAnimationFrame(O)};m.current=requestAnimationFrame(O)},[]),e=a.useCallback(()=>{const N=performance.now();C.current=N,y.current=!1,m.current!==null&&(cancelAnimationFrame(m.current),m.current=null),b(0);const L=O=>{if(C.current===null)return;const I=O-C.current;let x=0;if(I<=W)x=I/W*.1;else{const F=I-W,z=k-W;x=.1+Math.min(F/z,1)*.9}if(b(x),x>=1&&!y.current){y.current=!0,V(),g();return}S.current=requestAnimationFrame(L)};S.current=requestAnimationFrame(L)},[V,g]);a.useEffect(()=>{H.current=R},[R]),a.useEffect(()=>{s||g()},[s,g]),a.useLayoutEffect(()=>{if(!d)return;const N=()=>{const O=_.current,I=T.current;if(!O||!I)return;const x=O.getBoundingClientRect(),F=I.getBoundingClientRect();$(x.width),G({left:Math.max(0,F.left-x.left),width:F.width})};N();const L=new ResizeObserver(N);return _.current&&L.observe(_.current),T.current&&L.observe(T.current),window.addEventListener("resize",N),()=>{L.disconnect(),window.removeEventListener("resize",N)}},[d]);const n=Math.floor(f.readScore/400)+1,r=Math.floor((f.readScore+Q)/400)+1,o=f.watchBalanceMinutes-X,c=o<0?f.readScore-K:f.readScore,v=Math.floor(c/400)+1,B=r>n?"↑":"=",q=o>=0?`${o} min`:`-${Math.abs(o)} min`,E=i*R,D=Math.max(0,Math.min(U.width,E-U.left)),M=Math.max(0,D);return t.jsx("div",{className:"intent-overlay",children:t.jsxs("div",{className:"intent-overlay__panel",children:[t.jsx("div",{className:"intent-overlay__title",children:"Read First"}),t.jsx("div",{className:"intent-overlay__subtitle",children:p}),d?t.jsxs("div",{className:"intent-overlay__metrics",children:[t.jsxs("div",{className:"intent-overlay__metric",children:[t.jsx("span",{className:"intent-overlay__metric-label",children:"Level"}),t.jsx("span",{className:"intent-overlay__metric-value",children:n})]}),t.jsxs("div",{className:"intent-overlay__metric",children:[t.jsx("span",{className:"intent-overlay__metric-label",children:"Read Score"}),t.jsx("span",{className:"intent-overlay__metric-value",children:u.readScore})]}),t.jsxs("div",{className:"intent-overlay__metric",children:[t.jsx("span",{className:"intent-overlay__metric-label",children:"Watch Balance"}),t.jsxs("span",{className:"intent-overlay__metric-value",children:[f.watchBalanceMinutes," min"]})]})]}):t.jsxs("div",{className:"intent-overlay__auth",children:[t.jsx("div",{className:"intent-overlay__auth-title",children:"Sign in to continue"}),t.jsx("div",{className:"intent-overlay__auth-copy",children:"Your score and balance sync to your account. Sign in to proceed."}),t.jsx("button",{className:"intent-overlay__auth-button",type:"button",onClick:A,disabled:j,children:j?"Authenticating…":"Sign in with Google"})]}),d?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"intent-overlay__choice",children:[t.jsx("div",{className:"intent-overlay__choice-title",children:"Your Choice"}),t.jsxs("div",{className:"intent-overlay__choice-grid",children:[t.jsxs("div",{className:"intent-overlay__choice-card",children:[t.jsx("div",{className:"intent-overlay__choice-header",children:"Read Instead"}),t.jsxs("div",{className:"intent-overlay__choice-chips",children:[t.jsxs("span",{className:"intent-overlay__chip",children:["Score +",Q]}),t.jsxs("span",{className:"intent-overlay__chip",children:["Watch Balance +",re,"m"]}),t.jsxs("span",{className:"intent-overlay__chip",children:["Level ",r," ",B]})]}),t.jsx("div",{className:"intent-overlay__choice-note",children:"Reading restores progress."})]}),t.jsxs("div",{className:"intent-overlay__choice-card intent-overlay__choice-card--watch",children:[t.jsx("div",{className:"intent-overlay__choice-header",children:"Watch Now"}),t.jsxs("div",{className:"intent-overlay__choice-chips",children:[t.jsxs("span",{className:"intent-overlay__chip intent-overlay__chip--warn",children:["Watch Balance -",X,"m"]}),t.jsxs("span",{className:"intent-overlay__chip intent-overlay__chip--highlight",children:["New Watch Balance ",q]})]}),o<0?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"intent-overlay__choice-subline",children:["Score penalty -",K," (attention debt)"]}),t.jsx("div",{className:"intent-overlay__choice-subline",children:"Level progress paused while negative"}),v<n?t.jsxs("div",{className:"intent-overlay__choice-warning",children:["⚠️ Risk: Level down to ",v]}):null]}):t.jsx("div",{className:"intent-overlay__choice-subline",children:"No score penalty (balance stays non-negative)"})]})]})]}),t.jsxs("div",{className:"intent-overlay__actions",children:[t.jsx("button",{className:"intent-overlay__primary",type:"button",onClick:w,disabled:l,children:l?"Generating summary…":"Read Instead"}),t.jsxs("button",{className:"intent-overlay__secondary",type:"button",onPointerDown:e,onPointerUp:g,onPointerLeave:g,onPointerCancel:g,ref:_,children:[t.jsx("span",{className:"intent-overlay__hold-fill",style:{transform:`scaleX(${R})`}}),t.jsxs("span",{className:"intent-overlay__button-label intent-overlay__button-label--progress",children:[t.jsx("span",{ref:T,className:"intent-overlay__button-label-base",children:"Watch Now"}),t.jsx("span",{className:"intent-overlay__button-label-fill",style:{"--label-fill-px":`${M}px`},children:"Watch Now"})]})]})]}),l?t.jsx("div",{className:"intent-overlay__loading",children:"Preparing a focused summary and key points…"}):null]}):null]})})}const Z="intent-read-first-root",J="http://127.0.0.1:8787",oe=40,ce=5,ie=10,le=10,ee=s=>Math.floor(s/400)+1;function te(s){try{const l=new URL(s);return l.pathname!=="/watch"?null:l.searchParams.get("v")}catch{return null}}function ue(){var u;const s=document.querySelector("video");if(s&&!s.paused&&s.pause(),s){s.autoplay=!1;return}const l=document.querySelector(".ytp-play-button");l&&((u=l.getAttribute("aria-label"))!=null&&u.toLowerCase().includes("pause"))&&l.click()}function de(s){const l=Math.floor(s),u=Math.floor(l/3600),p=Math.floor(l%3600/60),d=l%60;return(u>0?[u,p,d]:[p,d]).map(j=>String(j).padStart(2,"0")).join(":")}function he(){const[s,l]=a.useState(()=>te(window.location.href));return a.useEffect(()=>{const u=()=>l(te(window.location.href)),p=history.pushState,d=history.replaceState;history.pushState=function(...A){p.apply(this,A),u()},history.replaceState=function(...A){d.apply(this,A),u()},window.addEventListener("popstate",u);const P=new MutationObserver(u);P.observe(document.body,{childList:!0,subtree:!0});const j=window.setInterval(u,1e3);return()=>{history.pushState=p,history.replaceState=d,window.removeEventListener("popstate",u),P.disconnect(),window.clearInterval(j)}},[]),s}function fe(){const s=he(),[l,u]=a.useState(!0),[p,d]=a.useState(!1),[P,j]=a.useState(0),[A,w]=a.useState(null),[V,f]=a.useState(!1),[R,b]=a.useState(null),[i,$]=a.useState(null),U=a.useRef(s),G=a.useRef(null),C=a.useRef(async()=>!1),S=a.useMemo(()=>["It is not enough to be busy; so are the ants. The question is: What are we busy about? — Henry David Thoreau","The successful warrior is the average man, with laser-like focus. — Bruce Lee","Concentrate all your thoughts upon the work in hand. — Alexander Graham Bell","Simplicity is the ultimate sophistication. — Leonardo da Vinci","A well-spent day brings happy sleep. — Leonardo da Vinci","Your focus determines your reality. — George Lucas"],[]),y=a.useCallback(async(e,n)=>new Promise(r=>{var o;if(!((o=chrome==null?void 0:chrome.runtime)!=null&&o.sendMessage)){r({ok:!1,error:"Extension runtime unavailable."});return}try{chrome.runtime.sendMessage({type:"api_request",url:e,init:n},c=>{if(chrome.runtime.lastError){r({ok:!1,error:chrome.runtime.lastError.message});return}r(c)})}catch(c){r({ok:!1,error:c instanceof Error?c.message:String(c)})}}),[]),m=a.useCallback(async()=>{var v;if(!h)return{ok:!1,error:"Supabase client not configured."};const e=(v=i==null?void 0:i.user)==null?void 0:v.id;if(!e)return{ok:!1,error:"Supabase session unavailable."};const{data:n,error:r}=await h.from("user_state").select("user_id, read_score, watch_balance_minutes").eq("user_id",e).maybeSingle();if(r)return{ok:!1,error:r.message};if(n)return{ok:!0,data:n};const{data:o,error:c}=await h.from("user_state").insert({user_id:e,read_score:0,watch_balance_minutes:0}).select("user_id, read_score, watch_balance_minutes").single();return c||!o?{ok:!1,error:(c==null?void 0:c.message)||"Failed to create watch balance state."}:{ok:!0,data:o}},[i,h]),H=a.useCallback(async()=>{const e=await m();if(!e.ok)return{ok:!1,error:e.error};const n=e.data;return{ok:!0,data:{level:ee(n.read_score),readScore:n.read_score,watchBalanceMinutes:n.watch_balance_minutes}}},[m]);a.useEffect(()=>{s&&s!==U.current&&(U.current=s,u(!0),d(!1),G.current=null)},[s]);const _=a.useCallback(async()=>{if(!i)return!1;const e=await H();if(e.ok&&e.data)return b(e.data),!0;const n=await y(`${J}/state`,{headers:{Authorization:`Bearer ${i.access_token}`}});if(!n.ok||!n.body)return!1;const r=n.body;return b({level:r.level,readScore:r.readScore,watchBalanceMinutes:r.watchBalanceMinutes}),!0},[i,H,y]);a.useEffect(()=>{C.current=_},[_]);const T=a.useCallback(async(e,n)=>{var D;if(!h)return{ok:!1,error:"Supabase client not configured."};const r=(D=i==null?void 0:i.user)==null?void 0:D.id;if(!r)return{ok:!1,error:"Supabase session unavailable."};let o=0,c=0;switch(e){case"read_completed":o+=oe,c+=ce;break;case"watch_initiated":{const M=typeof(n==null?void 0:n.minutes)=="number"?n.minutes:ie;c-=M;break}case"session_end":{const M=await m();if(!M.ok||!M.data)return{ok:!1,error:M.error||"Unable to load state."};M.data.watch_balance_minutes<0&&(o-=le);break}default:return{ok:!0,data:null}}const v=await m();if(!v.ok||!v.data)return{ok:!1,error:v.error||"Unable to load state."};const B=v.data.read_score+o,q=v.data.watch_balance_minutes+c,{error:E}=await h.from("user_state").update({read_score:B,watch_balance_minutes:q,updated_at:new Date().toISOString()}).eq("user_id",r);return E?{ok:!1,error:E.message}:{ok:!0,data:{level:ee(B),readScore:B,watchBalanceMinutes:q}}},[i,m,h]),k=a.useCallback(async(e,n)=>{if(!i)return null;const r=await T(e,n);if(r.ok)return r.data??null;const o=await y(`${J}/event`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i.access_token}`},body:JSON.stringify({type:e,data:n})});return o.ok?o.body??null:null},[i,T,y]);a.useEffect(()=>{if(!h)return;h.auth.getSession().then(({data:r})=>$(r.session));const{data:e}=h.auth.onAuthStateChange((r,o)=>{$(o),o&&f(!1)}),n=r=>{(r==null?void 0:r.type)==="auth_complete"&&(h.auth.getSession().then(({data:o})=>{$(o.session),o.session&&C.current()}),f(!1)),(r==null?void 0:r.type)==="auth_signed_out"&&($(null),f(!1),u(!0),d(!1))};return chrome.runtime.onMessage.addListener(n),()=>{e.subscription.unsubscribe(),chrome.runtime.onMessage.removeListener(n)}},[h]),a.useEffect(()=>{i||b(null)},[i]),a.useEffect(()=>{w(h?null:"Missing Supabase configuration.")},[]),a.useEffect(()=>{if(!s||!i)return;let e=0,n=null,r=!1;const o=async()=>{e+=1,!await _()&&!r&&e<3&&(n=window.setTimeout(o,1e3))};return o(),k("video_opened",{videoId:s}),()=>{r=!0,n!==null&&window.clearTimeout(n)}},[s,i,_,k]),a.useEffect(()=>{if(!s||!l||!i||!R||G.current===s)return;G.current=s,(async()=>{var r,o,c;const n=await y(`${J}/transcript`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({videoId:s})});if(n.ok&&((r=n.body)!=null&&r.transcript)){const v=n.body.source?` (${n.body.source})`:"",B=`https://www.youtube.com/watch?v=${s}`,q=((c=(o=document.querySelector("h1 yt-formatted-string"))==null?void 0:o.textContent)==null?void 0:c.trim())||document.title.replace(/\s+-\s+YouTube$/i,"").trim()||"Unknown",E=document.querySelector("video"),D=E&&Number.isFinite(E.duration)?de(E.duration):"Unknown";console.log(`[Intent]
URL: ${B}
LENGTH: ${D}
TITLE: ${q}
TRANSCRIPT:${v}
${n.body.transcript}`)}else console.warn(`[Intent] Transcript unavailable for ${s}.`)})()},[s,l,i,R,y]),a.useEffect(()=>{l&&j(e=>(e+1)%S.length)},[l,S.length]),a.useEffect(()=>{if(!l)return;let e=null;const n=()=>{e==null||e.pause()},r=()=>{const c=document.querySelector("video");if(!c){ue();return}e&&e!==c&&(e.removeEventListener("play",n),e.removeEventListener("playing",n)),e=c,e.autoplay=!1,e.addEventListener("play",n),e.addEventListener("playing",n),e.pause()};r();const o=new MutationObserver(r);return o.observe(document.body,{childList:!0,subtree:!0}),()=>{o.disconnect(),e&&(e.removeEventListener("play",n),e.removeEventListener("playing",n))}},[l,s]);const W=a.useCallback(async()=>{if(!i)return;u(!1),d(!1);const e=await k("watch_initiated",{minutes:10,videoId:s});e?b({level:e.level,readScore:e.readScore,watchBalanceMinutes:e.watchBalanceMinutes}):await _()},[k,s,i,_]),Y=a.useCallback(async()=>{if(!i)return;d(!0);const e=await k("read_completed",{videoId:s});e?b({level:e.level,readScore:e.readScore,watchBalanceMinutes:e.watchBalanceMinutes}):await _()},[k,s,i,_]),g=a.useCallback(async()=>{var o;if(!h){w("Missing Supabase configuration.");return}f(!0);const e=(o=chrome.runtime)==null?void 0:o.getURL("auth.html"),{data:n,error:r}=await h.auth.signInWithOAuth({provider:"google",options:e?{redirectTo:e,skipBrowserRedirect:!0}:{skipBrowserRedirect:!0}});if(r||!(n!=null&&n.url)){w((r==null?void 0:r.message)||"Failed to start sign-in."),f(!1);return}try{chrome.runtime.sendMessage({type:"oauth_start",url:n.url},c=>{if(chrome.runtime.lastError){w(chrome.runtime.lastError.message),f(!1);return}c!=null&&c.ok||(w((c==null?void 0:c.error)||"OAuth failed."),f(!1))})}catch(c){w(c instanceof Error?c.message:"Extension runtime unavailable."),f(!1)}},[h]);return s?t.jsx(se,{isVisible:l,isLoading:p,isAuthenticated:!!i,authError:A,authInProgress:V,metrics:R,quote:S[P],onLogin:g,onReadFirst:Y,onWatchNow:W}):null}function me(){if(document.getElementById(Z))return;const s=document.createElement("div");s.id=Z,document.body.appendChild(s),ne(s).render(t.jsx(ae.StrictMode,{children:t.jsx(fe,{})}))}me();
