import{j as a,r,c as Be,R as Pe}from"./client-DMp2t5-j.js";import{s as S}from"./supabaseClient-DihBYOwf.js";const Ee=10;function De({isVisible:n,isLoading:i,metrics:u,watchCostMinutes:v,readGainMinutes:y,readScoreGain:M,watchScorePenalty:I,summary:p,isClaimingRewards:T,hasClaimedRewards:pe,claimSecondsRemaining:C,claimCountdownLabel:ce,quote:H,isAuthenticated:b,authError:ie,authInProgress:ae,onLogin:X,onReadFirst:G,onWatchNow:K,onClaimRewards:se}){var q;if(!n)return null;if(b&&!u)return a.jsx("div",{className:"intent-overlay",children:a.jsxs("div",{className:"intent-overlay__panel",children:[a.jsx("div",{className:"intent-overlay__title",children:"Read First"}),a.jsx("div",{className:"intent-overlay__subtitle",children:H}),a.jsx("div",{className:"intent-overlay__loading",children:"Syncing your watch balance…"})]})});const R=u??{readScore:0,watchBalanceMinutes:0},[l,P]=r.useState(0),[D,be]=r.useState(0),[le,ue]=r.useState({left:0,width:0}),[O,de]=r.useState(!1),Z=r.useRef(null),A=r.useRef(null),Y=r.useRef(!1),w=r.useRef(null),z=r.useRef(0),m=r.useRef(null),$=r.useRef(null),E=r.useRef(null),we=5e3,h=120,ee=140,me=2e3,j=r.useCallback(()=>{A.current!==null&&(cancelAnimationFrame(A.current),A.current=null),w.current!==null&&(cancelAnimationFrame(w.current),w.current=null),Z.current=null,Y.current=!1;const d=z.current;if(d<=0){P(0);return}const _=performance.now(),U=Q=>{const V=Q-_,re=Math.min(V/ee,1),Me=d*(1-re);if(P(Me),re>=1){w.current=null;return}w.current=requestAnimationFrame(U)};w.current=requestAnimationFrame(U)},[]),B=r.useCallback(()=>{m.current!==null&&(window.clearTimeout(m.current),m.current=null),de(!1)},[]),te=r.useCallback(()=>{m.current!==null&&window.clearTimeout(m.current),m.current=window.setTimeout(()=>{de(!0)},me)},[]),oe=r.useCallback(()=>{const d=performance.now();Z.current=d,Y.current=!1,w.current!==null&&(cancelAnimationFrame(w.current),w.current=null),P(0);const _=U=>{if(Z.current===null)return;const Q=U-Z.current;let V=0;if(Q<=h)V=Q/h*.1;else{const re=Q-h,Me=we-h;V=.1+Math.min(re/Me,1)*.9}if(P(V),V>=1&&!Y.current){Y.current=!0,K(),j(),B();return}A.current=requestAnimationFrame(_)};A.current=requestAnimationFrame(_)},[K,j,B]),he=r.useCallback(()=>{oe(),te()},[oe,te]),x=r.useCallback(()=>{j(),B()},[j,B]);r.useEffect(()=>{z.current=l},[l]),r.useEffect(()=>{n||j()},[n,j]),r.useEffect(()=>B,[B]),r.useLayoutEffect(()=>{if(!b)return;const d=()=>{const U=$.current,Q=E.current;if(!U||!Q)return;const V=U.getBoundingClientRect(),re=Q.getBoundingClientRect();be(V.width),ue({left:Math.max(0,re.left-V.left),width:re.width})};d();const _=new ResizeObserver(d);return $.current&&_.observe($.current),E.current&&_.observe(E.current),window.addEventListener("resize",d),()=>{_.disconnect(),window.removeEventListener("resize",d)}},[b]);const W=Math.floor(R.readScore/400)+1,f=Math.floor((R.readScore+M)/400)+1,Se=W*400,ne=Math.max(0,Se-R.readScore),k=R.watchBalanceMinutes-v,ge=R.readScore-I-(k<0?Ee:0),N=Math.floor(ge/400)+1,xe=f>W?"↑":"-",J=N<W?"↓":"-",fe=d=>Number.isInteger(d)?String(d):d.toFixed(1),Ne=k>=0?`${k} min`:`-${Math.abs(k)} min`,_e=R.watchBalanceMinutes+y,ve=fe(y),e=`+${M} score, +${ve}m`,t=C>0,s=t?`Read for ${ce} to claim rewards`:`Claim your reading rewards (${e})`,c=_e>=0?`+${fe(_e)}m`:`-${fe(Math.abs(_e))}m`,o=i?"Generating Summary...":`Read Instead (Watch Balance +${ve}m)`,g=D*l,L=Math.max(0,Math.min(le.width,g-le.left)),F=Math.max(0,L);return a.jsx("div",{className:"intent-overlay",children:a.jsxs("div",{className:"intent-overlay__panel",children:[a.jsxs("div",{className:`intent-overlay__content${O?" intent-overlay__content--dim":""}`,children:[a.jsx("div",{className:"intent-overlay__title",children:"Read First"}),a.jsx("div",{className:"intent-overlay__subtitle",children:H}),b?a.jsxs("div",{className:"intent-overlay__metrics",children:[a.jsxs("div",{className:"intent-overlay__metric",children:[a.jsx("span",{className:"intent-overlay__metric-label",children:"Level"}),a.jsx("span",{className:"intent-overlay__metric-value",children:W})]}),a.jsxs("div",{className:"intent-overlay__metric",children:[a.jsx("span",{className:"intent-overlay__metric-label",children:"Read Score"}),a.jsx("span",{className:"intent-overlay__metric-value",children:u.readScore})]}),a.jsxs("div",{className:"intent-overlay__metric",children:[a.jsx("span",{className:"intent-overlay__metric-label",children:"Watch Balance"}),a.jsxs("span",{className:"intent-overlay__metric-value",children:[R.watchBalanceMinutes," min"]})]})]}):a.jsxs("div",{className:"intent-overlay__auth",children:[a.jsx("div",{className:"intent-overlay__auth-title",children:"Sign in to continue"}),a.jsx("div",{className:"intent-overlay__auth-copy",children:"Your score and balance sync to your account. Sign in to proceed."}),a.jsx("button",{className:"intent-overlay__auth-button",type:"button",onClick:X,disabled:ae,children:ae?"Authenticating…":"Sign in with Google"})]}),b?p?a.jsxs("div",{className:"intent-overlay__summary",children:[a.jsxs("div",{className:"intent-overlay__summary-header",children:[a.jsx("div",{className:"intent-overlay__summary-title",children:p.title||"Read First Brief"}),a.jsxs("div",{className:"intent-overlay__summary-meta",children:[p.readingTimeMinutes," min read"]})]}),a.jsxs("div",{className:"intent-overlay__summary-body",children:[p.summary?a.jsx("div",{className:"intent-overlay__summary-text",children:p.summary}):null,(q=p.keyPoints)!=null&&q.length?a.jsx("ul",{className:"intent-overlay__summary-list",children:p.keyPoints.map((d,_)=>a.jsx("li",{children:d},`${_}-${d.slice(0,16)}`))}):null]}),a.jsx("button",{className:"intent-overlay__summary-claim",type:"button",onClick:se,disabled:T||pe||t,children:pe?"Rewards claimed":T?"Claiming rewards...":s})]}):a.jsxs("div",{className:"intent-overlay__choice",children:[a.jsx("div",{className:"intent-overlay__choice-title",children:"Your Choice"}),a.jsxs("div",{className:"intent-overlay__choice-grid",children:[a.jsxs("div",{className:"intent-overlay__choice-card intent-overlay__choice-card--watch",children:[a.jsx("div",{className:"intent-overlay__choice-header",children:"Watch Now"}),a.jsxs("div",{className:"intent-overlay__choice-chips",children:[a.jsxs("span",{className:"intent-overlay__chip intent-overlay__chip--warn",children:["Score -",I]}),a.jsxs("span",{className:"intent-overlay__chip intent-overlay__chip--warn",children:["Watch Balance -",v,"m"]}),a.jsxs("span",{className:"intent-overlay__chip intent-overlay__chip--highlight",children:["New Watch Balance ",Ne]}),a.jsxs("span",{className:"intent-overlay__chip",children:["Level ",N," ",J]})]}),k<0?a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"intent-overlay__choice-subline",children:["Additional score penalty -",Ee," (attention debt)"]}),a.jsx("div",{className:"intent-overlay__choice-subline",children:"Level progress paused while negative"}),N<W?a.jsxs("div",{className:"intent-overlay__choice-warning",children:["⚠️ Risk: Level down to ",N]}):null]}):null]}),a.jsxs("div",{className:"intent-overlay__choice-card intent-overlay__choice-card--read",children:[a.jsx("div",{className:"intent-overlay__choice-header",children:"Read Instead"}),a.jsxs("div",{className:"intent-overlay__choice-chips",children:[a.jsxs("span",{className:"intent-overlay__chip",children:["Score +",M]}),a.jsxs("span",{className:"intent-overlay__chip",children:["Watch Balance +",ve,"m"]}),a.jsxs("span",{className:"intent-overlay__chip intent-overlay__chip--highlight",children:["New Watch Balance ",c]}),a.jsxs("span",{className:"intent-overlay__chip",children:["Level ",f," ",xe]})]}),a.jsxs("div",{className:"intent-overlay__choice-note intent-overlay__choice-note--progress",children:[a.jsxs("span",{className:"intent-overlay__choice-note-label",children:["Level ",W+1," in"]}),a.jsx("span",{className:"intent-overlay__choice-note-score",children:ne}),a.jsx("span",{className:"intent-overlay__choice-note-unit",children:"pts"})]})]})]})]}):null]}),b&&!p?a.jsxs("div",{className:"intent-overlay__actions",children:[a.jsxs("button",{className:"intent-overlay__secondary",type:"button",onPointerDown:he,onPointerUp:x,onPointerLeave:x,onPointerCancel:x,ref:$,children:[a.jsx("span",{className:"intent-overlay__hold-fill",style:{transform:`scaleX(${l})`}}),a.jsxs("span",{className:"intent-overlay__button-label intent-overlay__button-label--progress",children:[a.jsxs("span",{ref:E,className:"intent-overlay__button-label-base",children:["Watch Now (Watch Balance -",v,"m)"]}),a.jsxs("span",{className:"intent-overlay__button-label-fill",style:{"--label-fill-px":`${F}px`},children:["Watch Now (Watch Balance -",v,"m)"]})]})]}),a.jsxs("button",{className:`intent-overlay__primary intent-overlay__primary--read${i?" intent-overlay__primary--read-active":""}`,type:"button",onClick:G,disabled:i,children:[a.jsx("span",{className:"intent-overlay__press-fill"}),a.jsxs("span",{className:`intent-overlay__button-label intent-overlay__button-label--progress${i?" intent-overlay__button-label--loading":""}`,children:[a.jsx("span",{className:"intent-overlay__button-label-base",children:o}),a.jsx("span",{className:"intent-overlay__button-label-fill",children:o})]})]})]}):null,a.jsxs("div",{className:`intent-overlay__motto${O?" intent-overlay__motto--visible":""}`,children:[a.jsx("span",{className:"intent-overlay__motto-red",children:"Old ways"}),a.jsx("span",{className:"intent-overlay__motto-neutral",children:" dont open "}),a.jsx("span",{className:"intent-overlay__motto-green",children:"new doors"})]})]})})}const je="intent-read-first-root",ye="http://127.0.0.1:8787",Ae=40,Oe=5,Re=10,$e=10,We=200,Fe=15,ke=15e3,qe=1e4,Le=n=>Math.floor(n/400)+1,Ue=30;function Ie(n){return n?n.trim().split(/\s+/).filter(Boolean).length:0}function Ve(n){var M;if(!n)return 0;const i=Ie(n.summary),u=((M=n.keyPoints)==null?void 0:M.reduce((I,p)=>I+Ie(p),0))??0,v=i+u;if(v===0)return 0;const y=Math.round(v/We*60);return Math.max(Fe,y)}function He(n){const i=Math.floor(n/60),u=n%60;return i<=0?`${u}s`:`${i}:${String(u).padStart(2,"0")}`}function Te(n){try{const i=new URL(n);return i.pathname!=="/watch"?null:i.searchParams.get("v")}catch{return null}}function Ge(){var u;const n=document.querySelector("video");if(n&&!n.paused&&n.pause(),n){n.autoplay=!1;return}const i=document.querySelector(".ytp-play-button");i&&((u=i.getAttribute("aria-label"))!=null&&u.toLowerCase().includes("pause"))&&i.click()}function Ye(n){const i=Math.floor(n),u=Math.floor(i/3600),v=Math.floor(i%3600/60),y=i%60;return(u>0?[u,v,y]:[v,y]).map(I=>String(I).padStart(2,"0")).join(":")}function ze(){var n,i;return((i=(n=document.querySelector("h1 yt-formatted-string"))==null?void 0:n.textContent)==null?void 0:i.trim())||document.title.replace(/\s+-\s+YouTube$/i,"").trim()||"Untitled video"}function Je(){const n=document.querySelector("video");return!n||!Number.isFinite(n.duration)?null:n.duration}function Qe(n){return Number.isFinite(n)?Math.round(n*2/10)*10:Ae}function Ce(n){return!Number.isFinite(n)||n===0?0:n>0?Math.ceil(n):-Math.ceil(Math.abs(n))}function Xe(n){if(!n||!Number.isFinite(n))return Re;const i=Math.max(0,n),u=Math.floor(i/60);return i%60>=Ue?u+1:u}function Ke(){const[n,i]=r.useState(()=>Te(window.location.href));return r.useEffect(()=>{const u=()=>i(Te(window.location.href)),v=history.pushState,y=history.replaceState;history.pushState=function(...p){v.apply(this,p),u()},history.replaceState=function(...p){y.apply(this,p),u()},window.addEventListener("popstate",u);const M=new MutationObserver(u);M.observe(document.body,{childList:!0,subtree:!0});const I=window.setInterval(u,1e3);return()=>{history.pushState=v,history.replaceState=y,window.removeEventListener("popstate",u),M.disconnect(),window.clearInterval(I)}},[]),n}function Ze(){const n=Ke(),[i,u]=r.useState(!0),[v,y]=r.useState(!1),[M,I]=r.useState(0),[p,T]=r.useState(null),[pe,C]=r.useState(!1),[ce,H]=r.useState(null),[b,ie]=r.useState(null),[ae,X]=r.useState(!1),[G,K]=r.useState(!1),[se,R]=r.useState(0),[l,P]=r.useState(null),[D,be]=r.useState(Re),le=r.useRef(n),ue=r.useRef(null),O=r.useRef(null),de=r.useRef(async()=>!1),Z=r.useRef(crypto.randomUUID()),A=r.useRef(Date.now()),Y=r.useRef(!1),w=r.useRef(null),z=r.useRef(null),m=r.useRef(null),$=r.useRef(0),E=r.useRef(!1),we=r.useRef(null),h=r.useRef(null),ee=r.useRef(0),me=r.useRef(0),j=r.useRef(!1),B=r.useMemo(()=>D/2,[D]),te=r.useMemo(()=>Qe(D),[D]),oe=te,he=r.useMemo(()=>["It is not enough to be busy; so are the ants. The question is: What are we busy about? — Henry David Thoreau","The successful warrior is the average man, with laser-like focus. — Bruce Lee","Concentrate all your thoughts upon the work in hand. — Alexander Graham Bell","Simplicity is the ultimate sophistication. — Leonardo da Vinci","A well-spent day brings happy sleep. — Leonardo da Vinci","Your focus determines your reality. — George Lucas"],[]),x=r.useCallback(async(e,t)=>new Promise(s=>{var c;if(!((c=chrome==null?void 0:chrome.runtime)!=null&&c.sendMessage)){s({ok:!1,error:"Extension runtime unavailable."});return}try{chrome.runtime.sendMessage({type:"api_request",url:e,init:t},o=>{if(chrome.runtime.lastError){s({ok:!1,error:chrome.runtime.lastError.message});return}s(o)})}catch(o){s({ok:!1,error:o instanceof Error?o.message:String(o)})}}),[]),W=r.useCallback(()=>({page:"youtube_watch",url:window.location.href}),[]),f=r.useCallback(async(e,t)=>{if(!l)return;const s={type:e,videoId:n??void 0,sessionId:Z.current,data:t,context:W()};await x(`${ye}/stream`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l.access_token}`},body:JSON.stringify(s)})},[l,n,x,W]),Se=r.useCallback(()=>{if(!l||!n||Y.current)return;Y.current=!0;const e=Math.max(0,Date.now()-A.current);f("intent_panel_shown",{delay_ms:e,videoId:n})},[l,n,f]),ne=r.useCallback(e=>{if(!E.current||j.current)return;j.current=!0;const t=Math.max(0,Math.round(ee.current));f("watch_ended",{total_watch_seconds:t,ended_by:e})},[f]),k=r.useCallback(async()=>{var g;if(!S)return{ok:!1,error:"Supabase client not configured."};const e=(g=l==null?void 0:l.user)==null?void 0:g.id;if(!e)return{ok:!1,error:"Supabase session unavailable."};const{data:t,error:s}=await S.from("user_state").select("user_id, read_score, watch_balance_minutes").eq("user_id",e).maybeSingle();if(s)return{ok:!1,error:s.message};if(t)return{ok:!0,data:t};const{data:c,error:o}=await S.from("user_state").insert({user_id:e,read_score:0,watch_balance_minutes:0}).select("user_id, read_score, watch_balance_minutes").single();return o||!c?{ok:!1,error:(o==null?void 0:o.message)||"Failed to create watch balance state."}:{ok:!0,data:c}},[l,S]),ge=r.useCallback(async()=>{const e=await k();if(!e.ok)return{ok:!1,error:e.error};const t=e.data;return{ok:!0,data:{level:Le(t.read_score),readScore:t.read_score,watchBalanceMinutes:t.watch_balance_minutes}}},[k]);r.useEffect(()=>{n&&n!==le.current&&(E.current&&!j.current&&ne("navigation"),le.current=n,Z.current=crypto.randomUUID(),A.current=Date.now(),Y.current=!1,w.current=null,z.current=null,$.current=0,E.current=!1,we.current=null,ee.current=0,me.current=0,j.current=!1,m.current!==null&&(window.clearInterval(m.current),m.current=null),h.current!==null&&(window.clearInterval(h.current),h.current=null),u(!0),y(!1),be(Re),ie(null),K(!1),X(!1),R(0),O.current=null,ue.current=null)},[n,ne]),r.useEffect(()=>{if(!b){R(0),O.current=null,$.current=0,m.current!==null&&(window.clearInterval(m.current),m.current=null);return}const e=Ve(b),t=Date.now()+e*1e3;if(O.current=t,R(e),z.current=Date.now(),e===0)return;const s=window.setInterval(()=>{if(!O.current)return;const c=O.current-Date.now(),o=Math.max(0,Math.ceil(c/1e3));R(o),o<=0&&window.clearInterval(s)},500);return()=>window.clearInterval(s)},[b]),r.useEffect(()=>{if(!(!b||G||!l)&&m.current===null)return m.current=window.setInterval(()=>{!b||G||($.current+=Math.round(ke/1e3),f("read_progress",{read_seconds_total:$.current}))},ke),()=>{m.current!==null&&(window.clearInterval(m.current),m.current=null)}},[b,G,f,l]),r.useEffect(()=>{if(!i||!n)return;let e=null;const t=()=>{const o=e?e.duration:null;be(Xe(o))},s=()=>{const o=document.querySelector("video");if(!o){t();return}e&&e!==o&&(e.removeEventListener("loadedmetadata",t),e.removeEventListener("durationchange",t)),e=o,t(),e.addEventListener("loadedmetadata",t),e.addEventListener("durationchange",t)};s();const c=new MutationObserver(s);return c.observe(document.body,{childList:!0,subtree:!0}),()=>{c.disconnect(),e&&(e.removeEventListener("loadedmetadata",t),e.removeEventListener("durationchange",t))}},[i,n]);const N=r.useCallback(async()=>{if(!l)return!1;const e=await ge();if(e.ok&&e.data)return H(e.data),!0;const t=await x(`${ye}/state`,{headers:{Authorization:`Bearer ${l.access_token}`}});if(!t.ok||!t.body)return!1;const s=t.body;return H({level:s.level,readScore:s.readScore,watchBalanceMinutes:s.watchBalanceMinutes}),!0},[l,ge,x]);r.useEffect(()=>{de.current=N},[N]);const xe=r.useCallback(async(e,t)=>{var d;if(!S)return{ok:!1,error:"Supabase client not configured."};const s=(d=l==null?void 0:l.user)==null?void 0:d.id;if(!s)return{ok:!1,error:"Supabase session unavailable."};let c=0,o=0;switch(e){case"read_completed":c+=typeof(t==null?void 0:t.score)=="number"?t.score:Ae,o+=typeof(t==null?void 0:t.minutes)=="number"?t.minutes:Oe;break;case"watch_initiated":{const _=typeof(t==null?void 0:t.minutes)=="number"?t.minutes:Re;o-=_;const U=typeof(t==null?void 0:t.score)=="number"?t.score:0;c-=U;break}case"session_end":{const _=await k();if(!_.ok||!_.data)return{ok:!1,error:_.error||"Unable to load state."};_.data.watch_balance_minutes<0&&(c-=$e);break}default:return{ok:!0,data:null}}c=Ce(c),o=Ce(o);const g=await k();if(!g.ok||!g.data)return{ok:!1,error:g.error||"Unable to load state."};const L=g.data.read_score+c,F=g.data.watch_balance_minutes+o,{error:q}=await S.from("user_state").update({read_score:L,watch_balance_minutes:F,updated_at:new Date().toISOString()}).eq("user_id",s);return q?{ok:!1,error:q.message}:{ok:!0,data:{level:Le(L),readScore:L,watchBalanceMinutes:F}}},[l,k,S]),J=r.useCallback(async(e,t)=>{if(!l)return null;f(e,t);const s=await x(`${ye}/event`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l.access_token}`},body:JSON.stringify({type:e,data:t})});if(s.ok&&s.body)return s.body;const c=await xe(e,t);return c.ok?c.data??null:(console.warn("[Intent] Failed to persist event",{type:e,apiError:s.ok?null:s.error||s.status,supabaseError:c.error}),null)},[l,xe,x,f]);r.useEffect(()=>{if(!S)return;S.auth.getSession().then(({data:s})=>P(s.session));const{data:e}=S.auth.onAuthStateChange((s,c)=>{P(c),c&&C(!1)}),t=s=>{(s==null?void 0:s.type)==="auth_complete"&&(S.auth.getSession().then(({data:c})=>{P(c.session),c.session&&de.current()}),C(!1)),(s==null?void 0:s.type)==="auth_signed_out"&&(P(null),C(!1),u(!0),y(!1))};return chrome.runtime.onMessage.addListener(t),()=>{e.subscription.unsubscribe(),chrome.runtime.onMessage.removeListener(t)}},[S]),r.useEffect(()=>{l||(H(null),ie(null),K(!1),X(!1),R(0),O.current=null)},[l]),r.useEffect(()=>{T(S?null:"Missing Supabase configuration.")},[]),r.useEffect(()=>{if(!n||!l)return;let e=0,t=null,s=!1;const c=async()=>{e+=1,!await N()&&!s&&e<3&&(t=window.setTimeout(c,1e3))};return c(),J("video_opened",{videoId:n}),()=>{s=!0,t!==null&&window.clearTimeout(t)}},[n,l,N,J]),r.useEffect(()=>{if(!n||!i||!l||!ce||ue.current===n)return;ue.current=n,(async()=>{var s,c,o;const t=await x(`${ye}/transcript`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({videoId:n})});if(t.ok&&((s=t.body)!=null&&s.transcript)){const g=t.body.source?` (${t.body.source})`:"",L=`https://www.youtube.com/watch?v=${n}`,F=((o=(c=document.querySelector("h1 yt-formatted-string"))==null?void 0:c.textContent)==null?void 0:o.trim())||document.title.replace(/\s+-\s+YouTube$/i,"").trim()||"Unknown",q=document.querySelector("video"),d=q&&Number.isFinite(q.duration)?Ye(q.duration):"Unknown";console.log(`[Intent]
URL: ${L}
LENGTH: ${d}
TITLE: ${F}
TRANSCRIPT:${g}
${t.body.transcript}`)}else console.warn(`[Intent] Transcript unavailable for ${n}.`)})()},[n,i,l,ce,x]),r.useEffect(()=>{i&&I(e=>(e+1)%he.length)},[i,he.length]),r.useEffect(()=>{i&&Se()},[i,Se]),r.useEffect(()=>{if(!i)return;let e=null;const t=()=>{e==null||e.pause()},s=()=>{const o=document.querySelector("video");if(!o){Ge();return}e&&e!==o&&(e.removeEventListener("play",t),e.removeEventListener("playing",t)),e=o,e.autoplay=!1,e.addEventListener("play",t),e.addEventListener("playing",t),e.pause()};s();const c=new MutationObserver(s);return c.observe(document.body,{childList:!0,subtree:!0}),()=>{c.disconnect(),e&&(e.removeEventListener("play",t),e.removeEventListener("playing",t))}},[i,n]),r.useEffect(()=>{if(i||!E.current||!n)return;let e=document.querySelector("video"),t=!1;const s=()=>{(!e||!document.contains(e))&&(e=document.querySelector("video"))},c=()=>{if(t||(s(),!e||!Number.isFinite(e.currentTime)))return;const L=Math.max(0,e.currentTime),F=L-ee.current;F>=1&&(ee.current=L,me.current+=1,f("watch_progress",{watch_seconds_total:Math.round(L),watch_seconds_delta:Math.round(F),sample_index:me.current}))},o=()=>{ne("video_end"),E.current=!1,h.current!==null&&(window.clearInterval(h.current),h.current=null),t=!0},g=()=>{e!=null&&e.ended||(ne("paused"),E.current=!1,h.current!==null&&(window.clearInterval(h.current),h.current=null),t=!0)};return s(),e&&(ee.current=Math.max(0,e.currentTime||0),e.addEventListener("ended",o),e.addEventListener("pause",g)),h.current=window.setInterval(c,qe),()=>{t=!0,h.current!==null&&(window.clearInterval(h.current),h.current=null),e&&(e.removeEventListener("ended",o),e.removeEventListener("pause",g))}},[i,n,f,ne]);const fe=r.useCallback(async()=>{if(!l)return;u(!1),y(!1);const e=await J("watch_initiated",{minutes:D,videoId:n,score:oe,time_since_open_ms:Math.max(0,Date.now()-A.current)});E.current=!0,we.current=Date.now(),j.current=!1,e?H({level:e.level,readScore:e.readScore,watchBalanceMinutes:e.watchBalanceMinutes}):await N()},[J,n,l,N,D,oe]),Ne=r.useCallback(async()=>{var c,o;if(!l)return;y(!0),ie(null),K(!1),X(!1);const e=ze(),t=Je();f("summary_requested",{videoId:n,title:e,durationSeconds:t,time_since_open_ms:Math.max(0,Date.now()-A.current)}),w.current=Date.now();const s=await x(`${ye}/summarize`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({videoId:n,title:e,durationSeconds:t})});s.ok&&((c=s.body)!=null&&c.summary)?(ie(s.body),z.current=Date.now(),f("summary_generated",{videoId:n,latency_ms:w.current?Math.max(0,Date.now()-w.current):null,readingTimeMinutes:s.body.readingTimeMinutes,summaryLength:s.body.summary.length,keyPointCount:((o=s.body.keyPoints)==null?void 0:o.length)??0,source:s.body.source,language:s.body.language})):(f("summary_failed",{videoId:n,latency_ms:w.current?Math.max(0,Date.now()-w.current):null,status:s.status,error:s.error}),console.warn("[Intent] Summary unavailable",{videoId:n,status:s.status,error:s.error,body:s.body})),y(!1)},[n,l,x,f]),_e=r.useCallback(async()=>{if(!l||!b||ae||G||se>0)return;X(!0);const e=z.current?Math.max(0,Date.now()-z.current):null,t=await J("read_completed",{videoId:n,minutes:B,score:te,read_time_ms:e});t?H({level:t.level,readScore:t.readScore,watchBalanceMinutes:t.watchBalanceMinutes}):await N(),K(!0),X(!1),window.location.assign("https://www.youtube.com/")},[l,b,ae,G,se,J,n,B,te,N]),ve=r.useCallback(async()=>{var c;if(!S){T("Missing Supabase configuration.");return}C(!0);const e=(c=chrome.runtime)==null?void 0:c.getURL("auth.html"),{data:t,error:s}=await S.auth.signInWithOAuth({provider:"google",options:e?{redirectTo:e,skipBrowserRedirect:!0}:{skipBrowserRedirect:!0}});if(s||!(t!=null&&t.url)){T((s==null?void 0:s.message)||"Failed to start sign-in."),C(!1);return}try{chrome.runtime.sendMessage({type:"oauth_start",url:t.url},o=>{if(chrome.runtime.lastError){T(chrome.runtime.lastError.message),C(!1);return}o!=null&&o.ok||(T((o==null?void 0:o.error)||"OAuth failed."),C(!1))})}catch(o){T(o instanceof Error?o.message:"Extension runtime unavailable."),C(!1)}},[S]);return n?a.jsx(De,{isVisible:i,isLoading:v,isAuthenticated:!!l,authError:p,authInProgress:pe,metrics:ce,watchCostMinutes:D,readGainMinutes:B,readScoreGain:te,watchScorePenalty:oe,summary:b,isClaimingRewards:ae,hasClaimedRewards:G,claimSecondsRemaining:se,claimCountdownLabel:He(se),quote:he[M],onLogin:ve,onReadFirst:Ne,onWatchNow:fe,onClaimRewards:_e}):null}function et(){if(document.getElementById(je))return;const n=document.createElement("div");n.id=je,document.body.appendChild(n),Be(n).render(a.jsx(Pe.StrictMode,{children:a.jsx(Ze,{})}))}et();
