import{r as n,j as e,c as ee,R as te}from"./client-DMp2t5-j.js";import{s as p}from"./supabaseClient-CWLpkwh3.js";const V=40,ne=5,$=10,G=10;function ae({isVisible:a,isLoading:c,metrics:o,quote:E,isAuthenticated:h,authError:k,authInProgress:M,onLogin:N,onReadFirst:b,onWatchNow:O}){if(!a)return null;const[v,L]=n.useState(0),[B,u]=n.useState(0),[S,F]=n.useState({left:0,width:0}),g=n.useRef(null),f=n.useRef(null),m=n.useRef(!1),l=n.useRef(null),P=n.useRef(0),A=n.useRef(null),I=n.useRef(null),t=5e3,r=120,s=140,i=n.useCallback(()=>{f.current!==null&&(cancelAnimationFrame(f.current),f.current=null),l.current!==null&&(cancelAnimationFrame(l.current),l.current=null),g.current=null,m.current=!1;const y=P.current;if(y<=0){L(0);return}const w=performance.now(),j=x=>{const _=x-w,R=Math.min(_/s,1),T=y*(1-R);if(L(T),R>=1){l.current=null;return}l.current=requestAnimationFrame(j)};l.current=requestAnimationFrame(j)},[]),d=n.useCallback(()=>{const y=performance.now();g.current=y,m.current=!1,l.current!==null&&(cancelAnimationFrame(l.current),l.current=null),L(0);const w=j=>{if(g.current===null)return;const x=j-g.current;let _=0;if(x<=r)_=x/r*.1;else{const R=x-r,T=t-r;_=.1+Math.min(R/T,1)*.9}if(L(_),_>=1&&!m.current){m.current=!0,O(),i();return}f.current=requestAnimationFrame(w)};f.current=requestAnimationFrame(w)},[O,i]);n.useEffect(()=>{P.current=v},[v]),n.useEffect(()=>{a||i()},[a,i]),n.useLayoutEffect(()=>{if(!h)return;const y=()=>{const j=A.current,x=I.current;if(!j||!x)return;const _=j.getBoundingClientRect(),R=x.getBoundingClientRect();u(_.width),F({left:Math.max(0,R.left-_.left),width:R.width})};y();const w=new ResizeObserver(y);return A.current&&w.observe(A.current),I.current&&w.observe(I.current),window.addEventListener("resize",y),()=>{w.disconnect(),window.removeEventListener("resize",y)}},[h]);const W=Math.floor(o.readScore/400)+1,q=Math.floor((o.readScore+V)/400)+1,C=o.watchBalanceMinutes-$,Y=C<0?o.readScore-G:o.readScore,D=Math.floor(Y/400)+1,J=q>W?"↑":"=",Q=C>=0?`${C} min`:`-${Math.abs(C)} min`,X=B*v,K=Math.max(0,Math.min(S.width,X-S.left)),Z=Math.max(0,K);return e.jsx("div",{className:"intent-overlay",children:e.jsxs("div",{className:"intent-overlay__panel",children:[e.jsx("div",{className:"intent-overlay__title",children:"Read First"}),e.jsx("div",{className:"intent-overlay__subtitle",children:E}),h?e.jsxs("div",{className:"intent-overlay__metrics",children:[e.jsxs("div",{className:"intent-overlay__metric",children:[e.jsx("span",{className:"intent-overlay__metric-label",children:"Level"}),e.jsx("span",{className:"intent-overlay__metric-value",children:W})]}),e.jsxs("div",{className:"intent-overlay__metric",children:[e.jsx("span",{className:"intent-overlay__metric-label",children:"Read Score"}),e.jsx("span",{className:"intent-overlay__metric-value",children:o.readScore})]}),e.jsxs("div",{className:"intent-overlay__metric",children:[e.jsx("span",{className:"intent-overlay__metric-label",children:"Watch Balance"}),e.jsxs("span",{className:"intent-overlay__metric-value",children:[o.watchBalanceMinutes," min"]})]})]}):e.jsxs("div",{className:"intent-overlay__auth",children:[e.jsx("div",{className:"intent-overlay__auth-title",children:"Sign in to continue"}),e.jsx("div",{className:"intent-overlay__auth-copy",children:"Your score and balance sync to your account. Sign in to proceed."}),e.jsx("button",{className:"intent-overlay__auth-button",type:"button",onClick:N,disabled:M,children:M?"Authenticating…":"Sign in with Google"})]}),h?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"intent-overlay__choice",children:[e.jsx("div",{className:"intent-overlay__choice-title",children:"Your Choice"}),e.jsxs("div",{className:"intent-overlay__choice-grid",children:[e.jsxs("div",{className:"intent-overlay__choice-card",children:[e.jsx("div",{className:"intent-overlay__choice-header",children:"Read Instead"}),e.jsxs("div",{className:"intent-overlay__choice-chips",children:[e.jsxs("span",{className:"intent-overlay__chip",children:["Score +",V]}),e.jsxs("span",{className:"intent-overlay__chip",children:["Watch Balance +",ne,"m"]}),e.jsxs("span",{className:"intent-overlay__chip",children:["Level ",q," ",J]})]}),e.jsx("div",{className:"intent-overlay__choice-note",children:"Reading restores progress."})]}),e.jsxs("div",{className:"intent-overlay__choice-card intent-overlay__choice-card--watch",children:[e.jsx("div",{className:"intent-overlay__choice-header",children:"Watch Now"}),e.jsxs("div",{className:"intent-overlay__choice-chips",children:[e.jsxs("span",{className:"intent-overlay__chip intent-overlay__chip--warn",children:["Watch Balance -",$,"m"]}),e.jsxs("span",{className:"intent-overlay__chip",children:["New Watch Balance ",Q]})]}),C<0?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"intent-overlay__choice-subline",children:["Score penalty -",G," (attention debt)"]}),e.jsx("div",{className:"intent-overlay__choice-subline",children:"Level progress paused while negative"}),D<W?e.jsxs("div",{className:"intent-overlay__choice-warning",children:["⚠️ Risk: Level down to ",D]}):null]}):e.jsx("div",{className:"intent-overlay__choice-subline",children:"No score penalty (balance stays non-negative)"})]})]})]}),e.jsxs("div",{className:"intent-overlay__actions",children:[e.jsx("button",{className:"intent-overlay__primary",type:"button",onClick:b,disabled:c,children:c?"Generating summary…":"Read Instead"}),e.jsxs("button",{className:"intent-overlay__secondary",type:"button",onPointerDown:d,onPointerUp:i,onPointerLeave:i,onPointerCancel:i,ref:A,children:[e.jsx("span",{className:"intent-overlay__hold-fill",style:{transform:`scaleX(${v})`}}),e.jsxs("span",{className:"intent-overlay__button-label intent-overlay__button-label--progress",children:[e.jsx("span",{ref:I,className:"intent-overlay__button-label-base",children:"Watch Now"}),e.jsx("span",{className:"intent-overlay__button-label-fill",style:{"--label-fill-px":`${Z}px`},children:"Watch Now"})]})]})]}),c?e.jsx("div",{className:"intent-overlay__loading",children:"Preparing a focused summary and key points…"}):null]}):null]})})}const U="intent-read-first-root",H="http://localhost:8787";function z(a){try{const c=new URL(a);return c.pathname!=="/watch"?null:c.searchParams.get("v")}catch{return null}}function re(){var o;const a=document.querySelector("video");if(a&&!a.paused&&a.pause(),a){a.autoplay=!1;return}const c=document.querySelector(".ytp-play-button");c&&((o=c.getAttribute("aria-label"))!=null&&o.toLowerCase().includes("pause"))&&c.click()}function se(){const[a,c]=n.useState(()=>z(window.location.href));return n.useEffect(()=>{const o=()=>c(z(window.location.href)),E=history.pushState,h=history.replaceState;history.pushState=function(...N){E.apply(this,N),o()},history.replaceState=function(...N){h.apply(this,N),o()},window.addEventListener("popstate",o);const k=new MutationObserver(o);k.observe(document.body,{childList:!0,subtree:!0});const M=window.setInterval(o,1e3);return()=>{history.pushState=E,history.replaceState=h,window.removeEventListener("popstate",o),k.disconnect(),window.clearInterval(M)}},[]),a}function ie(){const a=se(),[c,o]=n.useState(!0),[E,h]=n.useState(!1),[k,M]=n.useState(0),[N,b]=n.useState(null),[O,v]=n.useState(!1),[L,B]=n.useState({level:1,readScore:0,watchBalanceMinutes:0}),[u,S]=n.useState(null),F=n.useRef(a),g=n.useMemo(()=>["It is not enough to be busy; so are the ants. The question is: What are we busy about? — Henry David Thoreau","The successful warrior is the average man, with laser-like focus. — Bruce Lee","Concentrate all your thoughts upon the work in hand. — Alexander Graham Bell","Simplicity is the ultimate sophistication. — Leonardo da Vinci","A well-spent day brings happy sleep. — Leonardo da Vinci","Your focus determines your reality. — George Lucas"],[]),f=n.useCallback(async(t,r)=>new Promise(s=>{var i;if(!((i=chrome==null?void 0:chrome.runtime)!=null&&i.sendMessage)){s({ok:!1,error:"Extension runtime unavailable."});return}chrome.runtime.sendMessage({type:"api_request",url:t,init:r},d=>{if(chrome.runtime.lastError){s({ok:!1,error:chrome.runtime.lastError.message});return}s(d)})}),[]);n.useEffect(()=>{a&&a!==F.current&&(F.current=a,o(!0),h(!1))},[a]);const m=n.useCallback(async()=>{if(!u)return;const t=await f(`${H}/state`,{headers:{Authorization:`Bearer ${u.access_token}`}});if(!t.ok||!t.body)return;const r=t.body;B({level:r.level,readScore:r.readScore,watchBalanceMinutes:r.watchBalanceMinutes})},[u,f]),l=n.useCallback(async(t,r)=>{if(!u)return null;const s=await f(`${H}/event`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${u.access_token}`},body:JSON.stringify({type:t,data:r})});return s.ok?s.body??null:null},[u,f]);n.useEffect(()=>{if(!p)return;p.auth.getSession().then(({data:s})=>S(s.session));const{data:t}=p.auth.onAuthStateChange((s,i)=>{S(i),i&&v(!1)}),r=s=>{(s==null?void 0:s.type)==="auth_complete"&&(p.auth.getSession().then(({data:i})=>{S(i.session),i.session&&m()}),v(!1)),(s==null?void 0:s.type)==="auth_signed_out"&&(S(null),v(!1),o(!0),h(!1))};return chrome.runtime.onMessage.addListener(r),()=>{t.subscription.unsubscribe(),chrome.runtime.onMessage.removeListener(r)}},[p,m]),n.useEffect(()=>{b(p?null:"Missing Supabase configuration.")},[]),n.useEffect(()=>{!a||!u||(m(),l("video_opened",{videoId:a}))},[a,u,m,l]),n.useEffect(()=>{c&&M(t=>(t+1)%g.length)},[c,g.length]),n.useEffect(()=>{if(!c)return;let t=null;const r=()=>{t==null||t.pause()},s=()=>{const d=document.querySelector("video");if(!d){re();return}t&&t!==d&&(t.removeEventListener("play",r),t.removeEventListener("playing",r)),t=d,t.autoplay=!1,t.addEventListener("play",r),t.addEventListener("playing",r),t.pause()};s();const i=new MutationObserver(s);return i.observe(document.body,{childList:!0,subtree:!0}),()=>{i.disconnect(),t&&(t.removeEventListener("play",r),t.removeEventListener("playing",r))}},[c,a]);const P=n.useCallback(async()=>{if(!u)return;o(!1),h(!1);const t=await l("watch_initiated",{minutes:10,videoId:a});t&&B({level:t.level,readScore:t.readScore,watchBalanceMinutes:t.watchBalanceMinutes})},[l,a,u]),A=n.useCallback(async()=>{if(!u)return;h(!0);const t=await l("read_completed",{videoId:a});t&&B({level:t.level,readScore:t.readScore,watchBalanceMinutes:t.watchBalanceMinutes})},[l,a,u]),I=n.useCallback(async()=>{var i;if(!p){b("Missing Supabase configuration.");return}v(!0);const t=(i=chrome.runtime)==null?void 0:i.getURL("auth.html"),{data:r,error:s}=await p.auth.signInWithOAuth({provider:"google",options:t?{redirectTo:t,skipBrowserRedirect:!0}:{skipBrowserRedirect:!0}});if(s||!(r!=null&&r.url)){b((s==null?void 0:s.message)||"Failed to start sign-in."),v(!1);return}chrome.runtime.sendMessage({type:"oauth_start",url:r.url},d=>{if(chrome.runtime.lastError){b(chrome.runtime.lastError.message),v(!1);return}d!=null&&d.ok||(b((d==null?void 0:d.error)||"OAuth failed."),v(!1))})},[p]);return a?e.jsx(ae,{isVisible:c,isLoading:E,isAuthenticated:!!u,authError:N,authInProgress:O,metrics:L,quote:g[k],onLogin:I,onReadFirst:A,onWatchNow:P}):null}function oe(){if(document.getElementById(U))return;const a=document.createElement("div");a.id=U,document.body.appendChild(a),ee(a).render(e.jsx(te.StrictMode,{children:e.jsx(ie,{})}))}oe();
